<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG</title>
    <!-- æ·»åŠ Material Iconsåº“ -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- æ·»åŠ marked.jsåº“ç”¨äºMarkdownè§£æ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        body {
            display: flex;
            height: 100vh;
            overflow: hidden;
            background-color: #f7f7f8;
        }

        /* å·¦ä¾§è¾¹æ  */
        .sidebar {
            width: 260px;
            background-color: #202123;
            color: white;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            overflow: hidden;
            z-index: 10;
        }

        .sidebar.collapsed {
            width: 0;
        }

        .sidebar-toggle {
            position: absolute;
            top: 12px;
            left: 270px;
            z-index: 100;
            background: #444654;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: left 0.3s ease;
        }

        .sidebar-toggle.collapsed {
            left: 10px;
        }

        .tools-section {
            padding: 16px;
            border-bottom: 1px solid #444654;
        }

        .tools-section h3 {
            font-size: 14px;
            margin-bottom: 12px;
            color: #ececf1;
        }

        .tools-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .tool-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tool-item:hover {
            background-color: #343541;
        }

        .tool-item.active {
            background-color: #343541;
        }

        .tool-icon {
            width: 16px;
            height: 16px;
        }

        /* æ–°å»ºå¯¹è¯æŒ‰é’® */
        .new-chat-btn {
            margin-top: 12px;
            padding: 8px 12px;
            border-radius: 6px;
            background-color: #10a37f;
            color: white;
            font-size: 14px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .new-chat-btn:hover {
            background-color: #0d8c6d;
            transform: translateY(-1px);
        }

        /* å†å²è®°å½•éƒ¨åˆ† */
        .history-section {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .history-section h3 {
            font-size: 14px;
            margin-bottom: 12px;
            color: #ececf1;
        }

        .time-group {
            margin-bottom: 16px;
        }

        .time-label {
            font-size: 12px;
            color: #8e8ea0;
            margin-bottom: 8px;
        }

        .chat-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-item:hover {
            background-color: #343541;
        }

        .chat-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .delete-chat {
            opacity: 0;
            transition: opacity 0.2s ease;
            color: #8e8ea0;
        }

        .chat-item:hover .delete-chat {
            opacity: 1;
        }

        /* ä¸»èŠå¤©åŒºåŸŸ */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            transition: width 0.3s ease;
            position: relative;
            max-width: 100%;
        }

        .search-active .chat-container {
            max-width: 50%;
        }

        .chat-header {
            padding: 12px 20px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            align-items: center;
            background-color: #ffffff;
            z-index: 5;
        }

        .chat-header h2 {
            font-size: 16px;
            font-weight: 500;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            display: flex;
            padding: 10px 20px;
            border-radius: 8px;
            animation: fadeIn 0.3s ease-out;
            margin-bottom: 10px;
            align-items: flex-start;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background-color: #f7f7f8;
            align-self: flex-end;
            max-width: 85%;
            border-radius: 18px 18px 4px 18px;
        }

        .message.assistant {
            background-color: #f0f7ff;
            align-self: flex-start;
            max-width: 85%;
            border-radius: 18px 18px 18px 4px;
        }

        /* æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯æ ·å¼ */
        .message.system {
            background-color: #fffbe6;
            align-self: center;
            max-width: 80%;
            border-radius: 18px;
            padding: 8px 15px;
            color: #555;
            font-style: italic;
            border: 1px dashed #d9d9d9;
            margin: 10px 0;
            text-align: center;
        }
        
        /* æ·»åŠ ç³»ç»Ÿé”™è¯¯æ¶ˆæ¯æ ·å¼ */
        .message.system.error {
            background-color: #fff1f0;
            border: 1px dashed #ffccc7;
            color: #cf1322;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
            margin-right: 10px;
        }

        .user .avatar {
            background-color: #6e8efb;
        }

        .assistant .avatar {
            background-color: #10a37f;
        }

        .message-content {
            flex: 1;
            line-height: 1.5;
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .message-content pre {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            overflow: auto;
            margin: 10px 0;
        }

        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 10px 0;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #10a37f;
            border-radius: 50%;
            animation: bounce 1.5s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        .chat-input-container {
            padding: 16px 20px;
            border-top: 1px solid #e5e5e5;
            position: relative;
            z-index: 5;
            background: #ffffff;
        }

        .chat-input-wrapper {
            border: 1px solid #e5e5e5;
            border-radius: 24px;
            display: flex;
            padding: 8px 16px;
            background-color: #ffffff;
            position: relative;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            transition: box-shadow 0.3s ease;
        }

        .chat-input-wrapper:focus-within {
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            border-color: #10a37f;
        }

        .chat-input {
            flex: 1;
            border: none;
            outline: none;
            resize: none;
            min-height: 24px;
            max-height: 200px;
            padding: 8px 0;
            line-height: 1.4;
            font-size: 16px;
        }

        .send-button {
            background-color: #10a37f;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            align-self: flex-end;
            transition: transform 0.2s ease;
        }

        .send-button:hover {
            background-color: #0d8c6d;
            transform: scale(1.05);
        }
        
        .send-button.sending {
            animation: pulse 1.5s infinite;
            background-color: #ff4d4f;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* ç”Ÿæˆåœæ­¢æç¤º */
        .generation-stopped {
            margin-top: 8px;
            color: #ff4d4f;
            font-style: italic;
            font-size: 0.9em;
        }

        /* å³ä¾§æœç´¢ç»“æœé¢æ¿ */
        .search-results {
            width: 0;
            background-color: #ffffff;
            border-left: 1px solid #e5e5e5;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            overflow: hidden;
            z-index: 5;
        }

        #search-panel {
            width: 0;
            background-color: #ffffff;
            border-left: 1px solid #e5e5e5;
            display: none;
            flex-direction: column;
            transition: width 0.3s ease;
            overflow: hidden;
            position: relative;
        }

        #search-panel.visible {
            display: flex;
            width: 50%;
            flex: 0 0 50%;
        }

        body.search-active {
            display: flex;
            justify-content: space-between;
        }

        .search-result-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            background-color: #f9f9f9;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .search-result-item:hover {
            background-color: #f0f7ff;
            border-color: #c2dbff;
        }
        
        .search-result-item.selected {
            background-color: #e8f2ff;
            border-color: #a9d3ff;
        }
        
        /* å¤é€‰æ¡†å®¹å™¨æ ·å¼ */
        .search-result-checkbox-container {
            flex: 0 0 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 24px;
        }
        
        /* å¤é€‰æ¡†æ ·å¼ */
        .search-result-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* å†…å®¹å®¹å™¨æ ·å¼ */
        .search-result-content-container {
            flex: 1;
            min-width: 0; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }
        
        .search-result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .search-result-item.selected {
            border-color: #10a37f;
            background-color: #f0f9f4;
        }
        
        .search-result-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .search-result-title {
            font-weight: 600;
            color: #1a73e8;
            font-size: 16px;
            line-height: 1.3;
        }
        
        .search-result-score {
            color: #5f6368;
            font-size: 0.85em;
            font-weight: 500;
            padding: 2px 8px;
            background-color: #f1f3f4;
            border-radius: 12px;
        }
        
        .search-result-content {
            font-size: 0.95em;
            line-height: 1.5;
            color: #202124;
            max-height: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
        }
        
        .search-result-content::after {
            content: "";
            position: absolute;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 20px;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,1));
        }
        
        .result-count {
            font-size: 14px;
            color: #5f6368;
            margin-bottom: 15px;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .loading-results {
            padding: 20px;
            text-align: center;
            color: #5f6368;
            font-style: italic;
        }
        
        .error-results {
            padding: 20px;
            text-align: center;
            color: #d93025;
            background-color: #fce8e6;
            border-radius: 4px;
        }
        
        .no-results {
            padding: 30px;
            text-align: center;
            color: #5f6368;
            font-style: italic;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }

        .search-active .search-results {
            width: 50%;
        }

        .search-header {
            padding: 12px 20px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .search-header h2 {
            font-size: 16px;
            font-weight: 500;
        }

        .close-search {
            background: none;
            border: none;
            cursor: pointer;
            color: #555;
            font-size: 20px;
            transition: transform 0.2s ease;
        }
        
        .close-search:hover {
            transform: scale(1.1);
            color: #10a37f;
        }

        /* å³ä¾§æœç´¢ç»“æœé¢æ¿çš„ç­›é€‰åŒºåŸŸ */
        .filter-section {
            padding: 12px 20px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-dropdown {
            flex: 1;
            min-width: 120px;
            padding: 8px 12px;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            background-color: #ffffff;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }
        
        .filter-dropdown:focus {
            border-color: #10a37f;
            outline: none;
        }

        .search-items {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .selection-actions {
            padding: 12px 20px;
            border-top: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
        }

        .selection-count {
            font-size: 14px;
            color: #555;
        }

        .add-selected {
            background-color: #10a37f;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .add-selected:hover {
            background-color: #0d8c6d;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .add-selected:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        /* PDFä¸Šä¼ ç›¸å…³æ ·å¼ */
        .pdf-upload-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
            height: 100%;
            background-color: #f9f9f9;
        }
        
        .pdf-upload-container.active {
            display: flex;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 20px;
            color: #10a37f;
        }
        
        .upload-title {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .upload-description {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
            max-width: 500px;
        }
        
        .file-input-wrapper {
            position: relative;
            margin-bottom: 20px;
        }
        
        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-button {
            padding: 10px 20px;
            background-color: #10a37f;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        
        .file-input-button:hover {
            background-color: #0d8c6d;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .selected-file {
            margin-top: 15px;
            padding: 10px;
            background: #e6f7f1;
            border-radius: 8px;
            display: none;
            align-items: center;
            gap: 10px;
        }
        
        .selected-file.active {
            display: flex;
        }
        
        .file-name {
            font-weight: 500;
            color: #10a37f;
        }
        
        .remove-file {
            color: #ff4d4f;
            cursor: pointer;
            font-weight: bold;
        }
        
        .process-pdf-button {
            padding: 10px 24px;
            background-color: #10a37f;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 20px;
            display: none;
            transition: all 0.2s ease;
        }
        
        .process-pdf-button.active {
            display: block;
        }
        
        .process-pdf-button:hover {
            background-color: #0d8c6d;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* APIé€šçŸ¥æ ·å¼ */
        .api-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slide-in 0.5s ease;
            max-width: 350px;
        }
        
        .api-notification.fade-out {
            animation: slide-out 0.5s ease;
        }
        
        .api-notification-content {
            display: flex;
            align-items: center;
            padding: 12px 16px;
        }
        
        .api-notification.error .api-notification-content {
            background-color: #fef0f0;
            border-left: 4px solid #f56c6c;
        }
        
        .api-notification.restore .api-notification-content {
            background-color: #f0f9eb;
            border-left: 4px solid #67c23a;
        }
        
        .api-notification-icon {
            margin-right: 10px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .api-notification.error .api-notification-icon {
            color: #f56c6c;
        }
        
        .api-notification.restore .api-notification-icon {
            color: #67c23a;
        }
        
        .api-notification-message {
            flex: 1;
            font-size: 14px;
            color: #555;
        }
        
        .api-notification-close {
            margin-left: 10px;
            cursor: pointer;
            color: #909399;
            font-size: 18px;
        }
        
        .api-notification-close:hover {
            color: #606266;
        }
        
        @keyframes slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slide-out {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .offline-message {
            background-color: #fff8e1 !important;
            border-left: 4px solid #ffc107 !important;
        }

        .offline-message .message-content {
            color: #856404;
        }

        .error-status {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .success-status {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        /* æ–°å»ºå¯¹è¯è¾“å…¥æ¡†å±…ä¸­æ ·å¼ */
        .chat-messages.new-chat {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-input-container.centered {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 650px;
            z-index: 10;
            background: transparent;
            border: none;
            animation: fadeIn 0.5s ease-out;
        }

        .chat-input-container.centered .chat-input-wrapper {
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            border: 1px solid #10a37f;
            padding: 15px 20px;
        }

        .chat-input-container.centered .chat-input {
            font-size: 18px;
            min-height: 45px;
        }

        .centered-prompt {
            text-align: center;
            color: #666;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 500;
        }

        .search-result-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .search-result-title {
            font-weight: 500;
            color: #1a73e8;
        }

        .search-result-score {
            color: #5f6368;
            font-size: 0.85em;
        }
        
        .search-result-authors {
            font-size: 0.9em;
            color: #5f6368;
            margin-bottom: 5px;
            font-style: italic;
        }

        /* åœ¨body.search-activeä¸­æ·»åŠ æ‰€éœ€çš„æ ·å¼ */
        body.search-active {
            display: flex;
            justify-content: flex-start; /* ä»å·¦åˆ°å³æ’åˆ— */
        }

        /* æ·»åŠ æ”¯æŒä¾§è¾¹æ ä¸æœç´¢é¢æ¿å…±å­˜çš„æ ·å¼ */
        body.search-active .sidebar:not(.collapsed) {
            width: 260px;
            flex-shrink: 0; /* é˜²æ­¢ä¾§è¾¹æ è¢«å‹ç¼© */
        }

        /* èŠå¤©å®¹å™¨æ ·å¼ */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            transition: all 0.3s ease;
            position: relative;
            min-width: 0; /* å…è®¸å®¹å™¨æ”¶ç¼© */
        }

        body.search-active .chat-container {
            flex: 0 0 50%; /* æœç´¢æ¿€æ´»æ—¶å›ºå®šå®½åº¦ä¸º50% */
        }

        /* æœç´¢é¢æ¿æ ·å¼ */
        #search-panel {
            width: 0;
            background-color: #ffffff;
            border-left: 1px solid #e5e5e5;
            display: none;
            flex-direction: column;
            transition: all 0.3s ease;
            overflow: hidden;
            flex-shrink: 0;
        }

        #search-panel.visible {
            display: flex;
            width: 50%;
            flex: 0 0 50%;
        }

        /* æœç´¢é¡¹å®¹å™¨æ ·å¼ */
        .search-items {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* å½“ä¾§æ å±•å¼€ä¸”æœç´¢æ¿€æ´»æ—¶ï¼Œè°ƒæ•´èŠå¤©å®¹å™¨å®½åº¦ */
        body.search-active .sidebar:not(.collapsed) ~ .chat-container {
            flex: 0 0 calc(50% - 130px); /* å‡å»ä¾§æ çš„ä¸€åŠå®½åº¦ï¼Œé¿å…å®¹å™¨è¿‡çª„ */
        }
        
        /* å½“ä¾§æ å±•å¼€ä¸”æœç´¢æ¿€æ´»æ—¶ï¼Œè°ƒæ•´æœç´¢é¢æ¿å®½åº¦ */
        body.search-active .sidebar:not(.collapsed) ~ #search-panel.visible {
            flex: 0 0 calc(50% - 130px); /* ä¸èŠå¤©å®¹å™¨ä¿æŒä¸€è‡´ */
            width: calc(50% - 130px);
        }

        .no-results {
            padding: 30px;
            text-align: center;
            color: #5f6368;
            font-style: italic;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }

        .search-active .search-results {
            width: 50%;
        }

        .no-results {
            padding: 30px;
            text-align: center;
            color: #5f6368;
            font-style: italic;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .search-instruction {
            padding: 40px 20px;
            text-align: center;
            color: #5f6368;
            font-size: 16px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px dashed #d3d3d3;
        }

        .search-active .search-results {
            width: 50%;
        }

        /* æ·»åŠ æ¢å¤æ£€ç´¢ç»“æœçš„æŒ‰é’®æ ·å¼ */
        .restore-search-button {
            position: fixed;
            right: 20px;
            bottom: 80px;
            z-index: 100;
            padding: 8px 16px;
            background-color: #10a37f;
            color: white;
            border: none;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .restore-search-button:hover {
            background-color: #0d8c6d;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .restore-search-button .material-icons {
            font-size: 18px;
        }

        /* 1. é¦–å…ˆï¼Œæ·»åŠ PDFä¸Šä¼ æŒ‰é’®çš„æ ·å¼ */
        .chat-input-wrapper {
            position: relative;
            flex: 1;
            display: flex;
            align-items: center;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 10px 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            max-width: 800px;
            margin: 0 auto;
        }

        .chat-input-wrapper:focus-within {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-color: #aaaaaa;
        }

        /* æ·»åŠ PDFä¸Šä¼ æŒ‰é’®çš„æ ·å¼ */
        .pdf-upload-btn {
            background: none;
            border: none;
            cursor: pointer;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .pdf-upload-btn:hover {
            background-color: #f0f0f0;
        }

        .pdf-upload-btn span {
            font-size: 20px;
        }

        /* éšè—å®é™…çš„æ–‡ä»¶è¾“å…¥ */
        .pdf-upload-input {
            display: none;
        }

    
        /* 1. åœ¨CSSéƒ¨åˆ†æ·»åŠ å¤„ç†æ¶ˆæ¯çš„æ ·å¼ */
        .processing-message {
            background-color: #e6f3ff;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #0078d7;
            font-style: italic;
        }
        
        .error-message {
            background-color: #fde8e8;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #e53e3e;
            color: #c53030;
        }
        
        /* ç§»é™¤ pdf-upload-container çš„æ˜¾ç¤ºï¼Œä½†ä¿ç•™æ ·å¼ä¾›å°†æ¥å¯èƒ½ä½¿ç”¨ */
        .pdf-upload-container {
            display: none; /* é»˜è®¤éšè—ï¼Œä¸å†ä½œä¸ºå·¥å…·ä½¿ç”¨ */
        }
    </style>
</head>
<body>
    <!-- å·¦ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
        <div class="tools-section">
            <h3>Tools</h3>
            <div class="tools-list">
                <!-- å·¥å…·é¡¹å°†ç”±JavaScriptåŠ¨æ€æ·»åŠ  -->
                </div>
            <button class="new-chat-btn" onclick="createNewChat()">
                <span>New Chat</span>
            </button>
        </div>
        <div class="history-section">
            <h3>History</h3>
            <div class="time-group">
                <div class="time-label">Today</div>
                <div class="chat-item" onclick="loadChat('chat1')">
                    <div class="chat-title">Data Analysis Method Discussion</div>
                    <span class="delete-chat" onclick="deleteChat(event, 'chat1')">Ã—</span>
                </div>
                <div class="chat-item" onclick="loadChat('chat2')">
                    <div class="chat-title">Paper Structure Optimization</div>
                    <span class="delete-chat" onclick="deleteChat(event, 'chat2')">Ã—</span>
                </div>
            </div>
            <div class="time-group">
                <div class="time-label">Yesterday</div>
                <div class="chat-item" onclick="loadChat('chat3')">
                    <div class="chat-title">Writing Guide for Literature Review</div>
                    <span class="delete-chat" onclick="deleteChat(event, 'chat3')">Ã—</span>
                </div>
            </div>
            <div class="time-group">
                <div class="time-label">7 days ago</div>
                <div class="chat-item" onclick="loadChat('chat4')">
                    <div class="chat-title">Comparison of Research Methods</div>
                    <span class="delete-chat" onclick="deleteChat(event, 'chat4')">Ã—</span>
                </div>
                <div class="chat-item" onclick="loadChat('chat5')">
                    <div class="chat-title">Discussion on Experimental Design</div>
                    <span class="delete-chat" onclick="deleteChat(event, 'chat5')">Ã—</span>
                </div>
            </div>
        </div>
    </div>

    <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()">
        â˜°
    </button>

    <!-- ä¸»èŠå¤©åŒºåŸŸ -->
    <div class="chat-container" id="chat-container">
        <div class="chat-header">
            <h2>Smart Assistant</h2>
        </div>
        
        <!-- éšè—çš„PDFä¸Šä¼ å®¹å™¨ï¼Œä»…ç”¨äºæ˜¾ç¤ºå¤„ç†çŠ¶æ€ -->
        <div class="pdf-upload-container" id="pdf-upload-container">
            <div id="pdf-status" class="processing-status" style="display: none;"></div>
        </div>
        
        <div class="chat-messages" id="chat-messages">
            <!-- æ¬¢è¿æ¶ˆæ¯å°†ç”±JavaScriptåŠ¨æ€æ·»åŠ  -->
                </div>
        <div class="chat-input-container" id="chat-input-container">
            <div class="chat-input-wrapper">
                <button class="pdf-upload-btn" id="pdf-upload-btn" title="ä¸Šä¼ PDFæ–‡ä»¶">
                    <span>ğŸ“„</span>
                </button>
                <input type="file" class="pdf-upload-input" id="pdf-upload-input" accept=".pdf">
                <textarea class="chat-input" id="chat-input" placeholder="Send a message..." rows="1" oninput="autoResize(this)"></textarea>
                <button class="send-button" id="send-button" title="å‘é€æ¶ˆæ¯">â†’</button>
            </div>
        </div>
    </div>

    <!-- å³ä¾§æœç´¢ç»“æœé¢æ¿ -->
    <div id="search-panel">
        <div class="search-header">
            <h2>æ£€ç´¢ç»“æœ</h2>
            <button class="close-search" onclick="closeSearch()">Ã—</button>
        </div>
        <!-- åˆ é™¤ç­›é€‰åŒºåŸŸ -->
        <div id="search-results" class="search-items">
            <!-- æœç´¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
        <div class="selection-actions">
            <div class="selection-count" id="selection-count">å·²é€‰æ‹© 0 é¡¹</div>
            <button class="add-selected" id="add-selected" onclick="addSelectedToChat()" disabled>æ·»åŠ åˆ°å¯¹è¯</button>
        </div>
    </div>

    <script>
        // APIè·¯å¾„é…ç½®
        const API = {
            PROCESS: '/rag_mcp/process',
            SEARCH: '/rag_mcp/search',
            UPLOAD: '/rag_mcp/upload',
            TASK: '/rag_mcp/task',
            HISTORY: '/rag_mcp/history',
            TOOLS: '/rag_mcp/tools'
        };

        // å…¨å±€å˜é‡
        let isSearchActive = false;
        let selectedItems = new Set();
        let currentTool = 'chat';
        let selectedFile = null;
        let isAssistantTyping = false;
        let currentTaskId = null;
        let taskCheckInterval = null;
        let controller = null; // ç”¨äºä¸­æ–­è¯·æ±‚çš„AbortController
        let isPageLoad = true; // ç”¨äºæ ‡è®°é¡µé¢æ˜¯å¦åˆšåŠ è½½
        let apiAvailable = true; // æ ‡è®°APIæ˜¯å¦å¯ç”¨
        let apiCheckInterval = null; // APIå¥åº·æ£€æŸ¥å®šæ—¶å™¨
        let chatHistory = []; // åˆå§‹åŒ–èŠå¤©å†å²æ•°ç»„

        // ç«‹å³æ¸…é™¤æœ¬åœ°å­˜å‚¨ä¸­çš„æœç´¢ç»“æœï¼Œé˜²æ­¢æ˜¾ç¤ºé»˜è®¤æ£€ç´¢ç»“æœ
        localStorage.removeItem('rag_mcp_search_results');
        localStorage.removeItem('searchResults');
        localStorage.removeItem('searchActive');

        // å…¨å±€é”™è¯¯å¤„ç†
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('å…¨å±€é”™è¯¯:', message, source, lineno, colno);
            // ä¸è¦ä¸­æ–­æ­£å¸¸çš„é”™è¯¯å¤„ç†æµç¨‹
            return false;
        };

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // æ·»åŠ é”™è¯¯å¤„ç†ï¼Œç¡®ä¿é¡µé¢å§‹ç»ˆåŠ è½½
            window.addEventListener('error', function(e) {
                console.error('é¡µé¢é”™è¯¯:', e.message);
                // ä¸é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œä½†è®°å½•é”™è¯¯
            });

            // æ·»åŠ PDFæ–‡ä»¶è¾“å…¥å…ƒç´ æ£€æŸ¥å’Œæ—¥å¿—
            const pdfFileInput = document.getElementById('pdf-file-input');
            if (pdfFileInput) {
                console.log('PDFæ–‡ä»¶è¾“å…¥å…ƒç´ å·²æ‰¾åˆ°', pdfFileInput);
                
                // ç¡®ä¿äº‹ä»¶ç»‘å®šæ­£ç¡®ï¼Œæ·»åŠ é¢å¤–çš„äº‹ä»¶ç›‘å¬ä»¥ä¾¿è°ƒè¯•
                pdfFileInput.addEventListener('change', function() {
                    console.log('PDFæ–‡ä»¶è¾“å…¥å…ƒç´ çš„changeäº‹ä»¶è§¦å‘ - é€šè¿‡addEventListener');
                });
            } else {
                console.error('æ‰¾ä¸åˆ°PDFæ–‡ä»¶è¾“å…¥å…ƒç´  id="pdf-file-input"');
            }

            // ç«‹å³æ˜¾ç¤ºUIï¼Œä¸ç­‰å¾…API
            initializeUI();
            
            // å¯åŠ¨APIå¥åº·æ£€æŸ¥
            startApiHealthCheck();
            
            // å¼‚æ­¥åŠ è½½éå…³é”®æ•°æ®
            setTimeout(() => {
                safeLoadHistory();
                safeLoadTools();
                // ä¸å†å°è¯•æ¢å¤ä¸Šæ¬¡çš„æœç´¢ç»“æœ
            }, 500);

            // åœ¨DOMContentLoadedä¸­æ·»åŠ è¿‡æ»¤å™¨äº‹ä»¶ç›‘å¬
            // ç›‘å¬èŠå¤©è¾“å…¥æ¡†çš„å›è½¦é”®äº‹ä»¶
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            });
            }
            
            // æ·»åŠ è¿‡æ»¤å™¨äº‹ä»¶ç›‘å¬
            const fieldFilter = document.getElementById('field-filter');
            const sortOrder = document.getElementById('sort-order');
            
            if (fieldFilter) {
                fieldFilter.addEventListener('change', applyFilters);
            }
            
            if (sortOrder) {
                sortOrder.addEventListener('change', applyFilters);
            }

            // æ·»åŠ é¡µé¢å¸è½½äº‹ä»¶ç›‘å¬å™¨ï¼Œä¿å­˜å½“å‰çŠ¶æ€
            window.addEventListener('beforeunload', function() {
                saveCurrentState();
            });

            // è®¾ç½®PDFä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            const pdfUploadBtn = document.getElementById('pdf-upload-btn');
            const pdfUploadInput = document.getElementById('pdf-upload-input');
            
            if (pdfUploadBtn && pdfUploadInput) {
                pdfUploadBtn.addEventListener('click', function() {
                    pdfUploadInput.click();
                });
                
                pdfUploadInput.addEventListener('change', function() {
                    if (this.files && this.files.length > 0) {
                        handleFileSelect(this);
                    }
                });
            } else {
                console.error('æ‰¾ä¸åˆ°PDFä¸Šä¼ æŒ‰é’®æˆ–è¾“å…¥å…ƒç´ ');
            }
        });

        // ä¿å­˜å½“å‰çŠ¶æ€
        function saveCurrentState() {
            try {
                // ä¿å­˜æœç´¢çŠ¶æ€
                if (isSearchActive && document.getElementById('search-results').children.length > 0) {
                    localStorage.setItem('searchActive', 'true');
                } else {
                    localStorage.setItem('searchActive', 'false');
                }
                
                // ä¿å­˜å½“å‰å·¥å…·
                localStorage.setItem('currentTool', currentTool);
                
                // ä¿å­˜é€‰ä¸­çš„é¡¹ç›®
                localStorage.setItem('selectedItems', JSON.stringify(Array.from(selectedItems)));
                
                console.log('å½“å‰çŠ¶æ€å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
            } catch (error) {
                console.error('ä¿å­˜å½“å‰çŠ¶æ€æ—¶å‡ºé”™:', error);
            }
        }
        
        // æ¢å¤ä¸Šæ¬¡çš„æœç´¢ç»“æœ
        function restoreSearchResults() {
            try {
                // å…ˆæ¸…ç©ºé€‰ä¸­é¡¹ï¼Œåç»­ä¼šæ ¹æ®ä¿å­˜çš„çŠ¶æ€é‡æ–°è®¾ç½®
                selectedItems.clear();
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„æœç´¢ç»“æœ
                const savedResults = loadSearchResultsFromStorage();
                if (savedResults && savedResults.length > 0) {
                    console.log('ä»æœ¬åœ°å­˜å‚¨æ¢å¤æœç´¢ç»“æœ:', savedResults.length);
                    
                    // æ¢å¤æœç´¢é¢æ¿çŠ¶æ€
                    const searchActive = localStorage.getItem('searchActive') === 'true';
                    if (searchActive) {
                        // æ˜¾ç¤ºæœç´¢ç»“æœ
                        showSearchResults(savedResults);
                        
                        // æ¢å¤é€‰ä¸­çš„é¡¹ç›®
                        const savedSelectedItems = localStorage.getItem('selectedItems');
                        if (savedSelectedItems) {
                            try {
                                const items = JSON.parse(savedSelectedItems);
                                if (Array.isArray(items)) {
                                    // æ·»åŠ ä¿å­˜çš„é¡¹ç›®
                                    items.forEach(id => {
                                        selectedItems.add(id);
                                    });
                                    
                                    // æ›´æ–°é€‰æ‹©æ¡†çŠ¶æ€
                                    document.querySelectorAll('.search-result-checkbox').forEach(checkbox => {
                                        const docId = checkbox.dataset.docId;
                                        if (selectedItems.has(docId)) {
                                            checkbox.checked = true;
                                            const resultItem = checkbox.closest('.search-result-item');
                                            if (resultItem) {
                                                resultItem.classList.add('selected');
                                            }
                                        }
                                    });
                                    
                                    // æ›´æ–°UI
                                    updateSelectionCount();
                                }
                            } catch (parseError) {
                                console.error('è§£æå·²ä¿å­˜çš„é€‰æ‹©é¡¹æ—¶å‡ºé”™:', parseError);
                                localStorage.removeItem('selectedItems');
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('æ¢å¤æœç´¢ç»“æœæ—¶å‡ºé”™:', error);
                // å‡ºé”™æ—¶æ¸…ç©ºæœ¬åœ°å­˜å‚¨çš„æœç´¢ç»“æœï¼Œé¿å…æŒç»­å‡ºé”™
                localStorage.removeItem('searchResults');
                localStorage.removeItem('selectedItems');
            }
        }

        // æ¢å¤ä¸Šæ¬¡çš„æœç´¢ç»“æœ
        function restoreSearchResults() {
            console.log('ä¸å†è‡ªåŠ¨æ¢å¤æœç´¢ç»“æœ');
            // æ¸…ç©ºä»»ä½•å¯èƒ½å­˜åœ¨çš„æœç´¢ç»“æœå’Œé€‰ä¸­é¡¹
            selectedItems.clear();
            localStorage.removeItem('searchResults');
            localStorage.removeItem('rag_mcp_search_results');
            localStorage.removeItem('selectedItems');
            localStorage.removeItem('searchActive');
            return; // ç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œæ¢å¤é€»è¾‘
        }

        // APIå¥åº·æ£€æŸ¥
        function startApiHealthCheck() {
            // ç«‹å³æ‰§è¡Œä¸€æ¬¡å¥åº·æ£€æŸ¥
            checkApiHealth();
            
            // è®¾ç½®å®šæœŸæ£€æŸ¥ï¼ˆæ¯60ç§’ï¼‰
            apiCheckInterval = setInterval(checkApiHealth, 60000);
        }

        // æ£€æŸ¥APIå¥åº·çŠ¶æ€
        function checkApiHealth() {
            // ä½¿ç”¨ç®€å•çš„tools APIä½œä¸ºå¥åº·æ£€æŸ¥ç«¯ç‚¹
            fetch(API.TOOLS, { 
                method: 'GET',
                // è®¾ç½®è¾ƒçŸ­çš„è¶…æ—¶æ—¶é—´
                signal: AbortSignal.timeout(5000)
            })
            .then(response => {
                if (response.ok) {
                    if (!apiAvailable) {
                        console.log('APIæœåŠ¡æ¢å¤æ­£å¸¸');
                        apiAvailable = true;
                        showApiRestoreNotification();
                    }
                } else {
                    throw new Error(`APIè¿”å›: ${response.status}`);
                }
            })
            .catch(error => {
                if (apiAvailable) {
                    console.warn('APIæœåŠ¡ä¸å¯ç”¨:', error);
                    apiAvailable = false;
                    showApiErrorNotification();
                }
            });
        }

        // æ˜¾ç¤ºAPIæ¢å¤é€šçŸ¥
        function showApiRestoreNotification() {
            const notificationContainer = document.createElement('div');
            notificationContainer.className = 'api-notification restore';
            notificationContainer.innerHTML = `
                <div class="api-notification-content">
                    <span class="api-notification-icon">âœ“</span>
                    <span class="api-notification-message">Server connection restored. Full functionality available.</span>
                    <span class="api-notification-close" onclick="this.parentElement.parentElement.remove()">Ã—</span>
                </div>
            `;
            
            document.body.appendChild(notificationContainer);
            
            // 5ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                notificationContainer.classList.add('fade-out');
                setTimeout(() => {
                    notificationContainer.remove();
                }, 500);
            }, 5000);
        }

        // æ˜¾ç¤ºAPIé”™è¯¯é€šçŸ¥
        function showApiErrorNotification() {
            const notificationContainer = document.createElement('div');
            notificationContainer.className = 'api-notification error';
            notificationContainer.innerHTML = `
                <div class="api-notification-content">
                    <span class="api-notification-icon">!</span>
                    <span class="api-notification-message">Server connection lost. Limited functionality available.</span>
                    <span class="api-notification-close" onclick="this.parentElement.parentElement.remove()">Ã—</span>
                </div>
            `;
            
            document.body.appendChild(notificationContainer);
            
            // 10ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                notificationContainer.classList.add('fade-out');
                setTimeout(() => {
                    notificationContainer.remove();
                }, 500);
            }, 10000);
        }

        // åˆå§‹åŒ–UIï¼Œä¸ä¾èµ–API
        function initializeUI() {
            console.log('åˆå§‹åŒ–UI...');
            // åŸºæœ¬UIåˆå§‹åŒ–ï¼Œå³ä½¿APIä¸å¯ç”¨ä¹Ÿä¼šæ‰§è¡Œ
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            });
                console.log('èŠå¤©è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬å™¨å·²æ·»åŠ ');
            } else {
                console.error('æ‰¾ä¸åˆ°èŠå¤©è¾“å…¥æ¡†å…ƒç´ ');
            }
            
            const sendButton = document.getElementById('send-button');
            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
                console.log('å‘é€æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²æ·»åŠ ');
            } else {
                console.error('æ‰¾ä¸åˆ°å‘é€æŒ‰é’®å…ƒç´ ');
            }
            
            // è®¾ç½®å·¥å…·åˆ‡æ¢
            setupToolSwitchers();
            
            // ç«‹å³æ˜¾ç¤ºé»˜è®¤å·¥å…·
            displayDefaultTools();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ä¼šè¯ID
            const sessionId = get_or_create_session_id();
            console.log('å½“å‰ä¼šè¯ID:', sessionId);
            
            // ä¸æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
            isPageLoad = false;
        }

        // å®‰å…¨åŠ è½½å†å²è®°å½•
        function safeLoadHistory() {
            console.log('Attempting to load history...');
            fetch(API.HISTORY, {
                method: 'GET',
                signal: AbortSignal.timeout(10000) // 10ç§’è¶…æ—¶
            })
            .then(response => {
                console.log('History API response status:', response.status);
                if (!response.ok) {
                    throw new Error(`Failed to load history: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Successfully loaded history:', data);
                if (data && data.length > 0) {
                    displayHistory(data);
                } else {
                    console.log('No history records found');
                    // ä¸æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
                }
            })
            .catch(error => {
                console.warn('Failed to load history from API:', error);
                // å°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½å†å²è®°å½•
                const loaded = loadHistoryFromLocalStorage();
                console.log('Loaded history from local storage:', loaded);
                
                // æ ‡è®°APIå¯èƒ½ä¸å¯ç”¨
                if (apiAvailable) {
                    apiAvailable = false;
                    checkApiHealth(); // ç«‹å³æ‰§è¡Œå¥åº·æ£€æŸ¥
                }
            });
        }

        // å®‰å…¨åŠ è½½å·¥å…·
        function safeLoadTools() {
            console.log('å°è¯•åŠ è½½å·¥å…·...');
            fetch(API.TOOLS, {
                method: 'GET',
                signal: AbortSignal.timeout(10000) // 10ç§’è¶…æ—¶
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`åŠ è½½å·¥å…·å¤±è´¥: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('å·¥å…·åŠ è½½æˆåŠŸ:', data);
                if (data && Array.isArray(data)) {
                    // è¿‡æ»¤æ‰PDFå·¥å…·
                    const filteredTools = data.filter(tool => tool.id !== 'pdf');
                    populateTools(filteredTools);
                } else {
                    console.log('æ²¡æœ‰å¯ç”¨å·¥å…·æ•°æ®ï¼Œæ˜¾ç¤ºé»˜è®¤å·¥å…·');
                    displayDefaultTools();
                }
            })
            .catch(error => {
                console.warn('æ— æ³•ä»APIåŠ è½½å·¥å…·:', error);
                // æ˜¾ç¤ºé»˜è®¤å·¥å…·
                displayDefaultTools();
                // æ ‡è®°APIå¯èƒ½ä¸å¯ç”¨
                if (apiAvailable) {
                    apiAvailable = false;
                    checkApiHealth(); // ç«‹å³æ‰§è¡Œå¥åº·æ£€æŸ¥
                }
            });
        }

        // æ˜¾ç¤ºé»˜è®¤å·¥å…·
        function displayDefaultTools() {
            const defaultTools = [
                { id: 'chat', name: 'Chat' },
                { id: 'search', name: 'Search' }
                // å·²ç§»é™¤PDFå·¥å…·
            ];
            populateTools(defaultTools);
        }

        // æ‰¾åˆ°sendMessageå‡½æ•°å¹¶ä¿®æ”¹ç›¸å…³éƒ¨åˆ†
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            console.log("å‘é€æ¶ˆæ¯:", message);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            const userMessage = {
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            };
            
            displayMessage(userMessage);
            
            // ä¿å­˜åˆ°å†å²è®°å½•
            addToHistory(userMessage);
            
            // æ˜¾ç¤ºåŠ©æ‰‹æ­£åœ¨è¾“å…¥
            showTypingIndicator();
            
            // å¦‚æœAPIä¸å¯ç”¨ï¼Œæ˜¾ç¤ºç¦»çº¿æ¨¡å¼æ¶ˆæ¯
            if (!apiAvailable) {
                setTimeout(() => {
                    hideTypingIndicator();
                    
                    const offlineMessage = {
                        role: 'assistant',
                        content: `æœåŠ¡å™¨è¿æ¥æš‚æ—¶ä¸å¯ç”¨ã€‚æ‚¨çš„æ¶ˆæ¯å·²ä¿å­˜ï¼Œå°†åœ¨è¿æ¥æ¢å¤åå¤„ç†ã€‚`,
                        timestamp: new Date().toISOString(),
                        offline: true
                    };
                    
                    displayMessage(offlineMessage);
                    addToHistory(offlineMessage);
                    
                    // å°è¯•å†æ¬¡æ£€æŸ¥APIå¥åº·çŠ¶æ€
                    checkApiHealth();
                }, 1500);
                return;
            }
            
            // ä¸­æ–­ä¹‹å‰çš„è¯·æ±‚ï¼ˆå¦‚æœæœ‰ï¼‰
            if (controller) {
                controller.abort();
            }
            
            // åˆ›å»ºæ–°çš„AbortController
            controller = new AbortController();
            
            // å‡†å¤‡å‘é€æ•°æ® - ç®€åŒ–è¯·æ±‚æ ¼å¼ï¼Œä¸åç«¯æœŸæœ›çš„æ ¼å¼ä¿æŒä¸€è‡´
            const requestData = {
                query: message,
                session_id: get_or_create_session_id()
            };
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°å¯¹è¯çš„ç¬¬ä¸€æ¡æ¶ˆæ¯
            const isNewChat = localStorage.getItem('is_new_chat') === 'true';
            if (isNewChat) {
                requestData.is_new_chat = true;
                localStorage.removeItem('is_new_chat'); // ä½¿ç”¨åç§»é™¤æ ‡å¿—
                console.log("è¿™æ˜¯æ–°å¯¹è¯çš„ç¬¬ä¸€æ¡æ¶ˆæ¯");
            }
            
            // å¦‚æœæœ‰é€‰ä¸­çš„æ–‡æ¡£ï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
            const savedSelectedDocs = localStorage.getItem('rag_mcp_selected_docs');
            if (savedSelectedDocs) {
                try {
                    const selectedDocs = JSON.parse(savedSelectedDocs);
                    if (selectedDocs && selectedDocs.length > 0) {
                        requestData.selected_docs = selectedDocs;
                        console.log("å·²æ·»åŠ é€‰ä¸­çš„æ–‡æ¡£åˆ°è¯·æ±‚:", selectedDocs);
                        // ä½¿ç”¨åæ¸…é™¤ï¼Œé¿å…å½±å“ä¸‹ä¸€æ¬¡è¯·æ±‚
                        localStorage.removeItem('rag_mcp_selected_docs');
                    }
                } catch (e) {
                    console.error("è§£æé€‰ä¸­æ–‡æ¡£å‡ºé”™:", e);
                }
            } else if (selectedItems.size > 0) {
                requestData.selected_docs = Array.from(selectedItems);
            }
            
            console.log("å‘é€APIè¯·æ±‚æ•°æ®:", requestData);
            console.log("å‘é€APIè¯·æ±‚URL:", API.PROCESS);
            
            // å‘é€è¯·æ±‚
            fetch(API.PROCESS, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData),
                signal: controller.signal
            })
            .then(response => {
                console.log("APIå“åº”çŠ¶æ€:", response.status);
                
                // æ£€æŸ¥è¯¦ç»†çš„å“åº”ä¿¡æ¯
                response.clone().text().then(text => {
                    console.log("APIå“åº”åŸå§‹å†…å®¹:", text.substring(0, 500) + (text.length > 500 ? '...' : ''));
                    try {
                        // å°è¯•è§£æä¸ºJSON
                        const jsonResponse = JSON.parse(text);
                        console.log("APIå“åº”JSONè§£æç»“æœ:", jsonResponse);
                    } catch (e) {
                        console.log("APIå“åº”ä¸æ˜¯æœ‰æ•ˆJSON");
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Request failed: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("APIå“åº”æ•°æ®:", data);
                hideTypingIndicator();
                
                // å¤„ç†å“åº”
                if (data.response) {
                    const assistantMessage = {
                        role: 'assistant',
                        content: data.response,
                        timestamp: new Date().toISOString()
                    };
                    
                    displayMessage(assistantMessage);
                    addToHistory(assistantMessage);
                } else if (data.answer) {
                    // å…¼å®¹å¯èƒ½çš„ä¸åŒå“åº”æ ¼å¼
                    const assistantMessage = {
                        role: 'assistant',
                        content: data.answer,
                        timestamp: new Date().toISOString()
                    };
                    
                    displayMessage(assistantMessage);
                    addToHistory(assistantMessage);
                } else {
                    console.error("APIå“åº”ä¸­æ²¡æœ‰æ‰¾åˆ°å›ç­”");
                    const errorMessage = {
                        role: 'assistant',
                        content: "Received an empty response from the server. Please try again.",
                        timestamp: new Date().toISOString(),
                        error: true
                    };
                    
                    displayMessage(errorMessage);
                    addToHistory(errorMessage);
                }
                
                // åˆ¤æ–­å½“å‰æ“ä½œæ˜¯å¦æ˜¯åŸºäºé¢„é€‰æ–‡æ¡£çš„è¯·æ±‚ï¼ˆå¦‚ï¼šç”Ÿæˆç»¼è¿°ï¼‰
                const isUsingPreselectedDocs = (selectedItems.size > 0 || 
                    (savedSelectedDocs && JSON.parse(savedSelectedDocs).length > 0)) &&
                    !message.toLowerCase().match(/æ£€ç´¢|æœç´¢|search|find|papers about/i);
                
                // åªæœ‰åœ¨éé¢„é€‰æ–‡æ¡£æ“ä½œæ—¶æ‰æ›´æ–°æ£€ç´¢ç»“æœé¢æ¿
                if (!isUsingPreselectedDocs) {
                    // å¤„ç†æœç´¢ç»“æœ - åŒæ—¶æ£€æŸ¥ä¸¤ä¸ªå¯èƒ½çš„å­—æ®µå
                    if (data.search_results && data.search_results.length > 0) {
                        console.log("æ‰¾åˆ°search_resultså­—æ®µ:", data.search_results.length);
                        showSearchResults(data.search_results);
                    } else if (data.references && data.references.length > 0) {
                        console.log("æ‰¾åˆ°referenceså­—æ®µ:", data.references.length);
                        showSearchResults(data.references);
                    } else {
                        console.log("APIå“åº”ä¸­æ²¡æœ‰æ‰¾åˆ°æœç´¢ç»“æœ");
                    }
                } else {
                    console.log("ä½¿ç”¨é¢„é€‰æ–‡æ¡£ç”Ÿæˆç»¼è¿°ï¼Œä¸æ›´æ–°æ£€ç´¢ç»“æœé¢æ¿");
                }
            })
            .catch(error => {
                // ä»…å¤„ç†éä¸­æ–­é”™è¯¯
                if (error.name !== 'AbortError') {
                    console.error('å¤„ç†æ¶ˆæ¯æ—¶å‡ºé”™:', error);
                    hideTypingIndicator();
                    
                    // åˆ›å»ºé”™è¯¯æ¶ˆæ¯
                    const errorMessage = {
                        role: 'assistant',
                        content: `å¤„ç†è¯·æ±‚æ—¶å‡ºç°é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚(é”™è¯¯: ${error.message})`,
                        timestamp: new Date().toISOString(),
                        error: true
                    };
                    
                    displayMessage(errorMessage);
                    addToHistory(errorMessage);
                    
                    // æ ‡è®°APIå¯èƒ½ä¸å¯ç”¨
                    apiAvailable = false;
                    checkApiHealth(); // ç«‹å³æ‰§è¡Œå¥åº·æ£€æŸ¥
                } else {
                    console.log('è¯·æ±‚å·²ä¸­æ–­');
                }
            });
        }

        // å®‰å…¨å¤„ç†æœç´¢ç»“æœ
        function showSearchResults(results) {
            try {
                // å¦‚æœæ²¡æœ‰ä¼ å…¥ç»“æœï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½
                if (!results) {
                    results = loadSearchResultsFromStorage();
                    if (!results || results.length === 0) {
                        console.log("æ²¡æœ‰å¯ç”¨çš„æœç´¢ç»“æœ");
                    }
                }
                
                console.log("æ˜¾ç¤ºæœç´¢ç»“æœ:", results);
                
                // ä¿å­˜æœç´¢ç»“æœåˆ°æœ¬åœ°å­˜å‚¨
                if (results && results.length > 0) {
                    saveSearchResultsToStorage(results);
                }
                
                // é«˜äº®æœç´¢å·¥å…·é€‰æ‹©
                const searchTool = document.querySelector('[data-tool="search"]');
                if (searchTool) {
                    searchTool.classList.add('selected');
                }
                
                // ä¿®æ”¹è¿™éƒ¨åˆ†ï¼Œä½¿æœç´¢ç»“æœå¹¶æ’æ˜¾ç¤º
                const searchPanel = document.getElementById('search-panel');
                const resultsContainer = document.getElementById('search-results');
                
                // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
                resultsContainer.innerHTML = '';
                
                // å¤„ç†æ²¡æœ‰ç»“æœçš„æƒ…å†µ
                if (!results || results.length === 0) {
                    searchPanel.classList.add('visible');
                    resultsContainer.innerHTML = '<div class="no-results">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ç»“æœ</div>';
                    document.body.classList.add('search-active'); // æ¿€æ´»å¹¶æ’å¸ƒå±€
                    
                    // è‡ªåŠ¨æ”¶èµ·ä¾§æ ä»¥è…¾å‡ºç©ºé—´
                    const sidebar = document.getElementById('sidebar');
                    const toggle = document.getElementById('sidebar-toggle');
                    sidebar.classList.add('collapsed');
                    toggle.classList.add('collapsed');
                    return;
                }
                
                // å¤„ç†ç»“æœ
                searchPanel.classList.add('visible');
                document.body.classList.add('search-active'); // æ¿€æ´»å¹¶æ’å¸ƒå±€
                
                // è‡ªåŠ¨æ”¶èµ·ä¾§æ ä»¥è…¾å‡ºç©ºé—´
                const sidebar = document.getElementById('sidebar');
                const toggle = document.getElementById('sidebar-toggle');
                sidebar.classList.add('collapsed');
                toggle.classList.add('collapsed');
                
                // æ˜¾ç¤ºç»“æœæ•°é‡
                const resultCountHeader = document.createElement('div');
                resultCountHeader.className = 'result-count';
                resultCountHeader.textContent = `æ‰¾åˆ° ${results.length} æ¡ç»“æœ`;
                resultsContainer.appendChild(resultCountHeader);
                
                // éå†ç»“æœå¹¶æ˜¾ç¤º
                results.forEach((result, index) => {
                    try {
                        // è·å–æ–‡æ¡£ID (ç¡®ä¿å…¼å®¹ä¸åŒæ ¼å¼)
                        const docId = result.document_id || result.doc_id || result.id || index.toString();
                        
                        // åˆ›å»ºç»“æœé¡¹
                        const resultItem = document.createElement('div');
                        resultItem.className = 'search-result-item';
                        resultItem.dataset.docId = docId;
                        
                        // æ·»åŠ é€‰æ‹©æ¡†
                        const checkboxContainer = document.createElement('div');
                        checkboxContainer.className = 'search-result-checkbox-container';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'search-result-checkbox';
                        checkbox.dataset.docId = docId;
                        
                        // æ£€æŸ¥æ˜¯å¦å·²è¢«é€‰ä¸­
                        if (selectedItems.has(docId)) {
                            checkbox.checked = true;
                            resultItem.classList.add('selected');
                        }
                        
                        // æ·»åŠ é€‰æ‹©æ¡†çš„äº‹ä»¶å¤„ç†
                        checkbox.addEventListener('change', function(e) {
                            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                            toggleItemSelection(docId);
                            if (this.checked) {
                                resultItem.classList.add('selected');
                            } else {
                                resultItem.classList.remove('selected');
                            }
                        });
                        
                        checkboxContainer.appendChild(checkbox);
                        resultItem.appendChild(checkboxContainer);
                        
                        // åˆ›å»ºå†…å®¹å®¹å™¨
                        const contentContainer = document.createElement('div');
                        contentContainer.className = 'search-result-content-container';
                        
                        // åˆ›å»ºç»“æœå¤´éƒ¨ (æ ‡é¢˜å’Œç›¸å…³åº¦)
                        const resultHeader = document.createElement('div');
                        resultHeader.className = 'search-result-header';
                        
                        // æ·»åŠ æ ‡é¢˜
                        const resultTitle = document.createElement('div');
                        resultTitle.className = 'search-result-title';
                        resultTitle.textContent = result.title || 'æ— æ ‡é¢˜æ–‡æ¡£';
                        resultHeader.appendChild(resultTitle);
                        
                        // æ·»åŠ ç›¸å…³æ€§åˆ†æ•°
                        if (result.score || result.relevance_score) {
                            const score = result.score || result.relevance_score;
                            const resultScore = document.createElement('div');
                            resultScore.className = 'search-result-score';
                            resultScore.textContent = `${parseFloat(score).toFixed(2)}`;
                            resultHeader.appendChild(resultScore);
                        }
                        
                        contentContainer.appendChild(resultHeader);
                        
                        // æ·»åŠ å†…å®¹æ‘˜è¦ - æŒ‰ç…§ä¼˜å…ˆçº§ä½¿ç”¨ä¸åŒå­—æ®µ
                        const contentElem = document.createElement('div');
                        contentElem.className = 'search-result-content';
                        
                        // å†…å®¹ä¼˜å…ˆçº§: snippet > abstract > text
                        let content = 'æ— å¯ç”¨å†…å®¹';
                        if (result.snippet && result.snippet.trim()) {
                            content = result.snippet;
                        } else if (result.abstract && result.abstract.trim()) {
                            content = result.abstract;
                        } else if (result.text && result.text.trim()) {
                            // åªå–å‰300ä¸ªå­—ç¬¦ä½œä¸ºæ‘˜è¦
                            content = result.text.substring(0, 300) + (result.text.length > 300 ? '...' : '');
                        }
                        
                        contentElem.textContent = content;
                        contentContainer.appendChild(contentElem);
                        
                        resultItem.appendChild(contentContainer);
                        
                        // ç§»é™¤åŸæ¥çš„ç‚¹å‡»äº‹ä»¶ï¼Œæ”¹ä¸ºç‚¹å‡»é€‰æ‹©æ¡†
                        resultItem.addEventListener('click', function(e) {
                            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯é€‰æ‹©æ¡†æœ¬èº«ï¼Œåˆ™è§¦å‘é€‰æ‹©æ¡†çš„ç‚¹å‡»
                            if (!e.target.classList.contains('search-result-checkbox')) {
                                const cb = this.querySelector('.search-result-checkbox');
                                cb.checked = !cb.checked;
                                // è§¦å‘changeäº‹ä»¶
                                const event = new Event('change');
                                cb.dispatchEvent(event);
                            }
                        });
                        
                        resultsContainer.appendChild(resultItem);
                    } catch (itemError) {
                        console.error(`å¤„ç†æœç´¢ç»“æœé¡¹ ${index} æ—¶å‡ºé”™:`, itemError);
                    }
                });
                
                // ç¡®ä¿æœç´¢é¢æ¿å¯è§
                searchPanel.classList.add('visible');
                
                // æ›´æ–°é€‰æ‹©è®¡æ•°
                updateSelectionCount();
            } catch (error) {
                console.error("æ˜¾ç¤ºæœç´¢ç»“æœæ—¶å‡ºé”™:", error);
            }
        }

        // åˆ‡æ¢å·¦ä¾§è¾¹æ 
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.getElementById('sidebar-toggle');
            
            // ä¿å­˜å½“å‰ä¾§æ çŠ¶æ€
            const isCollapsed = sidebar.classList.contains('collapsed');
            
            // æ£€æŸ¥æ˜¯å¦å¤„äºæœç´¢æ¿€æ´»çŠ¶æ€
            const isSearchActive = document.body.classList.contains('search-active');
            
            if (isSearchActive) {
                // åœ¨æœç´¢æ¿€æ´»çŠ¶æ€ä¸‹
                if (isCollapsed) {
                    // å¦‚æœä¾§æ å·²æ”¶èµ·ï¼Œå…ˆç§»é™¤search-activeç±»ï¼Œå†å±•å¼€ä¾§æ 
                    // æš‚æ—¶ä¿å­˜æœç´¢é¢æ¿çŠ¶æ€
                    const searchPanel = document.getElementById('search-panel');
                    const wasSearchPanelVisible = searchPanel.classList.contains('visible');
                    
                    // ç§»é™¤æœç´¢æ´»åŠ¨çŠ¶æ€ç±»
                    document.body.classList.remove('search-active');
                    
                    // å±•å¼€ä¾§æ 
                    sidebar.classList.remove('collapsed');
                    toggle.classList.remove('collapsed');
                    
                    // æ¢å¤æœç´¢é¢æ¿çŠ¶æ€
                    if (wasSearchPanelVisible) {
                        searchPanel.classList.add('visible');
                        // ä½¿ç”¨setTimeoutä»¥ç¡®ä¿CSSè¿‡æ¸¡æ•ˆæœæ­£å¸¸
                        setTimeout(() => {
                            document.body.classList.add('search-active');
                        }, 10);
                    }
                } else {
                    // å¦‚æœä¾§æ å·²å±•å¼€ï¼Œç›´æ¥æ”¶èµ·
                    sidebar.classList.add('collapsed');
                    toggle.classList.add('collapsed');
                }
            } else {
                // åœ¨æ™®é€šçŠ¶æ€ä¸‹ï¼Œç®€å•åœ°åˆ‡æ¢ç±»
            sidebar.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
            }
        }

        // é€‰æ‹©å·¥å…·
        function selectTool(element, toolType) {
            // ç§»é™¤æ‰€æœ‰å·¥å…·çš„activeç±»
            document.querySelectorAll('.tool-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // ç»™å½“å‰é€‰ä¸­çš„å·¥å…·æ·»åŠ activeç±»
            element.classList.add('active');
            currentTool = toolType;
            
            // æ ¹æ®é€‰æ‹©çš„å·¥å…·æ‰§è¡Œå¯¹åº”æ“ä½œ
            if (toolType === 'search') {
                // ä¸å†è‡ªåŠ¨åŠ è½½å†å²æœç´¢ç»“æœï¼Œåªæ‰“å¼€ç©ºçš„æœç´¢é¢æ¿
                const searchPanel = document.getElementById('search-panel');
                searchPanel.classList.add('visible');
                document.body.classList.add('search-active');
                
                // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
                const resultsContainer = document.getElementById('search-results');
                
                // ç¡®ä¿èŠå¤©æ¶ˆæ¯æ˜¾ç¤º
                document.getElementById('chat-messages').style.display = 'flex';
                // ç§»é™¤PDFä¸Šä¼ å®¹å™¨çš„activeçŠ¶æ€
                document.getElementById('pdf-upload-container').classList.remove('active');
            } else { // chatå·¥å…·
                closeSearch();
                // ç¡®ä¿èŠå¤©æ¶ˆæ¯æ˜¾ç¤º
                document.getElementById('chat-messages').style.display = 'flex';
                // ç§»é™¤PDFä¸Šä¼ å®¹å™¨çš„activeçŠ¶æ€
                document.getElementById('pdf-upload-container').classList.remove('active');
            }
        }

        // å¤„ç†PDFæ–‡ä»¶é€‰æ‹©
        function handleFileSelect(input) {
            try {
                console.log('æ–‡ä»¶é€‰æ‹©å‡½æ•°è¢«è°ƒç”¨', input);
                // æ£€æŸ¥inputæ˜¯å¦æ˜¯æœ‰æ•ˆçš„DOMå…ƒç´ 
                if (!input || !input.files) {
                    console.error('æ— æ•ˆçš„æ–‡ä»¶è¾“å…¥å…ƒç´ ', input);
                    alert('æ— æ³•è®¿é—®æ–‡ä»¶è¾“å…¥å…ƒç´ ã€‚è¯·åˆ·æ–°é¡µé¢åé‡è¯•ã€‚');
                    return;
                }

                const files = input.files;
                if (!files || files.length === 0) {
                    console.log('æœªé€‰æ‹©æ–‡ä»¶');
                    return;
                }

                // åªå¤„ç†ç¬¬ä¸€ä¸ªæ–‡ä»¶
                selectedFile = files[0];
                console.log('å·²é€‰æ‹©æ–‡ä»¶:', selectedFile.name, 'å¤§å°:', selectedFile.size, 'bytes');
                
                // æ ¹æ®å½“å‰å·¥å…·å†³å®šå¤„ç†é€»è¾‘
                if (currentTool === 'search') {
                    // ç›´æ¥å¼€å§‹å¤„ç†PDFè¿›è¡Œæ£€ç´¢ç›¸å…³æ–‡çŒ®
                    processPdf(true);
                } else { // chatå·¥å…·
                    // å¼€å§‹å¤„ç†PDFè¿›è¡Œè§£æå’Œåˆ†æ
                    processPdf(false);
                }
            } catch (error) {
                console.error('æ–‡ä»¶é€‰æ‹©è¿‡ç¨‹ä¸­å‡ºé”™:', error);
                alert('æ— æ³•é€‰æ‹©æ–‡ä»¶ã€‚è¯·é‡è¯•ã€‚é”™è¯¯è¯¦æƒ…: ' + error.message);
            }
        }

        // ç§»é™¤é€‰å®šçš„PDFæ–‡ä»¶
        function removeFile() {
            try {
                selectedFile = null;
                const fileInput = document.getElementById('pdf-file-input');
                if (fileInput) {
                    fileInput.value = '';
                } else {
                    console.error('æ‰¾ä¸åˆ°pdf-file-inputå…ƒç´ ');
                }
                
                const selectedFileElement = document.getElementById('selected-file');
                if (selectedFileElement) {
                    selectedFileElement.classList.remove('active');
                } else {
                    console.error('æ‰¾ä¸åˆ°selected-fileå…ƒç´ ');
                }
                
                const processButton = document.getElementById('process-pdf-button');
                if (processButton) {
                    processButton.classList.remove('active');
                } else {
                    console.error('æ‰¾ä¸åˆ°process-pdf-buttonå…ƒç´ ');
                }
                
                console.log('å·²ç§»é™¤é€‰æ‹©çš„æ–‡ä»¶');
            } catch (error) {
                console.error('ç§»é™¤æ–‡ä»¶æ—¶å‡ºé”™:', error);
                alert('æ— æ³•ç§»é™¤é€‰å®šçš„æ–‡ä»¶ã€‚é”™è¯¯: ' + error.message);
            }
        }

        // å¤„ç†PDFè§£è¯»
        function processPdf(isSearchMode = false) {
            try {
                // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²é€‰æ‹©
                if (!selectedFile) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªPDFæ–‡ä»¶');
                    return;
                }
                
                // éªŒè¯æ˜¯å¦æ˜¯PDFæ–‡ä»¶
                if (selectedFile.type !== 'application/pdf' && !selectedFile.name.toLowerCase().endsWith('.pdf')) {
                    alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„PDFæ–‡ä»¶');
                    return;
                }
                
                // æ£€æŸ¥æ–‡ä»¶å¤§å° (é™åˆ¶ä¸º50MB)
                const maxSizeInBytes = 50 * 1024 * 1024;
                if (selectedFile.size > maxSizeInBytes) {
                    alert(`PDFæ–‡ä»¶è¿‡å¤§ï¼Œæœ€å¤§æ”¯æŒ50MBï¼Œå½“å‰æ–‡ä»¶å¤§å°: ${(selectedFile.size / (1024 * 1024)).toFixed(2)}MB`);
                    return;
                }
                
                // æ£€æŸ¥APIæ˜¯å¦å¯ç”¨
                if (!apiAvailable) {
                    alert('æœåŠ¡å™¨è¿æ¥ä¸å¯ç”¨ï¼Œæ— æ³•å¤„ç†PDFæ–‡ä»¶ã€‚è¯·ç¨åå†è¯•ã€‚');
                    return;
                }
                
                // æ˜¾ç¤ºå¤„ç†æç¤ºæ¶ˆæ¯
                const processingMsg = {
                    role: 'system',
                    content: `<div class="processing-message">æ­£åœ¨å¤„ç†PDFæ–‡ä»¶ï¼š${selectedFile.name}...</div>`,
                    timestamp: new Date().toISOString()
                };
                displayMessage(processingMsg);
                
                // å‡†å¤‡è¡¨å•æ•°æ®
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('search_mode', isSearchMode.toString()); // æ·»åŠ ä¸€ä¸ªå‚æ•°æŒ‡ç¤ºæ˜¯å¦ä¸ºæœç´¢æ¨¡å¼
                
                // è®¾ç½®è¶…æ—¶
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60ç§’è¶…æ—¶
                
                console.log(`å¼€å§‹ä¸Šä¼ PDFæ–‡ä»¶: ${selectedFile.name}, æœç´¢æ¨¡å¼: ${isSearchMode}`);
                
                // å‘é€è¯·æ±‚
                fetch(API.UPLOAD, {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                })
                .then(response => {
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.status} - ${response.statusText}`);
                    }
                    console.log('PDFä¸Šä¼ å“åº”çŠ¶æ€:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('PDFå¤„ç†å“åº”:', data);
                    
                    if (data.task_id) {
                        currentTaskId = data.task_id;
                        
                        // è®¾ç½®å®šæ—¶æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
                        if (taskCheckInterval) {
                            clearInterval(taskCheckInterval);
                        }
                        
                        // æ›´æ–°å¤„ç†æ¶ˆæ¯
                        const updatedMsg = {
                            role: 'system',
                            content: `<div class="processing-message">æ­£åœ¨å¤„ç†PDFæ–‡ä»¶ï¼š${selectedFile.name}... è¯·ç¨å€™</div>`,
                            timestamp: new Date().toISOString()
                        };
                        // æ›¿æ¢ä¹‹å‰æ˜¾ç¤ºçš„å¤„ç†æ¶ˆæ¯
                        const messagesContainer = document.getElementById('chat-messages');
                        const lastMessage = messagesContainer.lastElementChild;
                        if (lastMessage && lastMessage.querySelector('.processing-message')) {
                            lastMessage.querySelector('.message-content').innerHTML = updatedMsg.content;
                        } else {
                            displayMessage(updatedMsg);
                        }
                        
                        // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡ä»»åŠ¡çŠ¶æ€ï¼Œä¼ å…¥æœç´¢æ¨¡å¼å‚æ•°
                        taskCheckInterval = setInterval(() => checkTaskStatus(currentTaskId, isSearchMode), 3000);
                    } else {
                        // æ²¡æœ‰ä»»åŠ¡IDï¼Œå¯èƒ½æ˜¯ç«‹å³å¤„ç†å®Œæˆäº†
                        handleProcessingComplete(data, isSearchMode);
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    console.error('PDFå¤„ç†å‡ºé”™:', error);
                    
                    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                    const errorMsg = {
                        role: 'system',
                        content: `<div class="error-message">å¤„ç†PDFå¤±è´¥: ${error.name === 'AbortError' ? 'è¯·æ±‚è¶…æ—¶' : error.message}</div>`,
                        timestamp: new Date().toISOString()
                    };
                    displayMessage(errorMsg);
                    
                    // å¦‚æœæ˜¯éä¸­æ–­é”™è¯¯ï¼Œæ ‡è®°APIå¯èƒ½ä¸å¯ç”¨
                    if (error.name !== 'AbortError') {
                        apiAvailable = false;
                        checkApiHealth(); // ç«‹å³æ‰§è¡Œå¥åº·æ£€æŸ¥
                    }
                });
                
                // é‡ç½®æ–‡ä»¶è¾“å…¥
                const pdfUploadInput = document.getElementById('pdf-upload-input');
                if (pdfUploadInput) {
                    pdfUploadInput.value = '';
                }
            } catch (error) {
                console.error('PDFå¤„ç†å‡½æ•°å‡ºé”™:', error);
                alert('å¤„ç†PDFæ–‡ä»¶æ—¶é‡åˆ°é”™è¯¯: ' + error.message);
            }
        }
        
        // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
        function checkTaskStatus(taskId, isSearchMode = false) {
            if (!taskId) {
                console.error('æ²¡æœ‰ä»»åŠ¡IDï¼Œæ— æ³•æ£€æŸ¥çŠ¶æ€');
                return;
            }
            
            console.log(`æ£€æŸ¥ä»»åŠ¡çŠ¶æ€: ${taskId}, æœç´¢æ¨¡å¼: ${isSearchMode}`);
            
            fetch(`${API.TASK}/${taskId}`, {
                method: 'GET',
                signal: AbortSignal.timeout(5000) // 5ç§’è¶…æ—¶
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥: ${response.status} - ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('ä»»åŠ¡çŠ¶æ€:', data);
                
                // æ›´æ–°å¤„ç†æ¶ˆæ¯
                const statusMessage = `æ­£åœ¨å¤„ç†PDFæ–‡ä»¶ï¼š${selectedFile ? selectedFile.name : ''}... ${data.progress || 0}%`;
                const messagesContainer = document.getElementById('chat-messages');
                const lastMessage = messagesContainer.lastElementChild;
                if (lastMessage && lastMessage.querySelector('.processing-message')) {
                    lastMessage.querySelector('.message-content').innerHTML = `<div class="processing-message">${statusMessage}</div>`;
                }
                
                // å¦‚æœä»»åŠ¡å·²å®Œæˆï¼Œåœæ­¢æ£€æŸ¥
                if (data.status === 'completed') {
                    if (taskCheckInterval) {
                        clearInterval(taskCheckInterval);
                        taskCheckInterval = null;
                    }
                    
                    // å¤„ç†å®Œæˆ
                    handleProcessingComplete(data, isSearchMode);
                } else if (data.status === 'failed') {
                    // ä»»åŠ¡å¤±è´¥
                    if (taskCheckInterval) {
                        clearInterval(taskCheckInterval);
                        taskCheckInterval = null;
                    }
                    
                    const errorMsg = {
                        role: 'system',
                        content: `<div class="error-message">å¤„ç†PDFå¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</div>`,
                        timestamp: new Date().toISOString()
                    };
                    displayMessage(errorMsg);
                }
            })
            .catch(error => {
                console.error('æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å‡ºé”™:', error);
                
                // å¦‚æœæ˜¯éä¸­æ–­é”™è¯¯ï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨é—®é¢˜
                if (error.name !== 'AbortError') {
                    // åœæ­¢æ£€æŸ¥
                    if (taskCheckInterval) {
                        clearInterval(taskCheckInterval);
                        taskCheckInterval = null;
                    }
                    
                    const errorMsg = {
                        role: 'system',
                        content: `<div class="error-message">æ— æ³•è·å–å¤„ç†çŠ¶æ€: ${error.message}</div>`,
                        timestamp: new Date().toISOString()
                    };
                    displayMessage(errorMsg);
                    
                    // æ ‡è®°APIå¯èƒ½ä¸å¯ç”¨
                    apiAvailable = false;
                    checkApiHealth(); // ç«‹å³æ‰§è¡Œå¥åº·æ£€æŸ¥
                }
            });
        }

        // åˆ é™¤èŠå¤©è®°å½•
        function deleteChat(event, chatId) {
            event.stopPropagation();
            // TODO: å®ç°åˆ é™¤èŠå¤©è®°å½•çš„API
            const chatItem = event.target.parentElement;
            chatItem.remove();
        }

        // åŠ è½½èŠå¤©
        function loadChat(chatId) {
            console.log('åŠ è½½èŠå¤©:', chatId);
            
            // è®¾ç½®å½“å‰ä¼šè¯ID
            localStorage.setItem('current_session_id', chatId);
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½èŠå¤©è®°å½•
            const history = JSON.parse(localStorage.getItem('chat_history')) || {};
            const session = history[chatId];
            
            if (session && session.messages) {
                // æ¸…ç©ºèŠå¤©æ¶ˆæ¯åŒºåŸŸ
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.innerHTML = '';
                
                // æ·»åŠ æ‰€æœ‰æ¶ˆæ¯ï¼Œä½†ä¸ä½¿ç”¨æ‰“å­—æ•ˆæœ
                session.messages.forEach(msg => {
                    // ä½¿ç”¨displayMessageä»£æ›¿addMessage
                    displayMessage({
                        role: msg.role,
                        content: msg.content,
                        timestamp: new Date().toISOString()
                    }, false);
                });
                
                console.log('èŠå¤©æ¶ˆæ¯å·²åŠ è½½');
            } else {
                console.error(`æœªæ‰¾åˆ°ä¼šè¯ID: ${chatId}`);
            }
            
            // ç¡®ä¿é€‰ä¸­èŠå¤©å·¥å…·
            document.querySelectorAll('.tool-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const chatTool = document.getElementById('chat-tool');
            if (chatTool) {
                chatTool.classList.add('active');
            }
            currentTool = 'chat';
            
            // éšè—PDFä¸Šä¼ ç•Œé¢ï¼Œæ˜¾ç¤ºèŠå¤©ç•Œé¢
            const pdfUploadContainer = document.getElementById('pdf-upload-container');
            const chatMessages = document.getElementById('chat-messages');
            
            if (pdfUploadContainer) {
                pdfUploadContainer.classList.remove('active');
            }
            
            if (chatMessages) {
                chatMessages.style.display = 'flex';
            }
            
            // å…³é—­æœç´¢ç»“æœ
            closeSearch();
        }

        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
            // å…ˆå°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½
            const localHistory = loadHistoryFromLocalStorage();
            
            // æ¸…é™¤ç°æœ‰å†å²è®°å½•
            const historySection = document.querySelector('.history-section');
            historySection.innerHTML = '<h3>History</h3>';
            
            // æŒ‰æ—¶é—´åˆ†ç»„æ˜¾ç¤ºå†å²è®°å½•
            if (localHistory.today && localHistory.today.length > 0) {
                appendHistoryGroup(historySection, 'Today', localHistory.today);
            }
            if (localHistory.yesterday && localHistory.yesterday.length > 0) {
                appendHistoryGroup(historySection, 'Yesterday', localHistory.yesterday);
            }
            if (localHistory.older && localHistory.older.length > 0) {
                appendHistoryGroup(historySection, 'Earlier', localHistory.older);
            }
            
            // å¦‚æœæ²¡æœ‰å†å²è®°å½•
            if (!localHistory.today?.length && !localHistory.yesterday?.length && !localHistory.older?.length) {
                const emptyMsg = document.createElement('p');
                emptyMsg.style.color = '#8e8ea0';
                emptyMsg.style.textAlign = 'center';
                emptyMsg.style.marginTop = '20px';
                emptyMsg.textContent = 'No history records';
                historySection.appendChild(emptyMsg);
            }
            
            // åŠ è½½å½“å‰ä¼šè¯çš„æ¶ˆæ¯ï¼ˆä¼˜å…ˆä½¿ç”¨æœ¬åœ°å­˜å‚¨çš„å½“å‰ä¼šè¯ï¼‰
            const currentSessionId = localStorage.getItem('current_session_id');
            if (currentSessionId) {
                const history = JSON.parse(localStorage.getItem('chat_history')) || {};
                const currentSession = history[currentSessionId];
                if (currentSession && currentSession.messages) {
                    loadChatMessages(currentSession.messages);
                    return;
                }
            }
            
            // å›é€€ï¼šä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨ä¼šè¯
            const currentChat = localHistory.today?.[0] || localHistory.yesterday?.[0] || localHistory.older?.[0];
            if (currentChat) {
                loadChatMessages(currentChat.messages);
            }
        }
        
        // åŠ è½½èŠå¤©æ¶ˆæ¯
        function loadChatMessages(messages) {
            // æ¸…é™¤èŠå¤©æ¶ˆæ¯åŒºåŸŸ
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';
            
            // æ·»åŠ åˆå§‹åŠ©æ‰‹æ¶ˆæ¯ï¼ˆå¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼‰
            if (!messages || messages.length === 0) {
                // ä»…æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯ï¼Œä½†ä¸ä¿å­˜åˆ°å†å²è®°å½•
                addMessage('assistant', 'Hello! I am your intelligent research assistant. I can help you retrieve academic data, answer questions, or analyze PDF documents. What can I help you with today?', false);
                return;
            }
            
            // æ·»åŠ æ‰€æœ‰æ¶ˆæ¯ï¼Œä½†ä¸ä½¿ç”¨æ‰“å­—æ•ˆæœï¼ˆå› ä¸ºæ˜¯å†å²æ¶ˆæ¯ï¼‰
            messages.forEach(msg => {
                addMessage(msg.role, msg.content, false);
            });
        }
        
        // æ·»åŠ å†å²ç»„
        function appendHistoryGroup(container, title, chats) {
            const group = document.createElement('div');
            group.className = 'time-group';
            
            const timeLabel = document.createElement('div');
            timeLabel.className = 'time-label';
            timeLabel.textContent = title;
            group.appendChild(timeLabel);
            
            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.onclick = () => loadChat(chat.id);
                
                const chatTitle = document.createElement('div');
                chatTitle.className = 'chat-title';
                chatTitle.textContent = chat.title;
                
                const deleteBtn = document.createElement('span');
                deleteBtn.className = 'delete-chat';
                deleteBtn.textContent = 'Ã—';
                deleteBtn.onclick = (e) => deleteChat(e, chat.id);
                
                chatItem.appendChild(chatTitle);
                chatItem.appendChild(deleteBtn);
                group.appendChild(chatItem);
            });
            
            container.appendChild(group);
        }

        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // åœæ­¢ç”Ÿæˆ
        function stopGenerating() {
            if (controller) {
                controller.abort(); // ä¸­æ–­è¯·æ±‚
                controller = null;
            }
            
            hideTypingIndicator();
            
            // æ·»åŠ ä¸€æ¡æ¶ˆæ¯è¡¨ç¤ºç”Ÿæˆè¢«ä¸­æ–­
            const messagesContainer = document.getElementById('chat-messages');
            const lastMessage = messagesContainer.lastElementChild;
            
            if (lastMessage && lastMessage.classList.contains('assistant')) {
                const messageContent = lastMessage.querySelector('.message-content');
                messageContent.innerHTML += '<p class="generation-stopped">[ç”Ÿæˆå·²ä¸­æ–­]</p>';
            }
        }

        // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            isAssistantTyping = true;
            const messagesContainer = document.getElementById('chat-messages');
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            let typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
            
            typingIndicator = document.createElement('div');
            typingIndicator.className = 'message assistant';
            typingIndicator.id = 'typing-indicator';
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.innerHTML = '<span>AI</span>';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            const typingIndicatorDots = document.createElement('div');
            typingIndicatorDots.className = 'typing-indicator';
            
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('span');
                typingIndicatorDots.appendChild(dot);
            }
            
            messageContent.appendChild(typingIndicatorDots);
            typingIndicator.appendChild(avatar);
            typingIndicator.appendChild(messageContent);
            
            messagesContainer.appendChild(typingIndicator);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            scrollToBottom();
        }

        // éšè—æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
        function hideTypingIndicator() {
            isAssistantTyping = false;
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
            
            // æ¢å¤å‘é€æŒ‰é’®
            const sendButton = document.getElementById('send-button');
            sendButton.innerHTML = 'â†’';
            sendButton.title = 'å‘é€æ¶ˆæ¯';
            sendButton.classList.remove('sending');
        }

        // å¤„ç†æœç´¢ç»“æœé¡¹çš„é€‰æ‹©
        function toggleItemSelection(docId) {
            if (selectedItems.has(docId)) {
                selectedItems.delete(docId);
            } else {
                selectedItems.add(docId);
            }
            console.log("å·²é€‰æ‹©æ–‡æ¡£:", Array.from(selectedItems));
            
            // æ›´æ–°æ‰€æœ‰ç»“æœé¡¹çš„é€‰æ‹©çŠ¶æ€
            document.querySelectorAll('.search-result-item').forEach(item => {
                if (selectedItems.has(item.dataset.docId)) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
            
            // æ›´æ–°é€‰æ‹©è®¡æ•°
            updateSelectionCount();
        }

        // å¤„ç†PDFå®Œæˆ
        function handleProcessingComplete(result, isSearchMode = false) {
            try {
                console.log(`PDFå¤„ç†å®Œæˆï¼Œæœç´¢æ¨¡å¼: ${isSearchMode}`);
                
                // ç§»é™¤å¤„ç†ä¸­æ¶ˆæ¯
                const messagesContainer = document.getElementById('chat-messages');
                const processingMessage = messagesContainer.querySelector('.processing-message');
                if (processingMessage) {
                    const messageItem = processingMessage.closest('.message-item');
                    if (messageItem) {
                        messageItem.remove();
                    }
                }
                
                if (isSearchMode) {
                    // æœç´¢æ¨¡å¼ï¼šæ˜¾ç¤ºæœç´¢ç»“æœ
                    if (result && result.search_results && result.search_results.length > 0) {
                        // æ˜¾ç¤ºæœç´¢ç»“æœ
                        showSearchResults(result.search_results);
                        
                        // æ·»åŠ æ¶ˆæ¯é€šçŸ¥ç”¨æˆ·
                        const resultMsg = {
                            role: 'system',
                            content: `ğŸ“„ å·²æ‰¾åˆ° ${result.search_results.length} æ¡ä¸PDFç›¸å…³çš„æ–‡çŒ®ã€‚å·²åœ¨å³ä¾§æ˜¾ç¤ºæ£€ç´¢ç»“æœã€‚`,
                            timestamp: new Date().toISOString()
                        };
                        displayMessage(resultMsg);
                    } else {
                        // æœªæ‰¾åˆ°ç›¸å…³æ–‡çŒ®
                        const noResultMsg = {
                            role: 'system',
                            content: 'æœªæ‰¾åˆ°ä¸PDFç›¸å…³çš„æ–‡çŒ®ã€‚',
                            timestamp: new Date().toISOString()
                        };
                        displayMessage(noResultMsg);
                    }
                } else {
                    // èŠå¤©æ¨¡å¼ï¼šæ˜¾ç¤ºPDFæ‘˜è¦å’Œåˆ†æ
                    if (result && result.summary) {
                        // æ·»åŠ æ¶ˆæ¯æ˜¾ç¤ºPDFæ‘˜è¦
                        const summaryMessage = {
                            role: 'assistant',
                            content: data.summary,
                            timestamp: new Date().toISOString()
                        };
                        
                        displayMessage(summaryMessage);
                        addToHistory(summaryMessage);
                    } else {
                        // æ²¡æœ‰æ‘˜è¦ï¼Œæ˜¾ç¤ºç®€å•æ¶ˆæ¯
                        const message = {
                            role: 'assistant',
                            content: `PDFæ–‡ä»¶ ${selectedFile ? selectedFile.name : ''} å·²å¤„ç†å®Œæˆã€‚æ‚¨å¯ä»¥è¯¢é—®å…³äºè¯¥æ–‡æ¡£çš„ä»»ä½•é—®é¢˜ã€‚`,
                            timestamp: new Date().toISOString()
                        };
                        
                        displayMessage(message);
                        addToHistory(message);
                    }
                }
                
                // é‡ç½®PDFä¸Šä¼ ç•Œé¢
                selectedFile = null;
            } catch (error) {
                console.error('å¤„ç†PDFå®Œæˆå›è°ƒæ—¶å‡ºé”™:', error);
                
                const errorMsg = {
                    role: 'system',
                    content: `<div class="error-message">æ˜¾ç¤ºPDFå¤„ç†ç»“æœæ—¶å‡ºé”™: ${error.message}</div>`,
                    timestamp: new Date().toISOString()
                };
                displayMessage(errorMsg);
            }
        }

        // ç”¨äºå¡«å……å·¥å…·åˆ—è¡¨
        function populateTools(tools) {
            try {
                const toolsList = document.querySelector('.tools-list');
                
                if (!toolsList) {
                    console.error('æ‰¾ä¸åˆ°å·¥å…·åˆ—è¡¨å…ƒç´ ');
                        return;
                    }
                    
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨"æ–°å»ºå¯¹è¯"æŒ‰é’®
                let newChatButton = null;
                const existingNewChatBtn = document.querySelector('.new-chat-btn');
                if (existingNewChatBtn) {
                    // æš‚æ—¶ç§»é™¤ï¼Œç¨åé‡æ–°æ·»åŠ åˆ°æœ€å
                    newChatButton = existingNewChatBtn;
                    existingNewChatBtn.remove();
                }
                
                // æ¸…ç©ºå·¥å…·åˆ—è¡¨
                toolsList.innerHTML = '';
                
                // æ·»åŠ å·¥å…·ï¼Œè¿‡æ»¤æ‰PDFå·¥å…·
                tools.forEach(tool => {
                    // è·³è¿‡PDFå·¥å…·
                    if (tool.id === 'pdf') return;
                    
                    const toolItem = document.createElement('div');
                    toolItem.className = 'tool-item';
                    toolItem.id = `${tool.id}-tool`;
                    toolItem.onclick = () => selectTool(toolItem, tool.id);
                    
                    if (tool.id === currentTool) {
                        toolItem.classList.add('active');
                    }
                    
                    // ç¡®å®šåˆé€‚çš„å›¾æ ‡è¡¨æƒ…ç¬¦å·ï¼Œä¸ä½¿ç”¨å·¥å…·è‡ªå¸¦çš„icon
                    let iconEmoji = 'ğŸ”§'; // é»˜è®¤å›¾æ ‡
                    if (tool.id === 'chat') iconEmoji = 'ğŸ’¬';
                    if (tool.id === 'search') iconEmoji = 'ğŸ”';
                    
                    // åˆ›å»ºå·¥å…·å›¾æ ‡å’Œæ–‡æœ¬ï¼Œé¿å…é‡å¤
                    toolItem.innerHTML = `
                        <span class="tool-icon">${iconEmoji}</span>
                        <span>${tool.name}</span>
                    `;
                    
                    toolsList.appendChild(toolItem);
                });
                
                // æ”¾å›"æ–°å»ºå¯¹è¯"æŒ‰é’®æˆ–åˆ›å»ºæ–°çš„
                if (newChatButton) {
                    // é‡ç”¨å·²å­˜åœ¨çš„æŒ‰é’®
                    toolsList.parentElement.appendChild(newChatButton);
            } else {
                    // åˆ›å»ºæ–°æŒ‰é’®
                    const newChatBtn = document.createElement('button');
                    newChatBtn.className = 'new-chat-btn';
                    newChatBtn.onclick = createNewChat;
                    newChatBtn.innerHTML = '<span>New Chat</span>';
                    
                    const toolsSection = document.querySelector('.tools-section');
                    if (toolsSection) {
                        toolsSection.appendChild(newChatBtn);
                    }
                }
                
                console.log('å·¥å…·åˆ—è¡¨å·²æ›´æ–°ï¼ˆå·²è¿‡æ»¤PDFå·¥å…·ï¼‰');
            } catch (error) {
                console.error('å¡«å……å·¥å…·åˆ—è¡¨æ—¶å‡ºé”™:', error);
            }
        }

        // æ›´æ–°åº”ç”¨è¿‡æ»¤å™¨å‡½æ•°
        function applyFilters() {
            // å›ºå®šä½¿ç”¨jinaé‡æ’åº
            const searchMethod = 'jina';  // å›ºå®šä½¿ç”¨jinaé‡æ’åº
            
            console.log(`åº”ç”¨æ£€ç´¢æ–¹æ³•: ${searchMethod}`);
            
            // è·å–å½“å‰è¾“å…¥æ¡†ä¸­çš„å†…å®¹æˆ–æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
            let query = '';
            const input = document.getElementById('chat-input');
            if (input && input.value.trim()) {
                query = input.value.trim();
            } else if (chatHistory && chatHistory.length > 0) {
                // è·å–æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
                for (let i = chatHistory.length - 1; i >= 0; i--) {
                    if (chatHistory[i].role === 'user') {
                        query = chatHistory[i].content;
                        break;
                    }
                }
            }
            
            if (!query) {
                console.log('æ²¡æœ‰å¯ç”¨çš„æŸ¥è¯¢å†…å®¹ï¼Œæ— æ³•æ‰§è¡Œæ£€ç´¢');
                alert('è¯·å…ˆè¾“å…¥ä¸€æ¡æ¶ˆæ¯æˆ–é€‰æ‹©ä¸€ä¸ªå†å²æŸ¥è¯¢');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const searchItems = document.getElementById('search-results');
            if (searchItems) {
                searchItems.innerHTML = '<div class="loading-results">æ­£åœ¨æ£€ç´¢ä¸­...</div>';
                // ç¡®ä¿æœç´¢é¢æ¿å¯è§
                document.getElementById('search-panel').classList.add('visible');
                document.body.classList.add('search-active');
            }
            
            // å‡†å¤‡è¯·æ±‚æ•°æ®
            const requestData = {
                query: query,
                search_method: searchMethod,
                session_id: get_or_create_session_id(),
                limit: 50  // å¢åŠ è¿”å›ç»“æœæ•°é‡
            };
            
            console.log("å‘é€æ£€ç´¢è¯·æ±‚:", requestData);
            
            // å‘é€è¯·æ±‚
            fetch(API.SEARCH, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`æ£€ç´¢è¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("æ£€ç´¢å“åº”:", data);
                
                // å¤„ç†å“åº”ç»“æœ
                if (data.results && data.results.length > 0) {
                    showSearchResults(data.results);
                } else if (data.search_results && data.search_results.length > 0) {
                    showSearchResults(data.search_results);
                } else if (data.references && data.references.length > 0) {
                    showSearchResults(data.references);
                } else {
                    // æ²¡æœ‰ç»“æœ
                    showSearchResults([]);
                }
            })
            .catch(error => {
                console.error('æ£€ç´¢è¯·æ±‚å‡ºé”™:', error);
                
                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                if (searchItems) {
                    searchItems.innerHTML = `<div class="error-results">æ£€ç´¢å‡ºé”™: ${error.message}</div>`;
                }
            });
        }

        // ä¿®æ”¹æ·»åŠ æ£€ç´¢æ–¹æ³•åˆ‡æ¢äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            // ç”±äºå·²åˆ é™¤æ’åºä¸‹æ‹‰æ¡†ï¼Œä¸å†éœ€è¦ç›¸å…³äº‹ä»¶ç›‘å¬
            console.log("åˆå§‹åŒ–æ£€ç´¢ï¼Œå›ºå®šä½¿ç”¨å‘é‡+Jinaé‡æ’åº");
        });

        // æ·»åŠ åœ¨è„šæœ¬å¼€å§‹å¤„
        // æœ¬åœ°å­˜å‚¨é”®å
        const STORAGE_KEYS = {
            CHAT_HISTORY: 'rag_mcp_chat_history',
            SEARCH_RESULTS: 'rag_mcp_search_results',
            SESSION_ID: 'rag_mcp_session_id'
        };

        // ä¿å­˜èŠå¤©å†å²åˆ°æœ¬åœ°å­˜å‚¨
        function saveHistoryToStorage(history) {
            try {
                localStorage.setItem(STORAGE_KEYS.CHAT_HISTORY, JSON.stringify(history));
            } catch (e) {
                console.error('ä¿å­˜èŠå¤©å†å²åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨æ¢å¤èŠå¤©å†å²
        function loadHistoryFromStorage() {
            try {
                const storedHistory = localStorage.getItem(STORAGE_KEYS.CHAT_HISTORY);
                return storedHistory ? JSON.parse(storedHistory) : [];
            } catch (e) {
                console.error('ä»æœ¬åœ°å­˜å‚¨åŠ è½½èŠå¤©å†å²å¤±è´¥:', e);
                return [];
            }
        }

        // ä¿å­˜æœç´¢ç»“æœåˆ°æœ¬åœ°å­˜å‚¨
        function saveSearchResultsToStorage(results) {
            try {
                localStorage.setItem(STORAGE_KEYS.SEARCH_RESULTS, JSON.stringify(results));
            } catch (e) {
                console.error('ä¿å­˜æœç´¢ç»“æœåˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨æ¢å¤æœç´¢ç»“æœ
        function loadSearchResultsFromStorage() {
            try {
                const storedResults = localStorage.getItem(STORAGE_KEYS.SEARCH_RESULTS);
                return storedResults ? JSON.parse(storedResults) : [];
            } catch (e) {
                console.error('ä»æœ¬åœ°å­˜å‚¨åŠ è½½æœç´¢ç»“æœå¤±è´¥:', e);
                return [];
            }
        }

        // è·å–æˆ–åˆ›å»ºä¼šè¯ID
        function get_or_create_session_id() {
            let sessionId = localStorage.getItem(STORAGE_KEYS.SESSION_ID);
            if (!sessionId) {
                sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substring(2, 10);
                localStorage.setItem(STORAGE_KEYS.SESSION_ID, sessionId);
            }
            return sessionId;
        }
        
        // ... ç°æœ‰ä»£ç  ...

        // ä¿®æ”¹addToHistoryå‡½æ•°
        function addToHistory(message) {
            chatHistory.push(message);
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveHistoryToStorage(chatHistory);
        }

        // ... ç°æœ‰ä»£ç  ...

        // ä¿®æ”¹showSearchResultså‡½æ•°
        function showSearchResults(results) {
            try {
                console.log("æ˜¾ç¤ºæœç´¢ç»“æœ:", results);
                
                // ä¿å­˜æœç´¢ç»“æœåˆ°æœ¬åœ°å­˜å‚¨
                if (results && results.length > 0) {
                    saveSearchResultsToStorage(results);
                }
                
                // é«˜äº®æœç´¢å·¥å…·é€‰æ‹©
                const searchTool = document.querySelector('[data-tool="search"]');
                if (searchTool) {
                    searchTool.classList.add('selected');
                }
                
                // ä¿®æ”¹è¿™éƒ¨åˆ†ï¼Œä½¿æœç´¢ç»“æœå¹¶æ’æ˜¾ç¤º
                const searchPanel = document.getElementById('search-panel');
                const resultsContainer = document.getElementById('search-results');
                
                // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
                resultsContainer.innerHTML = '';
                
                // å¤„ç†æ²¡æœ‰ç»“æœçš„æƒ…å†µ
            if (!results || results.length === 0) {
                    searchPanel.classList.add('visible');
                    resultsContainer.innerHTML = '<div class="no-results">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ç»“æœ</div>';
                    document.body.classList.add('search-active'); // æ·»åŠ è¿™è¡Œæ¥æ¿€æ´»å¹¶æ’å¸ƒå±€
                return;
            }
            
                // å¤„ç†ç»“æœ
                searchPanel.classList.add('visible');
                document.body.classList.add('search-active'); // æ·»åŠ è¿™è¡Œæ¥æ¿€æ´»å¹¶æ’å¸ƒå±€
                
                // æ˜¾ç¤ºç»“æœæ•°é‡
                const resultCountHeader = document.createElement('div');
                resultCountHeader.className = 'result-count';
                resultCountHeader.textContent = `æ‰¾åˆ° ${results.length} æ¡ç»“æœ`;
                resultsContainer.appendChild(resultCountHeader);
                
                // éå†ç»“æœå¹¶æ˜¾ç¤º
                results.forEach((result, index) => {
                    try {
                        // è·å–æ–‡æ¡£ID (ç¡®ä¿å…¼å®¹ä¸åŒæ ¼å¼)
                        const docId = result.document_id || result.doc_id || result.id || `doc_${index}`;
                        
                        // åˆ›å»ºç»“æœé¡¹
                        const resultItem = document.createElement('div');
                        resultItem.className = 'search-result-item';
                        resultItem.dataset.docId = docId;
                        
                        // æ·»åŠ é€‰æ‹©æ¡†
                const checkboxContainer = document.createElement('div');
                        checkboxContainer.className = 'search-result-checkbox-container';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                        checkbox.className = 'search-result-checkbox';
                        checkbox.dataset.docId = docId;
                        
                        // æ£€æŸ¥æ˜¯å¦å·²è¢«é€‰ä¸­
                        if (selectedItems.has(docId)) {
                            checkbox.checked = true;
                            resultItem.classList.add('selected');
                        }
                        
                        // æ·»åŠ é€‰æ‹©æ¡†çš„äº‹ä»¶å¤„ç†
                        checkbox.addEventListener('change', function(e) {
                            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                            toggleItemSelection(docId);
                            if (this.checked) {
                                resultItem.classList.add('selected');
                            } else {
                                resultItem.classList.remove('selected');
                            }
                });
                
                checkboxContainer.appendChild(checkbox);
                        resultItem.appendChild(checkboxContainer);
                        
                        // åˆ›å»ºå†…å®¹å®¹å™¨
                        const contentContainer = document.createElement('div');
                        contentContainer.className = 'search-result-content-container';
                        
                        // åˆ›å»ºç»“æœå¤´éƒ¨ (æ ‡é¢˜å’Œç›¸å…³åº¦)
                        const resultHeader = document.createElement('div');
                        resultHeader.className = 'search-result-header';
                        
                        // æ·»åŠ æ ‡é¢˜
                        const resultTitle = document.createElement('div');
                        resultTitle.className = 'search-result-title';
                        resultTitle.textContent = result.title || `æ–‡æ¡£ ${docId}`;
                        resultHeader.appendChild(resultTitle);
                        
                        // æ·»åŠ ç›¸å…³æ€§åˆ†æ•°
                        if (result.score !== undefined || result.relevance_score !== undefined) {
                            const score = result.score !== undefined ? result.score : result.relevance_score;
                            const resultScore = document.createElement('div');
                            resultScore.className = 'search-result-score';
                            resultScore.textContent = `${parseFloat(score).toFixed(2)}`;
                            resultHeader.appendChild(resultScore);
                        }
                        
                        contentContainer.appendChild(resultHeader);
                        
                        // æ·»åŠ ä½œè€…ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
                        if (result.authors && result.authors.length > 0) {
                            const authorsElem = document.createElement('div');
                            authorsElem.className = 'search-result-authors';
                            authorsElem.textContent = Array.isArray(result.authors) ? result.authors.join(', ') : result.authors;
                            contentContainer.appendChild(authorsElem);
                        }
                        
                        // æ·»åŠ å¹´ä»½ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
                        if (result.year) {
                            const yearElem = document.createElement('div');
                            yearElem.className = 'search-result-year';
                            yearElem.textContent = `å‘å¸ƒå¹´ä»½: ${result.year}`;
                            yearElem.style.fontSize = '0.9em';
                            yearElem.style.color = '#5f6368';
                            yearElem.style.marginBottom = '5px';
                            contentContainer.appendChild(yearElem);
                        }
                        
                        // æ·»åŠ å†…å®¹æ‘˜è¦ - æŒ‰ç…§ä¼˜å…ˆçº§ä½¿ç”¨ä¸åŒå­—æ®µ
                        const contentElem = document.createElement('div');
                        contentElem.className = 'search-result-content';
                        
                        // å†…å®¹ä¼˜å…ˆçº§: snippet > abstract > text
                        let content = 'æ— å¯ç”¨å†…å®¹';
                        if (result.snippet && result.snippet.trim()) {
                            content = result.snippet;
                        } else if (result.abstract && result.abstract.trim()) {
                            content = result.abstract;
                        } else if (result.text && result.text.trim()) {
                            // åªå–å‰300ä¸ªå­—ç¬¦ä½œä¸ºæ‘˜è¦
                            content = result.text.substring(0, 300) + (result.text.length > 300 ? '...' : '');
                        }
                        
                        contentElem.textContent = content;
                        contentContainer.appendChild(contentElem);
                        
                        resultItem.appendChild(contentContainer);
                        
                        // ç§»é™¤åŸæ¥çš„ç‚¹å‡»äº‹ä»¶ï¼Œæ”¹ä¸ºç‚¹å‡»é€‰æ‹©æ¡†
                        resultItem.addEventListener('click', function(e) {
                            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯é€‰æ‹©æ¡†æœ¬èº«ï¼Œåˆ™è§¦å‘é€‰æ‹©æ¡†çš„ç‚¹å‡»
                            if (!e.target.classList.contains('search-result-checkbox')) {
                                const cb = this.querySelector('.search-result-checkbox');
                                cb.checked = !cb.checked;
                                // è§¦å‘changeäº‹ä»¶
                                const event = new Event('change');
                                cb.dispatchEvent(event);
                            }
                        });
                        
                        resultsContainer.appendChild(resultItem);
                    } catch (itemError) {
                        console.error(`å¤„ç†æœç´¢ç»“æœé¡¹ ${index} æ—¶å‡ºé”™:`, itemError);
                    }
                });
                
                // ç¡®ä¿æœç´¢é¢æ¿å¯è§
                searchPanel.classList.add('visible');
                
                // æ›´æ–°é€‰æ‹©è®¡æ•°
                updateSelectionCount();
            } catch (error) {
                console.error("æ˜¾ç¤ºæœç´¢ç»“æœæ—¶å‡ºé”™:", error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ¢å¤æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            // æ¢å¤èŠå¤©å†å²
            chatHistory = loadHistoryFromStorage();
            if (chatHistory && chatHistory.length > 0) {
                // æœ‰å†å²æ¶ˆæ¯ï¼Œç§»é™¤æ–°èŠå¤©æ ·å¼
                const chatMessages = document.getElementById('chat-messages');
                const inputContainer = document.getElementById('chat-input-container');
                
                if (chatMessages.classList.contains('new-chat')) {
                    chatMessages.classList.remove('new-chat');
                    inputContainer.classList.remove('centered');
                    
                    const promptElement = document.querySelector('.centered-prompt');
                    if (promptElement) {
                        promptElement.remove();
                    }
                }
                
                // æ˜¾ç¤ºæ‰€æœ‰å†å²æ¶ˆæ¯
                chatHistory.forEach(message => {
                    displayMessage(message);
                });
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            // æ¢å¤æœç´¢ç»“æœ
            const savedResults = loadSearchResultsFromStorage();
            if (savedResults && savedResults.length > 0) {
                showSearchResults(savedResults);
            }
            
            // åˆå§‹åŒ–ä¼šè¯ID
            get_or_create_session_id();
            
            // æ£€æŸ¥APIå¥åº·çŠ¶æ€
            checkApiHealth();
        });

        // æ·»åŠ æ–°èŠå¤©æŒ‰é’®åŠŸèƒ½
        document.getElementById('new-chat-button').addEventListener('click', function() {
            // æ¸…ç©ºèŠå¤©å†å²
            chatHistory = [];
            saveHistoryToStorage(chatHistory);
            
            // æ¸…ç©ºæœç´¢ç»“æœ
            clearSearchResults();
            saveSearchResultsToStorage([]);
            
            // æ¸…ç©ºé€‰æ‹©çš„æ–‡æ¡£
            selectedItems.clear();
            
            // åˆ·æ–°é¡µé¢
            location.reload();
        });

        // æ¸…ç©ºæœç´¢ç»“æœçš„è¾…åŠ©å‡½æ•°
        function clearSearchResults() {
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';
            document.getElementById('search-panel').classList.remove('visible');
        }

        // æ›´æ–°é€‰æ‹©è®¡æ•°
        function updateSelectionCount() {
            const countElem = document.getElementById('selection-count');
            const addButton = document.getElementById('add-selected');
            
            if (countElem && addButton) {
            const count = selectedItems.size;
                countElem.textContent = `å·²é€‰æ‹© ${count} é¡¹`;
                
                // å¯ç”¨/ç¦ç”¨æ·»åŠ æŒ‰é’®
                addButton.disabled = count === 0;
            }
        }
        
        // æ·»åŠ é€‰ä¸­çš„é¡¹ç›®åˆ°å¯¹è¯
        function addSelectedToChat() {
            // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„é¡¹ç›®ï¼Œç›´æ¥è¿”å›
            if (selectedItems.size === 0) {
                return;
            }
            
            // è·å–é€‰ä¸­é¡¹çš„æ•°é‡
            const count = selectedItems.size;
            
            // è·å–é€‰ä¸­é¡¹çš„ID
            const selectedDocs = Array.from(selectedItems);
            
            // ç”Ÿæˆç®€æ´çš„å‘½ä»¤æ ¼å¼
            let selectedIndices = [];
            document.querySelectorAll('.search-result-item').forEach((item, index) => {
                if (selectedItems.has(item.dataset.docId)) {
                    selectedIndices.push(index + 1); // æ·»åŠ 1æ˜¯å› ä¸ºç”¨æˆ·ç•Œé¢ä»1å¼€å§‹è®¡æ•°
                }
            });
            
            // æ ¼å¼åŒ–é€‰æ‹©å‘½ä»¤
            let commandText = "";
            if (selectedIndices.length > 0) {
                // å¯»æ‰¾è¿ç»­çš„åºå·åŒºé—´
                selectedIndices.sort((a, b) => a - b);
                let ranges = [];
                let start = selectedIndices[0];
                let end = start;
                
                for (let i = 1; i < selectedIndices.length; i++) {
                    if (selectedIndices[i] === end + 1) {
                        end = selectedIndices[i];
                    } else {
                        ranges.push(start === end ? `${start}` : `${start}-${end}`);
                        start = end = selectedIndices[i];
                    }
                }
                ranges.push(start === end ? `${start}` : `${start}-${end}`);
                
                // æ„å»ºå‘½ä»¤æ–‡æœ¬
                commandText = `select${ranges.join(',')}å…±${count}ç¯‡`;
            } else {
                commandText = `selectå…±${count}ç¯‡`;
            }
            
            // åˆ›å»ºç”¨æˆ·æ¶ˆæ¯
            const referenceCommand = {
                role: 'user',
                content: commandText,
                timestamp: new Date().toISOString()
            };
            
            // æ˜¾ç¤ºæ¶ˆæ¯
            displayMessage(referenceCommand);
            
            // æ·»åŠ åˆ°å†å²è®°å½•
            addToHistory(referenceCommand);
            
            // ä¿å­˜é€‰æ‹©çš„æ–‡æ¡£IDåˆ°localStorageï¼Œåœ¨ä¸‹ä¸€æ¬¡å‘é€æ¶ˆæ¯æ—¶å¯ä»¥ä½¿ç”¨
            localStorage.setItem('rag_mcp_selected_docs', JSON.stringify(selectedDocs));
            console.log("å·²ä¿å­˜é€‰æ‹©çš„æ–‡æ¡£IDs:", selectedDocs);
            
            // è‡ªåŠ¨å‘é€è¿™ä¸ªå‘½ä»¤
            sendSelectedDocsMessage(commandText, selectedDocs);
            
            // é‡è¦ï¼šä¸æ¸…ç©ºé€‰æ‹©å’Œä¸å…³é—­æœç´¢é¢æ¿
            // åªæ›´æ–°æŒ‰é’®çŠ¶æ€ï¼Œé¿å…é‡å¤å‘é€
            const addButton = document.getElementById('add-selected');
            if (addButton) {
                // æš‚æ—¶ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
                addButton.disabled = true;
                addButton.textContent = 'å·²æ·»åŠ åˆ°å¯¹è¯';
                
                // 3ç§’åæ¢å¤æŒ‰é’®
                setTimeout(() => {
                    addButton.disabled = false;
                    addButton.textContent = 'æ·»åŠ åˆ°å¯¹è¯';
                }, 3000);
            }
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            const successMessage = document.createElement('div');
            successMessage.className = 'result-count success-message';
            successMessage.textContent = `æˆåŠŸæ·»åŠ  ${count} é¡¹åˆ°å¯¹è¯`;
            successMessage.style.backgroundColor = '#e6f7f1';
            successMessage.style.color = '#10a37f';
            
            // å°†æˆåŠŸæ¶ˆæ¯æ·»åŠ åˆ°ç»“æœå®¹å™¨çš„é¡¶éƒ¨
            const resultsContainer = document.getElementById('search-results');
            if (resultsContainer.firstChild) {
                resultsContainer.insertBefore(successMessage, resultsContainer.firstChild);
            } else {
                resultsContainer.appendChild(successMessage);
            }
            
            // 3ç§’åç§»é™¤æˆåŠŸæ¶ˆæ¯
            setTimeout(() => {
                successMessage.remove();
            }, 3000);
            
            // å°†ç„¦ç‚¹ç§»è‡³è¾“å…¥æ¡†
            document.getElementById('chat-input').focus();
        }

        // æ–°å¢å‡½æ•°ï¼šä¸“é—¨å¤„ç†é€‰æ‹©æ–‡æ¡£çš„æ¶ˆæ¯å‘é€
        function sendSelectedDocsMessage(commandText, selectedDocs) {
            // æ˜¾ç¤ºåŠ©æ‰‹æ­£åœ¨è¾“å…¥
            showTypingIndicator();
            
            // å¦‚æœAPIä¸å¯ç”¨ï¼Œæ˜¾ç¤ºç¦»çº¿æ¨¡å¼æ¶ˆæ¯
            if (!apiAvailable) {
                setTimeout(() => {
                    hideTypingIndicator();
                    
                    const offlineMessage = {
                        role: 'assistant',
                        content: `æœåŠ¡å™¨è¿æ¥æš‚æ—¶ä¸å¯ç”¨ã€‚æ‚¨çš„å‚è€ƒæ–‡çŒ®é€‰æ‹©å·²ä¿å­˜ï¼Œå°†åœ¨è¿æ¥æ¢å¤åå¤„ç†ã€‚`,
                        timestamp: new Date().toISOString(),
                        offline: true
                    };
                    
                    displayMessage(offlineMessage);
                    addToHistory(offlineMessage);
                    
                    // å°è¯•å†æ¬¡æ£€æŸ¥APIå¥åº·çŠ¶æ€
                    checkApiHealth();
                }, 1500);
                return;
            }
            
            // ä¸­æ–­ä¹‹å‰çš„è¯·æ±‚ï¼ˆå¦‚æœæœ‰ï¼‰
            if (controller) {
                controller.abort();
            }
            
            // åˆ›å»ºæ–°çš„AbortController
            controller = new AbortController();
            
            // å‡†å¤‡å‘é€æ•°æ®
            const requestData = {
                query: commandText,
                session_id: get_or_create_session_id(),
                selected_docs: selectedDocs,
                is_reference_selection: true  // ç‰¹æ®Šæ ‡è®°ï¼Œè¡¨æ˜è¿™æ˜¯æ–‡çŒ®é€‰æ‹©å‘½ä»¤
            };
            
            console.log("å‘é€å‚è€ƒæ–‡çŒ®å¤„ç†è¯·æ±‚:", requestData);
            
            // å‘é€è¯·æ±‚
            fetch(API.PROCESS, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData),
                signal: controller.signal
            })
            .then(response => {
                console.log("APIå“åº”çŠ¶æ€:", response.status);
                
                if (!response.ok) {
                    throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("å‚è€ƒæ–‡çŒ®å¤„ç†å“åº”:", data);
                hideTypingIndicator();
                
                // å¤„ç†å“åº”
                if (data.response) {
                    const assistantMessage = {
                        role: 'assistant',
                        content: data.response,
                        timestamp: new Date().toISOString()
                    };
                    
                    displayMessage(assistantMessage);
                    addToHistory(assistantMessage);
                } else {
                    console.error("APIå“åº”ä¸­æ²¡æœ‰æ‰¾åˆ°å›ç­”");
                    const confirmMessage = {
                        role: 'assistant',
                        content: `å·²é€‰æ‹© ${selectedDocs.length} ç¯‡å‚è€ƒæ–‡çŒ®ã€‚è¯·ç»§ç»­è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œæˆ‘å°†åŸºäºè¿™äº›æ–‡çŒ®ä¸ºæ‚¨è§£ç­”ã€‚`,
                        timestamp: new Date().toISOString()
                    };
                    
                    displayMessage(confirmMessage);
                    addToHistory(confirmMessage);
                }
            })
            .catch(error => {
                // ä»…å¤„ç†éä¸­æ–­é”™è¯¯
                if (error.name !== 'AbortError') {
                    console.error('å¤„ç†å‚è€ƒæ–‡çŒ®æ—¶å‡ºé”™:', error);
                    hideTypingIndicator();
                    
                    // åˆ›å»ºé”™è¯¯æ¶ˆæ¯
                    const errorMessage = {
                        role: 'assistant',
                        content: `å¤„ç†å‚è€ƒæ–‡çŒ®æ—¶å‡ºç°é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚(é”™è¯¯: ${error.message})`,
                        timestamp: new Date().toISOString(),
                        error: true
                    };
                    
                    displayMessage(errorMessage);
                    addToHistory(errorMessage);
                    
                    // æ ‡è®°APIå¯èƒ½ä¸å¯ç”¨
                    apiAvailable = false;
                    checkApiHealth(); // ç«‹å³æ‰§è¡Œå¥åº·æ£€æŸ¥
                } else {
                    console.log('è¯·æ±‚å·²ä¸­æ–­');
                }
            });
        }

        // ä¿®æ”¹closeSearchå‡½æ•°ï¼Œå…³é—­æœç´¢é¢æ¿å¹¶ä¿å­˜å½“å‰æ£€ç´¢ç»“æœ
        function closeSearch() {
            const searchPanel = document.getElementById('search-panel');
            searchPanel.classList.remove('visible');
            document.body.classList.remove('search-active');
            
            // ä¿å­˜å½“å‰æ£€ç´¢ç»“æœä»¥ä¾¿åç»­æ¢å¤
            const currentSearchResults = loadSearchResultsFromStorage();
            if (currentSearchResults && currentSearchResults.length > 0) {
                // ä¿å­˜åˆ°ä¸€ä¸ªä¸“é—¨çš„å­˜å‚¨é”®ä¸­
                localStorage.setItem('rag_mcp_last_search_results', JSON.stringify(currentSearchResults));
                
                // æ·»åŠ æ¢å¤æ£€ç´¢ç»“æœçš„æŒ‰é’®
                addRestoreSearchButton();
            }
        }
        
        // æ·»åŠ æ¢å¤æ£€ç´¢ç»“æœæŒ‰é’®
        function addRestoreSearchButton() {
            // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨æ¢å¤æŒ‰é’®
            let restoreButton = document.getElementById('restore-search-button');
            if (!restoreButton) {
                restoreButton = document.createElement('button');
                restoreButton.id = 'restore-search-button';
                restoreButton.className = 'restore-search-button';
                restoreButton.innerHTML = '<span class="material-icons">search</span> æ¢å¤æ£€ç´¢ç»“æœ';
                restoreButton.title = 'æ¢å¤ä¹‹å‰çš„æ£€ç´¢ç»“æœ';
                restoreButton.onclick = restoreSearchResults;
                
                // æ·»åŠ åˆ°body
                document.body.appendChild(restoreButton);
            }
        }
        
        // æ¢å¤æ£€ç´¢ç»“æœ
        function restoreSearchResults() {
            const lastSearchResults = localStorage.getItem('rag_mcp_last_search_results');
            if (lastSearchResults) {
                try {
                    const results = JSON.parse(lastSearchResults);
                    if (results && results.length > 0) {
                        console.log("æ¢å¤ä¹‹å‰çš„æ£€ç´¢ç»“æœ:", results.length);
                        // æ˜¾ç¤ºæ£€ç´¢ç»“æœ
                        showSearchResults(results);
                        
                        // ç§»é™¤æ¢å¤æŒ‰é’®
                        const restoreButton = document.getElementById('restore-search-button');
                        if (restoreButton) {
                            restoreButton.remove();
                        }
                        return;
                    }
                } catch (e) {
                    console.error("è§£æä¿å­˜çš„æ£€ç´¢ç»“æœå‡ºé”™:", e);
                }
            }
            
            console.log("æ²¡æœ‰æ‰¾åˆ°ä¹‹å‰çš„æ£€ç´¢ç»“æœ");
            alert("æ²¡æœ‰æ‰¾åˆ°ä¹‹å‰çš„æ£€ç´¢ç»“æœ");
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šæ¬¡çš„æ£€ç´¢ç»“æœ
        document.addEventListener('DOMContentLoaded', function() {
            const lastSearchResults = localStorage.getItem('rag_mcp_last_search_results');
            if (lastSearchResults) {
                try {
                    const results = JSON.parse(lastSearchResults);
                    if (results && results.length > 0) {
                        // æ·»åŠ æ¢å¤æŒ‰é’®
                        addRestoreSearchButton();
                    }
                } catch (e) {
                    console.error("æ£€æŸ¥ä¿å­˜çš„æ£€ç´¢ç»“æœæ—¶å‡ºé”™:", e);
                }
            }
        });
        
        // åˆ›å»ºæ–°å¯¹è¯
        function createNewChat() {
            try {
                // æ¸…ç©ºå½“å‰èŠå¤©UI
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = '';
                
                // æ˜¾ç¤ºåŠ è½½æ¶ˆæ¯
                const loadingMessage = document.createElement('div');
                loadingMessage.className = 'message system';
                loadingMessage.innerHTML = '<div class="message-content">æ­£åœ¨åˆ›å»ºæ–°å¯¹è¯...</div>';
                chatMessages.appendChild(loadingMessage);
                
                // è°ƒç”¨APIåˆ›å»ºæ–°ä¼šè¯
                fetch(API.PROCESS.replace('process', 'new_chat'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`åˆ›å»ºæ–°ä¼šè¯å¤±è´¥: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('åˆ›å»ºäº†æ–°ä¼šè¯:', data);
                    
                    // ä¿å­˜æ–°çš„ä¼šè¯ID
                    if (data.session_id) {
                        localStorage.setItem('session_id', data.session_id);
                    }
                    
                    // æ¸…ç©ºå½“å‰èŠå¤©å†å²
                    chatHistory = [];
                    saveHistoryToStorage(chatHistory);
                    
                    // é‡ç½®é€‰ä¸­çš„æ–‡æ¡£
                    selectedItems.clear();
                    
                    // æ¸…ç©ºæœç´¢ç»“æœ
                    clearSearchResults();
                    saveSearchResultsToStorage([]);
                    
                    // æ¸…é™¤æ‰€æœ‰ä¿å­˜çš„æ–‡æ¡£é€‰æ‹©
                    localStorage.removeItem('rag_mcp_selected_docs');
                    
                    // è®¾ç½®æ–°å¯¹è¯æ ‡å¿—
                    localStorage.setItem('is_new_chat', 'true');
                    
                    // ç§»é™¤åŠ è½½æ¶ˆæ¯
                    loadingMessage.remove();
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    const successMessage = document.createElement('div');
                    successMessage.className = 'message system';
                    successMessage.innerHTML = '<div class="message-content">å·²åˆ›å»ºæ–°å¯¹è¯ï¼Œæ‰€æœ‰å†å²è®°å½•å’Œé€‰æ‹©å·²æ¸…é™¤ã€‚</div>';
                    chatMessages.appendChild(successMessage);
                    
                    // 3ç§’åè‡ªåŠ¨ç§»é™¤çŠ¶æ€æ¶ˆæ¯
                    setTimeout(() => {
                        successMessage.remove();
                    }, 3000);
                    
                    // ç„¦ç‚¹æ”¾åœ¨è¾“å…¥æ¡†ä¸Š
                    const chatInput = document.getElementById('chat-input');
                    chatInput.focus();
                    
                    // é‡ç½®æœç´¢ç»“æœ
                    if (isSearchActive) {
                        document.getElementById('search-results').innerHTML = '';
                        closeSearch();
                    }
                })
                .catch(error => {
                    console.error('åˆ›å»ºæ–°ä¼šè¯æ—¶å‡ºé”™:', error);
                    
                    // ç§»é™¤åŠ è½½æ¶ˆæ¯
                    loadingMessage.remove();
                    
                    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'message system error';
                    errorMessage.innerHTML = `<div class="message-content">åˆ›å»ºæ–°å¯¹è¯å¤±è´¥: ${error.message}</div>`;
                    chatMessages.appendChild(errorMessage);
                    
                    // 5ç§’åè‡ªåŠ¨ç§»é™¤é”™è¯¯æ¶ˆæ¯
                    setTimeout(() => {
                        errorMessage.remove();
                    }, 5000);
                });
            } catch (error) {
                console.error('åˆ›å»ºæ–°ä¼šè¯æ—¶å‡ºé”™:', error);
                alert('åˆ›å»ºæ–°ä¼šè¯æ—¶å‡ºé”™ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
            }
        }
        
        // è®¾ç½®å·¥å…·åˆ‡æ¢å™¨
        function setupToolSwitchers() {
            // å·¥å…·åˆ‡æ¢é€»è¾‘
            document.querySelectorAll('.tool-switcher').forEach(item => {
                item.addEventListener('click', function() {
                    const tool = this.getAttribute('data-tool');
                    
                    if (tool === currentTool) return;
                    
                    // æ›´æ–°å½“å‰å·¥å…·
                    currentTool = tool;
                    
                    // æ›´æ–°æ´»åŠ¨æ ·å¼
                    document.querySelectorAll('.tool-switcher').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // éšè—æ‰€æœ‰é¢æ¿
                    document.querySelectorAll('.tool-panel').forEach(panel => {
                        panel.style.display = 'none';
                    });
                    
                    // æ˜¾ç¤ºé€‰ä¸­çš„é¢æ¿
                    const panelId = `${tool}-panel`;
                    const panel = document.getElementById(panelId);
                    if (panel) {
                        panel.style.display = 'block';
                    }
                });
            });
        }
        
        // ç”ŸæˆUUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // æ·»åŠ displayMessageå‡½æ•°
        function displayMessage(message, withTypingEffect = true) {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) {
                console.error('æ‰¾ä¸åˆ°æ¶ˆæ¯å®¹å™¨');
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.role}`;
            if (message.error) {
                messageDiv.classList.add('error');
            }
            if (message.offline) {
                messageDiv.classList.add('offline-message');
            }
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.innerHTML = message.role === 'user' ? '<span>U</span>' : '<span>AI</span>';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // æ·»åŠ åˆ°DOM
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            messagesContainer.appendChild(messageDiv);
            
            // å¤„ç†æ¶ˆæ¯å†…å®¹
            if (message.content) {
                // æ£€æŸ¥æ˜¯å¦åŒ…å«å®Œæ•´çš„HTMLæ–‡æ¡£ç»“æ„
                const hasFullHtmlStructure = /<html[\s\S]*?>[\s\S]*?<\/html>/i.test(message.content);
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«ä»»ä½•HTMLæ ‡ç­¾ä½†ä¸æ˜¯å®Œæ•´çš„HTMLæ–‡æ¡£
                const containsHtmlTags = /<[a-z][\s\S]*?>/i.test(message.content) && !hasFullHtmlStructure;
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«Markdownä»£ç å—
                const containsCodeBlocks = /```[\s\S]*?```/g.test(message.content);
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«Markdownæ ¼å¼
                const containsMarkdown = /(\*\*|__|\*|_|~~|#|##|###|####|#####|######|\[.*?\]\(.*?\)|!\[.*?\]\(.*?\)|`[^`]+`|>|---|---|---)/g.test(message.content);
                
                if (hasFullHtmlStructure) {
                    // å®Œæ•´çš„HTMLæ–‡æ¡£ï¼Œåˆ›å»ºiframeæ¥æ˜¾ç¤º
                    const iframe = document.createElement('iframe');
                    iframe.style.width = '100%';
                    iframe.style.minHeight = '300px';
                    iframe.style.border = 'none';
                    iframe.srcdoc = message.content;
                    messageContent.appendChild(iframe);
                    console.log("ä½¿ç”¨iframeæ˜¾ç¤ºå®Œæ•´HTMLæ–‡æ¡£");
                } else if ((containsHtmlTags && !containsCodeBlocks) || message.content.trim().startsWith('<')) {
                    // åŒ…å«HTMLæ ‡ç­¾ä½†ä¸æ˜¯ä»£ç å—çš„ä¸€éƒ¨åˆ†ï¼Œç›´æ¥ä½œä¸ºHTMLæ’å…¥
                    messageContent.innerHTML = message.content;
                    console.log("ç›´æ¥ä½œä¸ºHTMLæ’å…¥");
                } else if (containsCodeBlocks || containsMarkdown) {
                    // åŒ…å«Markdownä»£ç å—æˆ–Markdownæ ¼å¼ï¼Œä½¿ç”¨markedè§£æ
                    try {
                        messageContent.innerHTML = marked.parse(message.content);
                        console.log("ä½¿ç”¨markedè§£æMarkdown");
                        
                        // å¯¹ä»£ç å—åº”ç”¨è¯­æ³•é«˜äº®ï¼ˆå¦‚æœæœ‰å¼•å…¥ç›¸å…³åº“ï¼‰
                        if (typeof hljs !== 'undefined') {
                            messageContent.querySelectorAll('pre code').forEach((block) => {
                                hljs.highlightElement(block);
                            });
                        }
                    } catch (e) {
                        console.error("Markdownè§£æé”™è¯¯ï¼Œå›é€€åˆ°åŸºæœ¬å¤„ç†:", e);
                        messageContent.innerHTML = message.content.replace(/\n/g, '<br>');
                    }
                } else {
                    // æ™®é€šæ–‡æœ¬ï¼Œå¤„ç†æ¢è¡Œç¬¦
                    messageContent.innerHTML = message.content.replace(/\n/g, '<br>');
                    console.log("ä½œä¸ºæ™®é€šæ–‡æœ¬å¤„ç†");
                }
            }
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // æ·»åŠ æ»šåŠ¨åˆ°åº•éƒ¨çš„å‡½æ•°
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chat-messages');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }
    </script>
</body>
</html>