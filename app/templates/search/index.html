<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文献检索系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .search-container {
            max-width: 900px;
            margin: 0 auto;
            padding-top: 50px;
        }
        .search-title {
            margin-bottom: 30px;
            text-align: center;
        }
        .nav-tabs {
            margin-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        .nav-tabs .nav-link {
            border: none;
            color: #495057;
            padding: 10px 20px;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            background-color: #fff;
            border-bottom: 3px solid #0d6efd;
        }
        .search-form {
            margin-bottom: 30px;
        }
        .search-results {
            margin-top: 30px;
        }
        .result-item {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        .result-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .result-authors {
            font-size: 14px;
            color: #555;
            margin-bottom: 5px;
        }
        .result-meta {
            font-size: 12px;
            color: #777;
            margin-bottom: 8px;
        }
        .result-abstract {
            font-size: 14px;
            color: #333;
        }
        .highlight {
            background-color: #ffffd0;
            font-weight: bold;
        }
        .pagination {
            justify-content: center;
            margin-top: 30px;
        }
        .sort-options {
            margin-bottom: 20px;
        }
        .advanced-search-panel {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .date-range {
            display: flex;
            align-items: center;
        }
        .date-range .form-control {
            width: 45%;
        }
        .date-range .separator {
            width: 10%;
            text-align: center;
        }
        .search-type-description {
            color: #666;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container search-container">
        <h1 class="search-title">文献搜索系统</h1>
        
        <!-- 搜索类型选项卡 -->
        <ul class="nav nav-tabs" id="searchTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic-search" type="button" role="tab">基本检索</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced-search" type="button" role="tab">高级检索</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai-search" type="button" role="tab">AI检索</button>
            </li>
        </ul>
        
        <!-- 搜索表单内容 -->
        <div class="tab-content" id="searchTabContent">
            <!-- 基本检索 -->
            <div class="tab-pane fade show active" id="basic-search" role="tabpanel" aria-labelledby="basic-tab">
                <p class="search-type-description">输入关键词进行基本检索，支持多个关键词组合</p>
                <div class="search-form">
                    <div class="input-group mb-3">
                        <input type="text" id="basic-search-input" class="form-control" placeholder="请输入关键词...">
                        <button class="btn btn-primary" id="basic-search-btn" type="button">搜索</button>
                    </div>
                    
                    <div class="sort-options">
                        <label for="basic-sort-method">排序方式：</label>
                        <select id="basic-sort-method" class="form-select">
                            <option value="relevance">相关性排序</option>
                            <option value="time_desc">时间降序</option>
                            <option value="time_asc">时间升序</option>
                            <option value="combined">综合排序</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- 高级检索 -->
            <div class="tab-pane fade" id="advanced-search" role="tabpanel" aria-labelledby="advanced-tab">
                <p class="search-type-description">高级检索支持按标题、作者、机构等字段组合查询</p>
                <div class="advanced-search-panel">
                    <form id="advanced-search-form">
                        <div class="form-group">
                            <label for="title-input">标题：</label>
                            <input type="text" class="form-control" id="title-input" placeholder="请输入标题关键词">
                        </div>
                        
                        <div class="form-group">
                            <label for="author-input">作者：</label>
                            <input type="text" class="form-control" id="author-input" placeholder="请输入作者姓名">
                        </div>
                        
                        <div class="form-group">
                            <label for="keyword-input">关键词：</label>
                            <input type="text" class="form-control" id="keyword-input" placeholder="请输入关键词">
                        </div>
                        
                        <div class="form-group">
                            <label for="institution-input">机构：</label>
                            <input type="text" class="form-control" id="institution-input" placeholder="请输入机构名称">
                        </div>
                        
                        <div class="form-group">
                            <label>发表时间：</label>
                            <div class="date-range">
                                <input type="date" class="form-control" id="date-from-input">
                                <div class="separator">至</div>
                                <input type="date" class="form-control" id="date-to-input">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="advanced-sort-method">排序方式：</label>
                            <select id="advanced-sort-method" class="form-select">
                                <option value="relevance">相关性排序</option>
                                <option value="time_desc">时间降序</option>
                                <option value="time_asc">时间升序</option>
                                <option value="combined">综合排序</option>
                            </select>
                        </div>
                        
                        <button type="button" class="btn btn-primary" id="advanced-search-btn">搜索</button>
                    </form>
                </div>
            </div>
            
            <!-- AI检索 -->
            <div class="tab-pane fade" id="ai-search" role="tabpanel" aria-labelledby="ai-tab">
                <p class="search-type-description">使用自然语言描述您的检索需求，AI将帮您转换为精准的检索式</p>
                <div class="search-form">
                    <div class="mb-3">
                        <label for="ai-search-input" class="form-label">自然语言检索：</label>
                        <textarea class="form-control" id="ai-search-input" rows="3" placeholder="例如：我想找近五年关于深度学习在医疗影像分析中的应用研究..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="show-structured-query" checked>
                            <label class="form-check-label" for="show-structured-query">
                                显示AI转换后的检索式
                            </label>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-primary" id="ai-search-btn">AI检索</button>
                </div>
            </div>
        </div>
        
        <div id="search-results" class="search-results">
            <!-- 搜索结果将动态加载到这里 -->
        </div>
        
        <nav>
            <ul id="pagination" class="pagination">
                <!-- 分页控件将动态加载到这里 -->
            </ul>
        </nav>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 定义排序方式常量
        const SORT_BY_RELEVANCE = 'relevance';
        const SORT_BY_TIME_DESC = 'time_desc';
        const SORT_BY_TIME_ASC = 'time_asc';
        const SORT_BY_COMBINED = 'combined';
        
        // 当前页码和每页数量
        let currentPage = 1;
        const perPage = 10;
        
        // 当前排序方式
        let currentSort = SORT_BY_RELEVANCE;
        
        // 当前搜索参数
        let currentSearchParams = {};
        
        // 基本检索函数
        function performBasicSearch() {
            const keyword = document.getElementById('basic-search-input').value.trim();
            if (!keyword) return;
            
            currentPage = 1;
            currentSort = document.getElementById('basic-sort-method').value;
            currentSearchParams = {
                keyword: keyword,
                sort_method: currentSort,
                search_type: 'basic'
            };
            
            fetchResults();
        }
        
        // 高级检索函数
        function performAdvancedSearch() {
            const title = document.getElementById('title-input').value.trim();
            const author = document.getElementById('author-input').value.trim();
            const keyword = document.getElementById('keyword-input').value.trim();
            const institution = document.getElementById('institution-input').value.trim();
            const dateFrom = document.getElementById('date-from-input').value;
            const dateTo = document.getElementById('date-to-input').value;
            
            // 至少要有一个检索条件
            if (!title && !author && !keyword && !institution && !dateFrom && !dateTo) {
                alert('请至少输入一项检索条件');
                return;
            }
            
            currentPage = 1;
            currentSort = document.getElementById('advanced-sort-method').value;
            currentSearchParams = {
                title: title,
                author: author,
                keyword: keyword,
                institution: institution,
                date_from: dateFrom,
                date_to: dateTo,
                sort_method: currentSort,
                search_type: 'advanced'
            };
            
            fetchResults();
        }
        
        // AI检索函数
        function performAiSearch() {
            const nlQuery = document.getElementById('ai-search-input').value.trim();
            if (!nlQuery) return;
            
            currentPage = 1;
            currentSearchParams = {
                query: nlQuery,
                show_structured: document.getElementById('show-structured-query').checked,
                search_type: 'ai'
            };
            
            fetchResults();
        }
        
        // 获取搜索结果
        function fetchResults() {
            // 显示加载状态
            document.getElementById('search-results').innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">加载中...</span></div></div>';
            
            // 构建请求参数
            const requestParams = {
                ...currentSearchParams,
                page: currentPage,
                per_page: perPage
            };
            
            // 确定请求URL
            let requestUrl = '/search';
            if (requestParams.search_type === 'advanced') {
                requestUrl = '/api/basic/advanced_search';
            } else if (requestParams.search_type === 'ai') {
                requestUrl = '/api/basic/ai_search';
            }
            
            // 发送搜索请求
            fetch(requestUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestParams)
            })
            .then(response => response.json())
            .then(data => {
                renderResults(data);
            })
            .catch(error => {
                console.error('搜索出错:', error);
                document.getElementById('search-results').innerHTML = '<div class="alert alert-danger">搜索出错，请稍后重试</div>';
            });
        }
        
        // 渲染搜索结果
        function renderResults(data) {
            const resultsContainer = document.getElementById('search-results');
            
            // 如果是AI搜索且显示结构化查询
            if (currentSearchParams.search_type === 'ai' && currentSearchParams.show_structured && data.structured_query) {
                let structuredQueryHtml = `
                    <div class="alert alert-info mb-4">
                        <strong>AI转换后的检索式：</strong> ${data.structured_query}
                    </div>
                `;
                resultsContainer.innerHTML = structuredQueryHtml;
            } else {
                resultsContainer.innerHTML = '';
            }
            
            if (!data.results || data.results.length === 0) {
                let currentHtml = resultsContainer.innerHTML;
                resultsContainer.innerHTML = currentHtml + '<div class="alert alert-warning">没有找到匹配的结果</div>';
                document.getElementById('pagination').innerHTML = '';
                return;
            }
            
            let resultsHtml = '';
            data.results.forEach(result => {
                resultsHtml += `
                    <div class="result-item">
                        <div class="result-title">
                            <a href="/reader/document/${result.id}">${result.title}</a>
                        </div>
                        <div class="result-authors">${result.authors}</div>
                        <div class="result-meta">
                            发表年份: ${result.year || '未知'} | 被引用次数: ${result.cited_by_count}
                        </div>
                        <div class="result-abstract">${result.abstract || '无摘要'}</div>
                    </div>
                `;
            });
            
            let currentHtml = resultsContainer.innerHTML;
            resultsContainer.innerHTML = currentHtml + '<div class="search-results-list">' + resultsHtml + '</div>';
            
            // 生成分页
            renderPagination(data.page, Math.ceil(data.total / perPage));
        }
        
        // 渲染分页控件
        function renderPagination(currentPage, totalPages) {
            const paginationElement = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                paginationElement.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // 上一页按钮
            html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}">上一页</a>
                </li>
            `;
            
            // 页码按钮
            const maxPages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(totalPages, startPage + maxPages - 1);
            
            if (endPage - startPage + 1 < maxPages) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `;
            }
            
            // 下一页按钮
            html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}">下一页</a>
                </li>
            `;
            
            paginationElement.innerHTML = html;
            
            // 添加分页事件监听
            document.querySelectorAll('#pagination .page-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = parseInt(this.getAttribute('data-page'));
                    if (page < 1 || page > totalPages || page === currentPage) return;
                    currentPage = page;
                    fetchResults();
                });
            });
        }
        
        // 添加事件监听
        document.addEventListener('DOMContentLoaded', function() {
            // 基本检索
            document.getElementById('basic-search-btn').addEventListener('click', performBasicSearch);
            document.getElementById('basic-search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performBasicSearch();
            });
            
            // 高级检索
            document.getElementById('advanced-search-btn').addEventListener('click', performAdvancedSearch);
            
            // AI检索
            document.getElementById('ai-search-btn').addEventListener('click', performAiSearch);
            document.getElementById('ai-search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performAiSearch();
            });
        });
    </script>
</body>
</html> 