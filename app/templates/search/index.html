<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="/search/">
    <link rel="icon" href="/static/search/favicon.png">
    <title>文献检索系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        /* 根样式 */
        :root {
            --primary-color: #4a6bdf;
            --secondary-color: #f5f5f5;
            --text-color: #333;
            --border-color: #ddd;
            --sidebar-width: 320px;
            --sidebar-min-width: 280px;
            --sidebar-max-width: 500px;
            --transition-time: 0.3s;
        }
        
        /* 基础样式 */
        body {
            font-family: 'Arial', sans-serif;
            color: var(--text-color);
            background-color: #f8f9fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* 主容器样式 */
        .main-container {
            display: flex;
            position: relative;
            margin-top: 0.5rem;
            margin-bottom: 2rem;
            min-height: calc(100vh - 200px);
            transition: margin-right var(--transition-time) ease;
        }
        
        /* 当侧边栏展开时，主容器右侧留出空间 */
        .main-container.sidebar-expanded {
            margin-right: var(--sidebar-width);
        }

        /* 搜索区域样式 */
        .search-section {
            flex-grow: 1;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            transition: width var(--transition-time) ease;
            width:100%
        }
        
        /* AI侧边栏样式 */
        .ai-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 0;
            height: 100%;
            background-color: white;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: width var(--transition-time) ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* 侧边栏展开状态 */
        .ai-sidebar.expanded {
            width: var(--sidebar-width);
        }
        
        /* 侧边栏头部样式 */
        .ai-sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        /* 侧边栏内容区域样式 */
        .ai-sidebar-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        /* 缩放手柄样式 */
        .ai-resize-handle {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            cursor: ew-resize;
            background-color: transparent;
            z-index: 1001;
        }
        
        /* AI辅助按钮样式 */
        .ai-toggle-btn {
            position: fixed;
            bottom: 6rem;
            right: 6rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            font-size: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 999;
            transition: all 0.2s ease;
        }
        
        .ai-toggle-btn:hover {
            transform: scale(1.05);
            background-color: #3a5bc7;
        }
        
        /* 聊天容器样式 */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .messages-container {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 1rem;
        }
        
        .message {
            margin-bottom: 1rem;
            padding: 0.8rem 1rem;
            border-radius: 10px;
            max-width: 80%;
        }
        
        .ai-message {
            background-color: #f0f2ff;
            align-self: flex-start;
        }
        
        .user-message {
            background-color: var(--primary-color);
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }
        
        .message-content {
            margin-bottom: 0;
        }
        
        /* 输入框容器样式 */
        .input-container {
            display: flex;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background-color: white;
            position: sticky;
            bottom: 0;
        }
        
        .chat-input {
            flex-grow: 1;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            margin-right: 0.5rem;
        }
        
        .send-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* 搜索框容器样式 */
        .search-box {
            position: relative;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(74, 107, 223, 0.25);
        }
        
        /* Tab样式 */
        .nav-tabs {
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: var(--text-color);
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
            border-radius: 5px;
        }
        
        .nav-tabs .nav-link:hover {
            color: var(--text-color);
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .nav-tabs .nav-link.active {
            color: white;
            background-color: #366686fb;
            border-bottom: none;
        }
        
        /* 高级检索样式 */
        .advanced-condition-row {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
            align-items: center;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            transition: all 0.3s ease;
            transform-origin: left center;
        }
        
        .advanced-condition-row:hover,
        .advanced-condition-row:hover .condition-remove-btn {
            transform: scale(1.02);
        }
        
        .condition-remove {
            width: 12%;
            min-width: 80px;
            display: flex;
            justify-content: flex-end;
        }
        
        .condition-remove-btn {
            padding: 0.25rem 0.75rem;
            border: 1px solid #4a6bdf;
            border-radius: 4px;
            background-color: #ffffff;
            color: #4a6bdf;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transform: none;
        }
        
        .condition-remove-btn:hover {
            background-color: #4a6bdf;
            color: #ffffff;
            box-shadow: 0 2px 5px rgba(74, 107, 223, 0.2);
        }
        
        .condition-remove-btn:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(74, 107, 223, 0.1);
        }
        
        .condition-logic {
            width: 12%;
            min-width: 80px;
        }
        
        .condition-field {
            width: 20%;
            min-width: 120px;
        }
        
        .condition-input {
            flex-grow: 1;
            max-width: 400px;
        }
        
        .add-condition-container {
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 1rem;
            padding-left: 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .add-condition-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 3px;
            color: #6c757d;
            border-color: #dee2e6;
            background-color: #f8f9fa;
            transition: all 0.2s ease;
        }
        
        .add-condition-btn:hover {
            color: #495057;
            background-color: #e9ecef;
            border-color: #ced4da;
            transform: translateY(-1px);
        }
        
        .add-condition-btn:active {
            transform: translateY(0);
        }
        
        .search-submit-btn {
            margin: 0;
            padding: 0.5rem 2rem;
            font-size: 1rem;
            background-color: var(--primary-color);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            min-width: 120px;
            transition: all 0.2s ease;
        }
        
        .search-submit-btn:hover {
            background-color: #3a5bc7;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .search-submit-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }
        
        .condition-input {
            flex-grow: 1;
            max-width: calc(100% - 24% - 20% - 12% - 20px); /* 减去其他元素的宽度和间距 */
        }
        
        /* 检索历史样式 */
        .search-history {
            margin-top: 2rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .search-history-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 1rem;
            color: var(--text-color);
            text-align: left;
            padding-left: 1rem;
        }
        
        .history-list {
            list-style: none;
            padding: 0;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
            gap: 1rem;
            min-height: 60px;
        }
        
        .history-item:hover {
            background-color: #f8f9fa;
        }
        
        .history-content {
            flex: 1;
            min-width: 0;
            word-break: break-word;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .history-query {
            font-weight: 500;
            margin-bottom: 0.25rem;
            white-space: pre-wrap;
            line-height: 1.4;
        }
        
        .history-time {
            color: #6c757d;
            font-size: 0.85rem;
            line-height: 1.2;
        }
        
        .history-apply-btn {
            flex-shrink: 0;
            width: 60px;
            height: 32px;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            align-self: center;
        }
        
        /* 页脚样式 */
        .footer {
            background-color: #f8f9fa;
            padding: 2rem 0;
            text-align: center;
            border-top: 1px solid var(--border-color);
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .condition-field {
                width: 40%;
            }
            
            .search-section {
                padding: 1.5rem;
            }
        }
        
        /* 查询预览样式 */
        .query-preview {
            background-color: #f0f2ff;
            border-radius: 5px;
            padding: 0.5rem 1rem;
            margin-bottom: 1rem;
            border-left: 3px solid var(--primary-color);
            font-family: monospace;
            overflow-x: auto;
        }
        
        /* 应用检索式按钮样式 */
        .apply-query-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 0.5rem 1.5rem;
            margin-top: 0.5rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .apply-query-btn:hover {
            background-color: #3a5bc7;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .apply-query-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }
        
        /* 加载动画样式 */
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 头部导航样式 */
        .header {
            background-color: #366686fb;
            padding: 1.5rem 0 1rem 0;
            margin-bottom: 1rem;
        }

        .header h1 {
            color: white;
            text-align: center;
            margin: 0;
            font-size: 3rem;
            padding-top: 0.5rem;
        }

        .header h1 a {
            color: white;
            text-decoration: none;
        }

        .header .nav {
            margin-top: 0.5rem;
        }

        .header .nav-link {
            color: var(--text-color);
            padding: 0.5rem 1rem;
            position: relative;
            transition: all 0.3s ease;
        }

        .header .nav-link:hover {
            color: var(--primary-color);
            transform: translateY(-2px);
        }

        .header .nav-link.active {
            color: var(--primary-color);
            border-bottom: none;
        }

        .header .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }

        .header .nav-link:hover::after {
            width: 100%;
        }

        .header .nav-link.active::after {
            width: 0;
        }

        /* 检索式检索样式 */
        .query-search-form textarea {
            font-family: monospace;
            line-height: 1.5;
            padding: 1rem;
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            font-size: 1.1rem;
        }

        .query-search-form textarea:focus {
            background-color: white;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(74, 107, 223, 0.25);
        }

        .query-help-panel {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            height: 100%;
            border: 1px solid var(--border-color);
        }

        .query-help-panel .help-title {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
        }

        .query-help-panel .help-content {
            font-size: 0.95rem;
        }

        .query-help-panel .help-list {
            list-style: none;
            padding-left: 0;
            margin-bottom: 0;
        }

        .query-help-panel .help-list li {
            margin-bottom: 0.8rem;
            padding-left: 1.5rem;
            position: relative;
        }

        .query-help-panel .help-list li:before {
            content: "•";
            color: var(--primary-color);
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .query-help-panel {
                margin-top: 1rem;
            }
        }

        /* 检索词推荐框样式 */
        .suggestions-container {
            position: relative;
            width: 100%;
        }

        .suggestions-box {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .suggestions-box.show {
            display: block;
        }

        .suggestion-section {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .suggestion-section:last-child {
            border-bottom: none;
        }

        .suggestion-section h6 {
            color: #666;
            margin-bottom: 10px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .suggestion-item {
            padding: 6px 10px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
        }

        .suggestion-item:hover {
            background-color: #f8f9fa;
        }

        .suggestion-score {
            font-size: 0.8rem;
            color: #666;
            margin-left: 10px;
        }

        .boolean-suggestion {
            color: var(--primary-color);
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- 头部导航 -->
    <header class="header">
        <div class="container">
            <h1>
                <a href="index">
                    文献检索系统
                </a>
            </h1>
            <!-- <div class="d-flex justify-content-center">
                <nav>
                    <ul class="nav">
                        <li class="nav-item">
                            <a class="nav-link active" href="index">
                            </a>
                        </li>
                    </ul>
                </nav>
            </div> -->
        </div>
    </header>

    <div class="container main-container">
        <!-- 主搜索区域 -->
        <div class="search-section">
            <ul class="nav nav-tabs" id="searchTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab" aria-controls="basic" aria-selected="true">
                        基本检索
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button" role="tab" aria-controls="advanced" aria-selected="false">
                        高级检索
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="query-tab" data-bs-toggle="tab" data-bs-target="#query" type="button" role="tab" aria-controls="query" aria-selected="false">
                        检索式检索
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" href="/word_clouds" role="tab">
                        叙词表分析
                    </a>
                </li>
            </ul>
            <div class="tab-content" id="searchTabsContent">
                <!-- 基本检索 -->
                <div class="tab-pane fade show active" id="basic" role="tabpanel" aria-labelledby="basic-tab">
                    <form id="basicSearchForm" class="search-form" action="/search/results" method="get">
                        <div class="search-box mb-3">
                            <div class="suggestions-container">
                                <input type="text" id="basicSearchInput" name="query" class="form-control search-input" placeholder="请输入检索词..." required>
                                <div id="suggestionBox" class="suggestions-box">
                                    <!-- 同义词建议 -->
                                    <div class="suggestion-section" id="synonymSection">
                                        <h6>同义词推荐</h6>
                                        <div id="synonymSuggestions"></div>
                                    </div>
                                    <!-- 主题建议 -->
                                    <div class="suggestion-section" id="themeSection">
                                        <h6>相关主题</h6>
                                        <div id="themeSuggestions"></div>
                                    </div>
                                    <!-- 布尔组合建议 -->
                                    <div class="suggestion-section" id="booleanSection">
                                        <h6>布尔组合建议</h6>
                                        <div id="booleanSuggestions"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-center">
                            <button type="submit" class="btn btn-primary search-submit-btn">
                                检索
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- 高级检索 -->
                <div class="tab-pane fade" id="advanced" role="tabpanel" aria-labelledby="advanced-tab">
                    <form id="advancedSearchForm" action="results" method="get" class="advanced-search-form">
                        <div id="advancedConditions">
                            <!-- 默认的条件行 -->
                            <div class="advanced-condition-row">
                                <div class="condition-remove">
                                    <button type="button" class="condition-remove-btn">删除</button>
                                </div>
                                <select class="form-select condition-logic">
                                    <option value="AND">AND</option>
                                    <option value="OR">OR</option>
                                    <option value="NOT">NOT</option>
                                </select>
                                <select class="form-select condition-field">
                                    <option value="title">标题</option>
                                    <option value="author">作者</option>
                                    <option value="keyword">关键词</option>
                                    <option value="abstract">摘要</option>
                                    <option value="institution">机构</option>
                                    <option value="source">来源/期刊</option>
                                    <option value="country">国家</option>
                                    <option value="language">语言</option>
                                    <option value="type">文献类型</option>
                                    <option value="cited">被引用次数</option>
                                    <option value="doi">DOI</option>
                                    <option value="topic">学科主题</option>
                                    <option value="concept">概念</option>
                                    <option value="time">发表时间</option>
                                    <option value="content">内容</option>
                                </select>
                                <input type="text" class="form-control condition-input" placeholder="输入检索词">
                            </div>
                        </div>
                        
                        <div class="add-condition-container">
                            <button type="button" id="addCondition" class="btn btn-outline-secondary add-condition-btn">
                                <i class="bi bi-plus-circle"></i>
                                添加条件
                            </button>
                            <button type="submit" class="btn btn-primary search-submit-btn">
                                检索
                            </button>
                        </div>
                    </form>
                </div>

                <!-- 检索式检索 -->
                <div class="tab-pane fade" id="query" role="tabpanel" aria-labelledby="query-tab">
                    <div class="row">
                        <div class="col-md-8">
                            <form id="querySearchForm" action="results" method="get" class="query-search-form">
                                <div class="search-box mb-3">
                                    <textarea id="queryInput" name="query" class="form-control search-input" 
                                        placeholder="请输入检索式，例如：人工智能 AND (机器学习 OR 深度学习) AND 2020-2023" 
                                        rows="6" style="resize: none; border-radius: 8px;"></textarea>
                                </div>
                                <div class="d-flex justify-content-center">
                                    <button type="submit" class="btn btn-primary search-submit-btn">
                                        执行检索
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-4">
                            <div class="query-help-panel">
                                <h5 class="help-title">检索式语法说明</h5>
                                <div class="help-content">
                                    <ul class="help-list">
                                        <li>
                                            <strong>AND</strong>：同时包含多个词
                                        </li>
                                        <li>
                                            <strong>OR</strong>：包含任意一个词
                                        </li>
                                        <li>
                                            <strong>NOT</strong>：不包含某个词
                                        </li>
                                        <li>
                                            <strong>( )</strong>：组合多个条件
                                        </li>
                                        <li>
                                            <strong>*</strong>：通配符，匹配任意字符
                                        </li>
                                        <li>
                                            <strong>年份范围</strong>：使用连字符
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 搜索历史 -->
            <div class="search-history">
                <h3 class="search-history-title">
                    最近检索
                </h3>
                <ul class="history-list" id="searchHistory">
                    <!-- 历史记录将由JavaScript动态加载 -->
                </ul>
            </div>
        </div>
        
        <!-- AI辅助侧边栏 -->
        <div class="ai-sidebar" id="aiSidebar">
            <div class="ai-resize-handle" id="aiResizeHandle"></div>
            <div class="ai-sidebar-header">
                <h5 class="mb-0">
                    AI辅助检索
                </h5>
                <button type="button" class="btn-close" id="closeSidebar"></button>
            </div>
            <div class="ai-sidebar-content">
                <div class="chat-container">
                    <div class="messages-container" id="aiMessages">
                        <div class="message ai-message">
                            <p class="message-content">
                                您好！我是您的AI检索助手。请用自然语言描述您想要查找的文献，我将帮您生成专业的检索式。
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="input-container">
                <input type="text" class="chat-input" id="aiQueryInput" placeholder="请输入您的问题...">
                <button class="send-button" id="sendQuery">
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- AI辅助按钮放在页面底部，不是容器内部 -->
    <button class="ai-toggle-btn" id="aiToggleBtn">
        <i class="bi bi-robot"></i>
    </button>

    <footer class="footer">
        <div class="container">
            <p class="mb-0">
                © 2025 文献检索系统. 保留所有权利.
            </p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 定义排序方式常量
        const SORT_BY_RELEVANCE = 'relevance';
        const SORT_BY_TIME_DESC = 'time_desc';
        const SORT_BY_TIME_ASC = 'time_asc';
        const SORT_BY_COMBINED = 'combined';
        
        // 当前页码和每页数量
        let currentPage = 1;
        const perPage = 10;
        
        // 当前排序方式
        let currentSort = SORT_BY_RELEVANCE;
        
        // 当前搜索参数
        let currentSearchParams = {};
        
        // 当前会话ID
        let currentSessionId = null;
        
        // 记录点击
        function recordClick(documentId) {
            if (!currentSessionId) {
                console.warn('[用户行为] 没有有效的会话ID，无法记录点击');
                return;
            }
            
            console.log(`[用户行为] 开始记录文档点击: document_id=${documentId}, session_id=${currentSessionId}`);
            
            fetch('/api/basic/record_click', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSessionId,
                    document_id: documentId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('[用户行为] 记录点击失败:', data.error);
                } else {
                    console.log('[用户行为] 成功记录文档点击');
                }
            })
            .catch(error => console.error('[用户行为] 记录点击失败:', error));
        }

        document.addEventListener('DOMContentLoaded', function() {
            // DOM元素引用
            const aiToggleBtn = document.getElementById('aiToggleBtn');
            const aiSidebar = document.getElementById('aiSidebar');
            const closeSidebar = document.getElementById('closeSidebar');
            const mainContainer = document.querySelector('.main-container');
            const aiQueryInput = document.getElementById('aiQueryInput');
            const sendQueryBtn = document.getElementById('sendQuery');
            const aiMessages = document.getElementById('aiMessages');
            const aiResizeHandle = document.getElementById('aiResizeHandle');
            const basicForm = document.getElementById('basicSearchForm');
            const advancedForm = document.getElementById('advancedSearchForm');

            // 获取URL查询参数
            function getQueryParam(param) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(param);
            }

            // 当前搜索模式（基本、高级或检索式）
            let currentSearchMode = 'basic';  // 默认设置为基本检索

            // 切换标签页时更新搜索模式
            document.querySelectorAll('.nav-link').forEach(tab => {
                tab.addEventListener('click', function() {
                    if (this.id === 'basic-tab') {
                        currentSearchMode = 'basic';
                    } else if (this.id === 'advanced-tab') {
                        currentSearchMode = 'advanced';
                    } else if (this.id === 'query-tab') {
                        currentSearchMode = 'query';
                    }
                });
            });

            // 为所有文档链接添加事件监听器
            document.addEventListener('click', function(e) {
                const link = e.target.closest('a[data-document-id]');
                if (link) {
                    const documentId = link.getAttribute('data-document-id');
                    console.log(`[用户行为] 检测到文档点击: document_id=${documentId}`);
                    recordClick(documentId);
                }
            });

            // 跨页面保持搜索模式
            const savedMode = localStorage.getItem('searchMode');
            if (savedMode) {
                if (savedMode === 'advanced') {
                    document.getElementById('advanced-tab').click();
                } else if (savedMode === 'query') {
                    document.getElementById('query-tab').click();
                } else {
                    document.getElementById('basic-tab').click();
                }
            }

            // 打开侧边栏
            function openSidebar() {
                aiSidebar.classList.add('expanded');
                mainContainer.classList.add('sidebar-expanded');
                setTimeout(() => {
                    aiQueryInput.focus();
                }, 300);
            }

            // 关闭侧边栏
            function closeSidebarFunc() {
                aiSidebar.classList.remove('expanded');
                mainContainer.classList.remove('sidebar-expanded');
            }

            // 侧边栏调整大小
            let isResizing = false;
            let lastDownX = 0;

            // 开始调整大小
            aiResizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                lastDownX = e.clientX;
                document.body.style.cursor = 'ew-resize';
                aiResizeHandle.style.backgroundColor = 'rgba(74, 107, 223, 0.3)';
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', stopResize);
                e.preventDefault();
            });

            // 调整大小时的处理函数
            function handleMouseMove(e) {
                if (!isResizing) return;
                let newWidth = window.innerWidth - e.clientX;
                if (newWidth < parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-min-width'))) {
                    newWidth = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-min-width'));
                }
                if (newWidth > parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-max-width'))) {
                    newWidth = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-max-width'));
                }
                document.documentElement.style.setProperty('--sidebar-width', newWidth + 'px');
                mainContainer.style.marginRight = newWidth + 'px';
                e.preventDefault();
            }

            // 停止调整大小
            function stopResize() {
                isResizing = false;
                document.body.style.cursor = '';
                aiResizeHandle.style.backgroundColor = 'transparent';
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', stopResize);
            }

            // AI聊天功能
            aiToggleBtn.addEventListener('click', openSidebar);
            closeSidebar.addEventListener('click', closeSidebarFunc);
            sendQueryBtn.addEventListener('click', sendQuery);
            aiQueryInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendQuery();
                }
            });

            // 发送查询到AI
            function sendQuery() {
                const query = aiQueryInput.value.trim();
                if (!query) return;

                addMessage(query, 'user');
                aiQueryInput.value = '';

                const loadingMessageEl = document.createElement('div');
                loadingMessageEl.className = 'message ai-message';
                loadingMessageEl.innerHTML = `
                    <p class="message-content">
                        <span class="loading-spinner"></span>
                        正在生成检索式...
                    </p>
                `;
                aiMessages.appendChild(loadingMessageEl);
                aiMessages.scrollTop = aiMessages.scrollHeight;

                sendQueryBtn.disabled = true;
                aiQueryInput.disabled = true;

                fetch('/search/api/ai_search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query,
                        search_mode: currentSearchMode
                    })
                })
                .then(response => response.json())
                .then(data => {
                    aiMessages.removeChild(loadingMessageEl);
                    const formattedResponse = formatAIResponse(data);
                    addMessage(formattedResponse, 'ai');
                    
                    // 保存会话ID
                    if (data.session_id) {
                        currentSessionId = data.session_id;
                        console.log('[用户行为] 获取到新的会话ID:', currentSessionId);
                    }

                    sendQueryBtn.disabled = false;
                    aiQueryInput.disabled = false;
                    aiQueryInput.focus();
                })
                .catch(error => {
                    aiMessages.removeChild(loadingMessageEl);
                    addMessage('抱歉，服务器发生错误，请稍后再试。', 'ai');
                    sendQueryBtn.disabled = false;
                    aiQueryInput.disabled = false;
                    aiQueryInput.focus();
                    console.error('Error:', error);
                });
            }

            // 添加消息到聊天界面
            function addMessage(content, sender) {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${sender}-message`;

                if (sender === 'ai' && typeof content === 'object') {
                    messageEl.innerHTML = `
                        <p class="message-content">
                            ${content.message}
                        </p>
                        <div class="query-preview">
                            ${content.query}
                        </div>
                        <button class="apply-query-btn" data-query="${content.query}">
                            <i class="bi bi-search"></i>
                            应用检索式
                        </button>
                    `;
                } else {
                    messageEl.innerHTML = `
                        <p class="message-content">
                            ${content}
                        </p>
                    `;
                }

                aiMessages.appendChild(messageEl);
                aiMessages.scrollTop = aiMessages.scrollHeight;

                if (sender === 'ai') {
                    const applyBtns = messageEl.querySelectorAll('.apply-query-btn');
                    applyBtns.forEach(btn => {
                        btn.addEventListener('click', function() {
                            const query = this.getAttribute('data-query');
                            applySearchQuery(query);
                        });
                    });
                }
            }

            // 格式化AI响应
            function formatAIResponse(data) {
                if (data.status === 'success' && data.query) {
                    return {
                        message: data.response || '根据您的描述，我生成了以下检索式：',
                        query: data.query
                    };
                } else {
                    return data.response || '抱歉，我无法生成适合的检索式。请尝试提供更详细的描述。';
                }
            }

            // 应用检索式
            function applySearchQuery(query) {
                if (currentSearchMode === 'basic') {
                    document.getElementById('basicQuery').value = query;
                    basicForm.submit();
                } else {
                    document.querySelector('#advanced .condition-input').value = query;
                }
            }

            // 初始化
            function init() {
                // 确保默认显示基本检索 Tab
                const basicTab = new bootstrap.Tab(document.getElementById('basic-tab'));
                basicTab.show();
                currentSearchMode = 'basic';

                const queryParam = getQueryParam('query');
                if (queryParam) {
                    document.getElementById('basicQuery').value = decodeURIComponent(queryParam);
                }

                loadSearchHistory();

                // 处理表单提交
                basicForm.addEventListener('submit', function(e) {
                    const query = document.getElementById('basicQuery').value.trim();
                    if (!query) {
                        e.preventDefault();
                        alert('请输入检索条件');
                        return false;
                    }

                    if (query) {
                        saveSearchHistory(query);
                        localStorage.setItem('searchMode', 'basic');
                    }
                });

                advancedForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const conditions = [];
                    
                    document.querySelectorAll('.advanced-condition-row').forEach(function(condition) {
                        const logic = condition.querySelector('.condition-logic').value;
                        const field = condition.querySelector('.condition-field').value;
                        const input = condition.querySelector('.condition-input').value.trim();
                        
                        if (input) {
                            conditions.push({
                                field: field,
                                logic: logic,
                                input: input
                            });
                        }
                    });

                    if (conditions.length > 0) {
                        // 保存搜索历史
                        saveSearchHistory(JSON.stringify(conditions));
                        // 跳转到结果页面，添加search_type参数
                        window.location.href = `/search/results?query=${encodeURIComponent(JSON.stringify(conditions))}&search_type=boolean`;
                    } else {
                        alert('请至少输入一个检索条件');
                    }
                });

                document.getElementById('addCondition').addEventListener('click', function() {
                    addConditionRow();
                });

                // 处理检索式检索表单提交
                document.getElementById('querySearchForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    const query = document.getElementById('queryInput').value.trim();
                    
                    if (!query) {
                        alert('请输入检索式');
                        return false;
                    }

                    saveSearchHistory(query);
                    localStorage.setItem('searchMode', 'query');
                    window.location.href = `/search/results?query=${encodeURIComponent(query)}`;
                });
            }

            // 添加高级检索条件行
            function addConditionRow() {
                const conditionsContainer = document.getElementById('advancedConditions');
                const newRow = document.createElement('div');
                newRow.className = 'advanced-condition-row';
                newRow.innerHTML = `
                    <div class="condition-remove">
                        <button type="button" class="condition-remove-btn">删除</button>
                    </div>
                    <select class="form-select condition-logic">
                        <option value="AND">AND</option>
                        <option value="OR">OR</option>
                        <option value="NOT">NOT</option>
                    </select>
                    <select class="form-select condition-field">
                        <option value="title">标题</option>
                        <option value="author">作者</option>
                        <option value="keyword">关键词</option>
                        <option value="abstract">摘要</option>
                        <option value="institution">机构</option>
                        <option value="source">来源/期刊</option>
                        <option value="country">国家</option>
                        <option value="language">语言</option>
                        <option value="type">文献类型</option>
                        <option value="cited">被引用次数</option>
                        <option value="doi">DOI</option>
                        <option value="topic">学科主题</option>
                        <option value="concept">概念</option>
                        <option value="time">发表时间</option>
                        <option value="content">内容</option>
                    </select>
                    <input type="text" class="form-control condition-input" placeholder="输入检索词">
                `;

                const removeBtn = newRow.querySelector('.condition-remove-btn');
                removeBtn.addEventListener('click', function() {
                    if (document.querySelectorAll('.advanced-condition-row').length > 1) {
                        conditionsContainer.removeChild(newRow);
                    }
                });

                conditionsContainer.appendChild(newRow);
            }

            // 保存搜索历史
            function saveSearchHistory(query) {
                let history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
                history = history.filter(item => item.query !== query);
                history.unshift({
                    query: query,
                    time: new Date().toISOString()
                });
                if (history.length > 10) {
                    history = history.slice(0, 10);
                }
                localStorage.setItem('searchHistory', JSON.stringify(history));
                loadSearchHistory();
            }

            // 加载搜索历史
            function loadSearchHistory() {
                const historyList = document.getElementById('searchHistory');
                historyList.innerHTML = '';
                const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');

                if (history.length === 0) {
                    historyList.innerHTML = '<li class="text-muted p-3">暂无检索历史</li>';
                    return;
                }

                history.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'history-item';
                    const date = new Date(item.time);
                    const formattedTime = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;

                    // 格式化查询显示
                    let displayQuery = item.query;
                    try {
                        // 尝试解析JSON格式的高级检索式
                        const queryObj = JSON.parse(item.query);
                        if (Array.isArray(queryObj)) {
                            displayQuery = formatAdvancedQuery(queryObj);
                        }
                    } catch (e) {
                        // 如果解析失败，说明不是JSON格式，直接显示原始查询
                        displayQuery = item.query;
                    }

                    li.innerHTML = `
                        <div>
                            <div class="history-query">${displayQuery}</div>
                            <div class="history-time">${formattedTime}</div>
                        </div>
                        <button class="btn btn-sm btn-outline-primary history-apply-btn">应用</button>
                    `;

                    const applyBtn = li.querySelector('.history-apply-btn');
                    applyBtn.addEventListener('click', function() {
                        const query = item.query.trim();
                        if (query) {
                            try {
                                // 尝试解析JSON格式，判断是否为高级检索式
                                const queryObj = JSON.parse(query);
                                if (Array.isArray(queryObj)) {
                                    // 如果是高级检索式，添加search_type参数
                                    window.location.href = `/search/results?query=${encodeURIComponent(query)}&search_type=boolean`;
                                } else {
                                    // 如果不是数组格式，按普通检索处理
                                    document.getElementById('basicQuery').value = query;
                                    basicForm.submit();
                                }
                            } catch (e) {
                                // 如果解析JSON失败，按普通检索处理
                                document.getElementById('basicQuery').value = query;
                                basicForm.submit();
                            }
                        } else {
                            alert('检索式不能为空');
                        }
                    });

                    historyList.appendChild(li);
                });
            }

            // 格式化高级检索式显示
            function formatAdvancedQuery(conditions) {
                const fieldMap = {
                    'title': '标题',
                    'author': '作者',
                    'keyword': '关键词',
                    'abstract': '摘要',
                    'institution': '机构',
                    'source': '来源',
                    'country': '国家',
                    'language': '语言',
                    'type': '类型',
                    'cited': '被引用',
                    'doi': 'DOI',
                    'topic': '主题',
                    'concept': '概念',
                    'time': '时间',
                    'content': '内容'
                };

                if (conditions.length === 1) {
                    // 如果只有一个条件，不需要括号
                    const field = fieldMap[conditions[0].field] || conditions[0].field;
                    return `${field}:${conditions[0].input}`;
                }
                
                // 如果有多个条件，使用后一个条件的logic值作为连接符
                return conditions.map((condition, index) => {
                    const field = fieldMap[condition.field] || condition.field;
                    const formattedCondition = `(${field}:${condition.input})`;
                    
                    // 如果不是最后一个条件，添加下一个条件的logic值作为连接符
                    if (index < conditions.length - 1) {
                        return `${formattedCondition} ${conditions[index + 1].logic} `;
                    }
                    return formattedCondition;
                }).join('');
            }

            // 获取DOM元素
            const basicSearchInput = document.getElementById('basicSearchInput');
            const suggestionBox = document.getElementById('suggestionBox');
            const synonymSuggestions = document.getElementById('synonymSuggestions');
            const themeSuggestions = document.getElementById('themeSuggestions');
            const booleanSuggestions = document.getElementById('booleanSuggestions');
            
            let debounceTimer;
            let currentInputPosition;
            
            // 监听输入事件
            basicSearchInput.addEventListener('input', function(e) {
                const fullQuery = this.value;
                currentInputPosition = this.selectionStart;
                
                // 清除之前的定时器
                clearTimeout(debounceTimer);
                
                // 获取光标位置之前的文本
                const textBeforeCursor = fullQuery.substring(0, currentInputPosition);
                
                // 解析检索式，获取最后一个词
                const lastTerm = getLastTerm(textBeforeCursor);
                
                // 如果没有检索词，隐藏推荐框
                if (!lastTerm) {
                    suggestionBox.classList.remove('show');
                    return;
                }
                
                // 设置300ms的防抖
                debounceTimer = setTimeout(() => {
                    fetchSuggestions(lastTerm, fullQuery);
                }, 300);
            });
            
            // 解析检索式，获取最后一个词
            function getLastTerm(text) {
                // 移除多余的空格
                text = text.trim();
                if (!text) return '';
                
                // 分割检索式
                const tokens = text.split(/\s+/);
                
                // 如果最后一个token是布尔运算符，返回空
                const booleanOperators = ['AND', 'OR', 'NOT'];
                if (booleanOperators.includes(tokens[tokens.length - 1].toUpperCase())) {
                    return '';
                }
                
                // 返回最后一个非布尔运算符的词
                for (let i = tokens.length - 1; i >= 0; i--) {
                    const token = tokens[i].toUpperCase();
                    if (!booleanOperators.includes(token)) {
                        return tokens[i];
                    }
                }
                
                return '';
            }
            
            // 监听点击事件，处理建议词的选择
            document.addEventListener('click', function(e) {
                if (!suggestionBox.contains(e.target) && e.target !== basicSearchInput) {
                    suggestionBox.classList.remove('show');
                }
            });
            
            // 获取推荐词
            function fetchSuggestions(term, fullQuery) {
                fetch('/search/api/suggest_terms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ term: term })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        updateSuggestions(data.suggestions, term, fullQuery);
                        suggestionBox.classList.add('show');
                    }
                })
                .catch(error => {
                    console.error('获取推荐词失败:', error);
                });
            }
            
            // 更新推荐词显示
            function updateSuggestions(suggestions, currentTerm, fullQuery) {
                // 获取当前检索式中，当前词之前的部分
                const beforeCurrentTerm = fullQuery.substring(0, fullQuery.lastIndexOf(currentTerm));
                // 获取当前检索式中，当前词之后的部分
                const afterCurrentTerm = fullQuery.substring(fullQuery.lastIndexOf(currentTerm) + currentTerm.length);
                
                // 检查是否是复杂检索式（包含布尔运算符）
                const isComplexQuery = /\b(AND|OR|NOT)\b/i.test(fullQuery);
                
                // 更新同义词建议
                synonymSuggestions.innerHTML = suggestions.synonyms.map(syn => `
                    <div class="suggestion-item" data-value="${beforeCurrentTerm}${syn.word}${afterCurrentTerm}" data-type="synonym">
                        <span>${syn.word}</span>
                        <span class="suggestion-score">${(syn.score * 100).toFixed(0)}%</span>
                    </div>
                `).join('');
                
                // 更新主题建议
                themeSuggestions.innerHTML = suggestions.themes.map(theme => `
                    <div class="suggestion-item" data-value="${beforeCurrentTerm}${theme.theme}${afterCurrentTerm}" data-type="theme">
                        <span>${theme.theme}</span>
                        <span class="suggestion-score">${(theme.relevance * 100).toFixed(0)}%</span>
                    </div>
                `).join('');
                
                // 更新布尔组合建议
                booleanSuggestions.innerHTML = suggestions.boolean_suggestions.map(suggestion => {
                    // 根据检索式复杂度决定是否添加括号
                    const suggestionText = isComplexQuery ? `(${suggestion})` : suggestion;
                    return `
                        <div class="suggestion-item boolean-suggestion" data-value="${beforeCurrentTerm}${suggestionText}${afterCurrentTerm}" data-type="boolean">
                            <span>${suggestion}</span>
                        </div>
                    `;
                }).join('');
                
                // 为所有建议项添加点击事件
                document.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const newValue = this.getAttribute('data-value');
                        const suggestionType = this.getAttribute('data-type');
                        
                        // 根据建议类型处理光标位置
                        let cursorPosition;
                        if (suggestionType === 'boolean') {
                            // 对于布尔组合，将光标定位到建议词的末尾
                            // 如果是复杂查询，则定位到右括号后，否则定位到最后一个词后
                            cursorPosition = newValue.length;
                        } else {
                            // 对于其他类型，将光标定位到替换词的末尾
                            const termLength = this.querySelector('span').textContent.length;
                            cursorPosition = beforeCurrentTerm.length + termLength;
                        }
                        
                        basicSearchInput.value = newValue;
                        basicSearchInput.setSelectionRange(cursorPosition, cursorPosition);
                        suggestionBox.classList.remove('show');
                        basicSearchInput.focus();
                    });
                });
                
                // 如果所有部分都为空，隐藏推荐框
                if (!suggestions.synonyms.length && !suggestions.themes.length && !suggestions.boolean_suggestions.length) {
                    suggestionBox.classList.remove('show');
                }
            }

            // 初始化页面
            init();
        });
    </script>
</body>
</html> 