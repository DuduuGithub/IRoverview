{% extends "base.html" %}

{% block content %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/static/search/favicon.png">
    <title>文献详情 | Document Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f5f5;
        }
        
        .header {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1rem 0;
        }
        
        .nav-link {
            color: var(--secondary-color);
            font-weight: 500;
        }
        
        .nav-link.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }
        
        .content-container {
            max-width: 1140px;
            margin: 2rem auto;
        }
        
        .document-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 2rem;
        }
        
        .sidebar {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 1.5rem;
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .language-switch {
            display: inline-block;
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
        }
        
        .document-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 1rem;
            line-height: 1.4;
            color: #333;
        }
        
        .document-meta {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .author-list {
            margin-bottom: 0.75rem;
        }
        
        .author-item {
            display: inline-block;
            margin-right: 1rem;
            color: #333;
            font-weight: 500;
        }
        
        .meta-item {
            display: inline-block;
            margin-right: 1.5rem;
            color: var(--secondary-color);
            font-size: 0.875rem;
        }
        
        .abstract-section {
            margin-bottom: 2rem;
        }
        
        .abstract-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            font-size: 1.25rem;
        }
        
        .abstract-content {
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .keywords-section {
            margin-bottom: 2rem;
        }
        
        .keyword-badge {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            margin: 0.25rem;
            background-color: #f0f7ff;
            color: var(--primary-color);
            border-radius: 50px;
            font-size: 0.875rem;
        }
        
        .references-section {
            margin-bottom: 2rem;
        }
        
        .reference-item {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px dashed var(--border-color);
        }
        
        .reference-item:last-child {
            border-bottom: none;
        }
        
        .reference-title {
            font-weight: 500;
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .reference-title:hover {
            text-decoration: underline;
        }
        
        .toc-section {
            margin-bottom: 1.5rem;
        }
        
        .toc-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }
        
        .toc-list {
            list-style-type: none;
            padding-left: 0;
        }
        
        .toc-item {
            margin-bottom: 0.5rem;
        }
        
        .toc-link {
            color: var(--secondary-color);
            text-decoration: none;
            display: block;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .toc-link:hover {
            background-color: var(--light-bg);
            color: var(--primary-color);
        }
        
        .toc-link.active {
            background-color: #e7f1ff;
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .citation-section {
            background-color: #f0f2f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .citation-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }
        
        .citation-formats {
            list-style-type: none;
            padding-left: 0;
        }
        
        .citation-item {
            margin-bottom: 0.75rem;
        }
        
        .citation-text {
            font-family: monospace;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }
        
        .copy-btn {
            background-color: transparent;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 0;
            font-size: 0.875rem;
            text-decoration: none;
        }
        
        .back-to-results {
            display: inline-block;
            margin-bottom: 1.5rem;
            color: var(--secondary-color);
            text-decoration: none;
        }
        
        .back-to-results:hover {
            color: var(--primary-color);
        }
        
        .related-section {
            margin-bottom: 0;
        }
        
        .related-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .related-item:last-child {
            border-bottom: none;
        }
        
        .related-title {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
            line-height: 1.4;
        }
        
        .related-title a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .related-title a:hover {
            text-decoration: underline;
        }
        
        .related-info {
            font-size: 0.8rem;
            color: var(--secondary-color);
        }
        
        .citation-count {
            font-weight: 600;
            color: #198754;
        }
        
        .footer {
            margin-top: 2rem;
            padding: 1rem 0;
            background-color: #333;
            color: white;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container content-container">
        <a href="javascript:history.back()" class="back-to-results">
            <i class="bi bi-arrow-left me-1"></i>
            返回检索结果
        </a>
        
        <div class="row g-4">
            <!-- 主内容区 -->
            <div class="col-md-8">
                <div class="document-container">
                    <h1 id="document-title" class="document-title">
                        {% if work and work.title %}
                            {{ work.title }}
                        {% else %}
                            无标题文献
                        {% endif %}
                    </h1>
                    
                    <div class="document-meta">
                        <div class="author-section" style="display: flex; align-items: baseline; margin-bottom: 0.75rem;">
                            <h2 class="abstract-title" style="margin-bottom: 0; margin-right: 1rem; line-height: 1.6;">作者:</h2>
                            <div id="author-list" class="author-list" style="display: inline; line-height: 1.6;">
                                {% if authors %}
                                    {% for author in authors %}
                                        <span class="author-item">{{ author }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="author-item">未知作者</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="meta-info">
                            <span id="publication-date" class="meta-item">
                                <i class="bi bi-calendar-event me-1"></i>
                                <span id="publication-year">
                                    {% if work and work.publication_year %}
                                        {{ work.publication_year }}
                                    {% else %}
                                        未知年份
                                    {% endif %}
                                </span>
                            </span>
                            <span id="publication-venue" class="meta-item">
                                <i class="bi bi-journal me-1"></i>
                                <span id="venue-name">
                                    {% if venue_name %}
                                        {{ venue_name }}
                                    {% else %}
                                        未知来源
                                    {% endif %}
                                </span>
                            </span>
                            <span id="citation-info" class="meta-item">
                                <i class="bi bi-diagram-3 me-1"></i>
                                被引用
                                <span id="citation-count" class="citation-count">
                                    {% if work and work.cited_by_count is defined %}
                                        {{ work.cited_by_count }}
                                    {% else %}
                                        0
                                    {% endif %}
                                </span>
                                次
                            </span>
                        </div>
                    </div>
                    
                    <div id="abstract-section" class="abstract-section">
                        <div class="citation-section">
                            <h3 class="citation-title">摘要</h3>
                            <div id="abstract-content" class="abstract-content">
                                {% if work and work.abstract_inverted_index %}
                                    {{ work.abstract_inverted_index }}
                                {% else %}
                                    <p>暂无摘要</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div id="keywords-section" class="keywords-section">
                        <h3 class="citation-title">关键词</h3>
                        <div id="keyword-list">
                            {% if concept_names %}
                                {% for concept in concept_names %}
                                    <span class="keyword-badge">{{ concept }}</span>{% if not loop.last %}  {% endif %}
                                {% endfor %}
                            {% else %}
                                <p>暂无关键词</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- 年度引用统计图部分 -->
                    <div id="citations-section" class="citations-section mb-4">
                        <h3 class="citation-title">年度引用统计图</h3>
                        <div class="chart-container" style="position: relative; height:400px;">
                            <canvas id="citationsChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- 引用关系图部分 -->
                    <div id="citation-network-section" class="citation-network-section mb-4">
                        <h2 class="abstract-title">引用关系图</h2>
                        <div class="iframe-container" style="position: relative; height:500px; border:1px solid #dee2e6; border-radius:8px; overflow:hidden;">
                            <iframe id="citationNetworkFrame" src="{{ url_for('reader.citation_network', doc_id=work.id) }}" 
                                    style="width:100%; height:100%; border:none;" 
                                    title="引用关系图">
                            </iframe>
                        </div>
                    </div>

                    <div class="citation-section">
                        <h3 class="citation-title">引用此文献</h3>
                        <ul class="citation-formats">
                            <li class="citation-item">
                                <div class="d-flex justify-content-between">
                                    <span>APA</span>
                                    <button class="copy-btn" onclick="copyToClipboard('apa-citation')"><i class="bi bi-clipboard"></i> 复制</button>
                                </div>
                                <div id="apa-citation" class="citation-text" style="font-size: 0.9rem; line-height: 1.6; padding: 0.5rem; color: #333; font-family: 'Times New Roman', Times, serif; text-align: left; position: relative;">
                                    正在生成引用格式...
                                </div>
                            </li>
                            <li class="citation-item">
                                <div class="d-flex justify-content-between">
                                    <span>BibTeX</span>
                                    <button class="copy-btn" onclick="copyToClipboard('bibtex-citation')"><i class="bi bi-clipboard"></i> 复制</button>
                                </div>
                                <div id="bibtex-citation" class="citation-text" style="font-family: 'Courier New', monospace; font-size: 0.85rem; line-height: 1.5; position: relative;">
                                    正在生成引用格式...
                                </div>
                            </li>
                        </ul>
                    </div>
                    
                    <div id="references-section" class="references-section">
                        <div id="references-list" class="citation-section">
                            <h3 class="citation-title">参考文献</h3>
                            {% if referenced_works %}
                                {% for ref in referenced_works %}
                                    <div class="reference-item">
                                        <div style="display: flex; align-items: baseline;">
                                            <span style="color: #333; min-width: 1.5rem;">{{ loop.index }}.</span> 
                                            <a href="{{ url_for('reader.document_detail', doc_id=ref.id) }}" class="reference-link" style="text-decoration: none; display: inline-block;">
                                                {{ ref.title }}
                                            </a>
                                        </div>
                                        <div class="reference-meta" style="margin-top: 0.5rem; font-size: 0.9rem; color: #555; margin-left: 1.5rem;">
                                            {% if ref.authors %}
                                                <span class="reference-authors">{{ ref.authors|join(', ') }}</span>
                                            {% else %}
                                                <span class="reference-authors">未知作者</span>
                                            {% endif %}
                                            
                                            {% if ref.cited_by_count is defined and ref.cited_by_count %}
                                                <span class="reference-citations" style="margin-left: 1rem;">
                                                    <i class="bi bi-diagram-3 me-1"></i>被引用 {{ ref.cited_by_count }} 次
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p>暂无参考文献信息</p>
                            {% endif %}
                        </div>
                    </div>

                    <div id="related-works-section" class="references-section">
                        <div id="related-works-list" class="citation-section">
                            <h3 class="citation-title">相关文献</h3>
                            {% if related_works %}
                                {% for rel in related_works %}
                                    <div class="reference-item">
                                        <div style="display: flex; align-items: baseline;">
                                            <span style="color: #333; min-width: 1.5rem;">{{ loop.index }}.</span> 
                                            <a href="{{ url_for('reader.document_detail', doc_id=rel.id) }}" class="reference-link" style="text-decoration: none; display: inline-block;">
                                                {{ rel.title }}
                                            </a>
                                        </div>
                                        <div class="reference-meta" style="margin-top: 0.5rem; font-size: 0.9rem; color: #555; margin-left: 1.5rem;">
                                            {% if rel.authors %}
                                                <span class="reference-authors">{{ rel.authors|join(', ') }}</span>
                                            {% else %}
                                                <span class="reference-authors">未知作者</span>
                                            {% endif %}
                                            
                                            {% if rel.cited_by_count is defined and rel.cited_by_count %}
                                                <span class="reference-citations" style="margin-left: 1rem;">
                                                    <i class="bi bi-diagram-3 me-1"></i>被引用 {{ rel.cited_by_count }} 次
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p>暂无相关文献信息</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 侧边栏 -->
            <div class="col-md-4">
                <div class="sidebar">
                    <div class="toc-section">
                        <h3 class="toc-title">目录</h3>
                        <ul class="toc-list">
                            <li class="toc-item">
                                <a href="#abstract-section" class="toc-link active">摘要</a>
                            </li>
                            <li class="toc-item">
                                <a href="#keywords-section" class="toc-link">关键词</a>
                            </li>
                            <li class="toc-item">
                                <a href="#citations-section" class="toc-link">年度引用统计图</a>
                            </li>
                            <li class="toc-item">
                                <a href="#citation-network-section" class="toc-link">引用关系图</a>
                            </li>
                            <li class="toc-item">
                                <a href="#references-section" class="toc-link">参考文献</a>
                            </li>
                            <li class="toc-item">
                                <a href="#related-works-section" class="toc-link">相关文献</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
// 记录脚本开始执行的时间
const scriptStartTime = new Date();
console.log('[用户行为] 脚本开始执行时间:', scriptStartTime.toISOString());
console.log('[用户行为] 开始加载文档详情页');
console.log('[用户行为] 当前URL:', window.location.href);

// 将标题转换为APA格式的sentence case
function toSentenceCase(text) {
    if (!text) return "";
    
    // 将整个字符串转换为小写
    let result = text.toLowerCase();
    
    // 将第一个字母转换为大写
    result = result.charAt(0).toUpperCase() + result.slice(1);
    
    // 处理常见专有名词（示例）
    const properNouns = [
        /\b(covid-19)\b/gi, /\b(ai)\b/gi, /\b(ml)\b/gi, 
        /\b(usa)\b/gi, /\b(uk)\b/gi, /\b(eu)\b/gi,
        /\b(internet)\b/gi, /\b(web)\b/gi, /\b(google)\b/gi, 
        /\b(facebook)\b/gi, /\b(twitter)\b/gi, /\b(android)\b/gi, 
        /\b(ios)\b/gi, /\b(windows)\b/gi, /\b(linux)\b/gi, 
        /\b(macos)\b/gi, /\b(unix)\b/gi, /\b(python)\b/gi,
        /\b(java)\b/gi, /\b(javascript)\b/gi, /\b(c\+\+)\b/gi
    ];
    
    // 将冒号后面的第一个字母转为大写
    result = result.replace(/:\s*([a-z])/g, function(match, p1) {
        return ': ' + p1.toUpperCase();
    });
    
    // 将专有名词转为正确的大小写
    properNouns.forEach(function(regex) {
        result = result.replace(regex, function(match) {
            // 获取匹配的专有名词的正确大小写形式
            switch(match.toLowerCase()) {
                case 'covid-19': return 'COVID-19';
                case 'ai': return 'AI';
                case 'ml': return 'ML';
                case 'usa': return 'USA';
                case 'uk': return 'UK';
                case 'eu': return 'EU';
                case 'internet': return 'Internet';
                case 'web': return 'Web';
                case 'google': return 'Google';
                case 'facebook': return 'Facebook';
                case 'twitter': return 'Twitter';
                case 'android': return 'Android';
                case 'ios': return 'iOS';
                case 'windows': return 'Windows';
                case 'linux': return 'Linux';
                case 'macos': return 'macOS';
                case 'unix': return 'UNIX';
                case 'python': return 'Python';
                case 'java': return 'Java';
                case 'javascript': return 'JavaScript';
                case 'c++': return 'C++';
                default: return match;
            }
        });
    });
    
    return result;
}

// 格式化作者列表为APA格式
function formatAuthors(authors) {
    if (!authors || authors.length === 0) {
        return "";
    }
    
    let formatted = [];
    for (let author of authors) {
        // 按空格分割名字
        const parts = author.trim().split(/\s+/);
        if (parts.length >= 2) {
            // 姓氏放在前面，名字缩写为首字母加点
            const lastName = parts[parts.length - 1];
            const initials = parts.slice(0, parts.length - 1).map(part => part[0] + ".").join(" ");
            formatted.push(`${lastName}, ${initials}`);
        } else {
            formatted.push(author);
        }
    }
    
    // APA格式：前19个作者，然后省略号，然后最后一个作者
    if (formatted.length === 1) {
        return formatted[0];
    } else if (formatted.length <= 20) {
        return formatted.slice(0, -1).join(", ") + ", & " + formatted[formatted.length - 1];
    } else {
        return formatted.slice(0, 19).join(", ") + ", ... " + formatted[formatted.length - 1];
    }
}

// 根据文献类型生成APA引用格式
function generateApaCitation(docData) {
    // 如果没有文献数据，返回空字符串
    if (!docData) {
        return "暂无引用信息";
    }
    
    const type = docData.type || "article";
    const authors = formatAuthors(docData.authors || []);
    const year = docData.publication_year || "n.d."; // n.d. 表示 "no date"
    const title = toSentenceCase(docData.title) || "[无标题]";
    const container = docData.venue_name || "";
    const publisher = docData.publisher || "";
    const volume = docData.volume || "";
    const issue = docData.issue || "";
    const pages = docData.pages || "";
    const doi = docData.doi || "";
    
    let citation = "";
    
    // 根据文献类型生成不同格式的引用
    if (["article", "erratum", "letter", "editorial", "peer-review"].includes(type)) {
        // 期刊文章：作者. (年份). 标题. 期刊名(斜体), 卷(期), 页码. DOI
        citation = `${authors} (${year}). ${title}. <em>${container}</em>`;
        if (volume) {
            citation += `, ${volume}`;
            if (issue) {
                citation += `(${issue})`;
            }
        }
        if (pages) {
            citation += `, ${pages}`;
        }
        citation += ".";
    } 
    else if (type === "book") {
        // 书籍：作者. (年份). 书名(斜体). 出版商.
        citation = `${authors} (${year}). <em>${title}</em>. ${publisher}.`;
    }
    else if (type === "book-chapter") {
        // 书籍章节：作者. (年份). 章节标题. In 编辑 (Ed.), 书名(斜体) (pp. 页码). 出版商.
        citation = `${authors} (${year}). ${title}. In (Ed.), <em>${container}</em>`;
        if (pages) {
            citation += ` (pp. ${pages})`;
        }
        citation += `. ${publisher}.`;
    }
    else if (type === "report") {
        // 报告：作者. (年份). 报告标题(斜体) (Report). 出版商.
        citation = `${authors} (${year}). <em>${title}</em> (Report). ${publisher}.`;
    }
    else if (type === "dissertation") {
        // 学位论文：作者. (年份). 标题(斜体) (Doctoral dissertation). 机构.
        citation = `${authors} (${year}). <em>${title}</em> (Doctoral dissertation). ${publisher || "Unknown institution"}.`;
    }
    else if (type === "dataset") {
        // 数据集：作者. (年份). 标题(斜体) [Data set]. 出版商.
        citation = `${authors} (${year}). <em>${title}</em> [Data set]. ${publisher}.`;
    }
    else if (type === "reference-entry") {
        // 参考条目：作者. (年份). 标题. In 参考工具名(斜体). 出版商.
        citation = `${authors} (${year}). ${title}. In <em>${container}</em>. ${publisher}.`;
    }
    else if (type === "standard") {
        // 标准：作者. (年份). 标题(斜体) (Standard). 出版商.
        citation = `${authors} (${year}). <em>${title}</em> (Standard). ${publisher}.`;
    }
    else if (type === "grant") {
        // 资助：作者. (年份). 标题(斜体) [Grant description]. 出版商.
        citation = `${authors} (${year}). <em>${title}</em> [Grant description]. ${publisher}.`;
    }
    else if (type === "paratext") {
        // 其他文本：作者. (年份). 标题(斜体). 出版商.
        citation = `${authors} (${year}). <em>${title}</em>. ${publisher}.`;
    }
    else {
        // 默认格式：作者. (年份). 标题(斜体). 出版商.
        citation = `${authors} (${year}). <em>${title}</em>. ${publisher}.`;
    }
    
    // 添加DOI（如果有）
    if (doi) {
        // 处理DOI：如果DOI已经包含完整URL则直接使用，否则构建标准URL
        if (doi.startsWith('http')) {
            citation += ` ${doi}`;
        } else if (doi.startsWith('doi.org/') || doi.startsWith('https://doi.org/')) {
            citation += ` https://${doi.replace('https://', '')}`;
        } else {
            // 保留完整的DOI路径，而不只是最后一部分
            citation += ` https://doi.org/${doi}`;
        }
    }
    
    return citation;
}

// 为BibTeX标题中的专有名词添加保护性大括号
function protectBibTeXTitle(title) {
    if (!title) return "";
    
    // 定义需要保护的专有名词和缩写词列表
    const properNouns = [
        /\b(COVID-19)\b/g, /\b(AI)\b/g, /\b(ML)\b/g, 
        /\b(USA)\b/g, /\b(UK)\b/g, /\b(EU)\b/g,
        /\b(Internet)\b/g, /\b(Web)\b/g, /\b(Google)\b/g, 
        /\b(Facebook)\b/g, /\b(Twitter)\b/g, /\b(Android)\b/g, 
        /\b(iOS)\b/g, /\b(Windows)\b/g, /\b(Linux)\b/g, 
        /\b(macOS)\b/g, /\b(UNIX)\b/g, /\b(Python)\b/g,
        /\b(Java)\b/g, /\b(JavaScript)\b/g, /\b(C\+\+)\b/g
    ];
    
    // 保护专有名词，添加大括号
    properNouns.forEach(regex => {
        title = title.replace(regex, '{$&}');
    });
    
    return title;
}

// 生成BibTeX引用格式
function generateBibTeX(docData) {
    if (!docData) {
        return "暂无BibTeX信息";
    }
    
    const id = docData.id || "doc";
    const authors = (docData.authors || []).join(" and ");
    const year = docData.publication_year || "";
    // 将标题转换为sentence case，并为专有名词添加保护性大括号
    const title = protectBibTeXTitle(toSentenceCase(docData.title)) || "";
    const journal = docData.venue_name || "";
    const volume = docData.volume || "";
    const issue = docData.issue || "";
    const pages = docData.pages || "";
    const doi = docData.doi || "";
    const publisher = docData.publisher || "";
    const type = docData.type || "article";
    
    let bibtex = "";
    
    if (["article", "erratum", "letter", "editorial", "peer-review"].includes(type)) {
        bibtex = `@article{${id},
  author = {${authors}},
  year = {${year}},
  title = {${title}},
  journal = {${journal}}`;
        
        if (volume) bibtex += `,\n  volume = {${volume}}`;
        if (issue) bibtex += `,\n  number = {${issue}}`;
        if (pages) bibtex += `,\n  pages = {${pages}}`;
        if (doi) bibtex += `,\n  doi = {${doi}}`;
        
        bibtex += "\n}";
    } 
    else if (type === "book") {
        bibtex = `@book{${id},
  author = {${authors}},
  year = {${year}},
  title = {${title}},
  publisher = {${publisher}}`;
        
        if (doi) bibtex += `,\n  doi = {${doi}}`;
        
        bibtex += "\n}";
    }
    else if (type === "book-chapter") {
        bibtex = `@incollection{${id},
  author = {${authors}},
  year = {${year}},
  title = {${title}},
  booktitle = {${journal}},
  publisher = {${publisher}}`;
        
        if (pages) bibtex += `,\n  pages = {${pages}}`;
        if (doi) bibtex += `,\n  doi = {${doi}}`;
        
        bibtex += "\n}";
    }
    else {
        // 默认为 misc 类型
        bibtex = `@misc{${id},
  author = {${authors}},
  year = {${year}},
  title = {${title}}`;
        
        if (journal) bibtex += `,\n  howpublished = {${journal}}`;
        if (publisher) bibtex += `,\n  publisher = {${publisher}}`;
        if (doi) bibtex += `,\n  doi = {${doi}}`;
        
        bibtex += "\n}";
    }
    
    return bibtex;
}

document.addEventListener('DOMContentLoaded', function() {
    const domLoadedTime = new Date();
    console.log('[用户行为] DOM加载完成时间:', domLoadedTime.toISOString());
    console.log('[用户行为] 从脚本开始到DOM加载完成耗时:', domLoadedTime - scriptStartTime, 'ms');
    
    // 处理目录链接点击事件
    document.querySelectorAll('.toc-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                // 平滑滚动到目标元素
                targetElement.scrollIntoView({ behavior: 'smooth' });
                
                // 更新活动状态
                document.querySelectorAll('.toc-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
            }
        });
    });
    
    // 生成引用格式
    const documentData = JSON.parse('{{ document_data|tojson|safe }}');
    
    // 生成APA格式引用
    const apaCitation = generateApaCitation(documentData);
    document.getElementById('apa-citation').innerHTML = apaCitation;
    
    // 生成BibTeX格式引用
    const bibtexCitation = generateBibTeX(documentData);
    document.getElementById('bibtex-citation').textContent = bibtexCitation;
    
    // 复制引用到剪贴板的函数
    window.copyToClipboard = function(elementId) {
        const element = document.getElementById(elementId);
        
        // 创建一个临时textarea元素
        const textarea = document.createElement('textarea');
        
        // 如果内容包含HTML标签（如斜体），处理HTML
        if (elementId === 'apa-citation') {
            // 创建临时元素来解析HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = element.innerHTML;
            
            // 获取纯文本内容
            let textContent = tempDiv.textContent || tempDiv.innerText;
            
            // 找到所有斜体元素并在其前后添加星号(*)
            const italicElements = element.getElementsByTagName('em');
            if (italicElements.length > 0) {
                // 创建一个新的div用于处理带星号的文本
                const processedDiv = document.createElement('div');
                processedDiv.innerHTML = element.innerHTML;
                
                // 将所有<em>标签替换为带星号的文本
                Array.from(processedDiv.getElementsByTagName('em')).forEach((emElement) => {
                    const spanElement = document.createElement('span');
                    spanElement.textContent = '*' + emElement.textContent + '*';
                    emElement.parentNode.replaceChild(spanElement, emElement);
                });
                
                // 使用处理后的文本
                textContent = processedDiv.textContent || processedDiv.innerText;
            }
            
            textarea.value = textContent;
        } else {
            textarea.value = element.textContent || element.innerText;
        }
        
        document.body.appendChild(textarea);
        textarea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                // 显示成功提示
                alert('已复制到剪贴板');
            } else {
                console.error('复制失败');
            }
        } catch (err) {
            console.error('复制出错:', err);
        }
        
        document.body.removeChild(textarea);
    };
    
    // 监听滚动事件，更新目录活动状态
    const sections = document.querySelectorAll('div[id$="-section"]');
    window.addEventListener('scroll', function() {
        let currentSectionId = null;
        sections.forEach(section => {
            const sectionTop = section.offsetTop;
            const sectionHeight = section.clientHeight;
            if (window.pageYOffset >= sectionTop - 200 && 
                window.pageYOffset < sectionTop + sectionHeight - 200) {
                currentSectionId = section.id;
            }
        });
        
        if (currentSectionId) {
            document.querySelectorAll('.toc-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + currentSectionId) {
                    link.classList.add('active');
                }
            });
        }
    });
    
    // 从模板变量获取session_id和文档ID
    const sessionId = '{{ document_data.session_id }}';  // 从document_data中获取session_id
    const docId = '{{ work.id }}';
    
    console.log('[用户行为] 参数初始化时间:', new Date().toISOString());
    console.log('[用户行为] 参数检查:', {
        sessionId: sessionId,
        docId: docId,
        workId: '{{ work.id }}',
        documentData: {{ document_data|tojson }},
        loadTimestamp: new Date().toISOString()
    });
    
    if (!sessionId) {
        console.warn('[用户行为] 警告：没有session_id');
        return;  // 如果没有session_id，直接返回
    }
    if (!docId) {
        console.error('[用户行为] 错误：无法获取文档ID');
        return;
    }
    
    let startTime = Date.now();
    let isRecording = true;
    
    // 记录点击
    function recordClick() {
        const clickTime = new Date();
        console.log('[用户行为] 开始记录点击，时间:', clickTime.toISOString());
        console.log('[用户行为] 准备记录点击:', {
            sessionId: sessionId,
            docId: docId,
            url: '/search/api/basic/record_click',
            timestamp: clickTime.toISOString()
        });
        
        fetch('/search/api/basic/record_click', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionId,
                document_id: docId
            })
        })
        .then(response => {
            console.log('[用户行为] 点击记录响应状态:', response.status, '时间:', new Date().toISOString());
            return response.json();
        })
        .then(data => {
            console.log('[用户行为] 点击记录成功:', data, '时间:', new Date().toISOString());
        })
        .catch(error => {
            console.error('[用户行为] 点击记录失败:', error, '时间:', new Date().toISOString());
        });
    }
    
    // 记录停留时间
    function recordDwellTime() {
        const recordTime = new Date();
        if (!isRecording || !sessionId) {
            console.warn('[用户行为] 停留时间记录已完成或没有session_id, 时间:', recordTime.toISOString());
            return;
        }
        
        const endTime = Date.now();
        const dwellTime = Math.floor((endTime - startTime) / 1000);
        
        console.log('[用户行为] 准备记录停留时间:', {
            sessionId: sessionId,
            docId: docId,
            dwellTime: dwellTime,
            startTime: new Date(startTime).toLocaleString(),
            endTime: new Date(endTime).toLocaleString(),
            url: '/search/api/basic/record_dwell_time',
            timestamp: recordTime.toISOString()
        });
        
        if (dwellTime <= 0) {
            console.warn('[用户行为] 停留时间过短，不记录, 时间:', recordTime.toISOString());
            return;
        }
        
        fetch('/search/api/basic/record_dwell_time', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionId,
                document_id: docId,
                dwell_time: dwellTime
            })
        })
        .then(response => {
            console.log('[用户行为] 停留时间记录响应状态:', response.status, '时间:', new Date().toISOString());
            return response.json();
        })
        .then(data => {
            console.log('[用户行为] 停留时间记录成功:', data, '时间:', new Date().toISOString());
            isRecording = false;
        })
        .catch(error => {
            console.error('[用户行为] 停留时间记录失败:', error, '时间:', new Date().toISOString());
        });
    }
    
    // 初始化时记录点击
    console.log('[用户行为] 开始初始化点击记录, 时间:', new Date().toISOString());
    recordClick();
    
    // 页面关闭时记录停留时间
    window.addEventListener('beforeunload', function(e) {
        const unloadTime = new Date();
        console.log('[用户行为] 页面即将关闭，记录停留时间, 时间:', unloadTime.toISOString());
        recordDwellTime();
    });
    
    // 页面隐藏时记录停留时间
    document.addEventListener('visibilitychange', function() {
        const visibilityTime = new Date();
        if (document.hidden) {
            console.log('[用户行为] 页面隐藏，记录停留时间, 时间:', visibilityTime.toISOString());
            recordDwellTime();
        } else {
            console.log('[用户行为] 页面重新可见，重置开始时间, 时间:', visibilityTime.toISOString());
            startTime = Date.now();
            isRecording = true;
        }
    });
    
    // 定期保存停留时间（每60秒）
    setInterval(function() {
        if (!document.hidden) {
            const intervalTime = new Date();
            console.log('[用户行为] 定期保存停留时间, 时间:', intervalTime.toISOString());
            recordDwellTime();
            startTime = Date.now();
            isRecording = true;
        }
    }, 60000);
    
    console.log('[用户行为] 事件监听器设置完成, 时间:', new Date().toISOString());
    
    // 初始化引用统计图
    const citationData = {{ citation_data|tojson }};
    const ctx = document.getElementById('citationsChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: citationData.years,
            datasets: [{
                label: '年度被引用次数',
                data: citationData.citations,
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '被引用次数'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: '年份'
                    }
                }
            },
            plugins: {
                title: {
                    display: false
                },
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
});

// 记录页面完全加载完成的时间
window.addEventListener('load', function() {
    console.log('[用户行为] 页面完全加载完成时间:', new Date().toISOString());
});
</script>

<!-- 添加样式 -->
<style>
.content-text {
    white-space: pre-wrap;
    line-height: 1.6;
}

.authors li {
    margin-bottom: 0.5rem;
}

.metadata p {
    margin-bottom: 0.5rem;
}

.abstract, .content {
    margin-top: 2rem;
}

#citationNetwork {
    border: 1px solid #ddd;
    border-radius: 4px;
}
</style>
{% endblock %} 
