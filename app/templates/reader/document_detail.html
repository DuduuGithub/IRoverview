{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- 文档内容 -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h1 class="card-title">{{ work.title or work.display_name }}</h1>
                    
                    <!-- 作者信息 -->
                    <div class="authors mb-3">
                        <h5>作者</h5>
                        <ul class="list-unstyled">
                            {% for author in authors %}
                            <li>
                                {{ author.name }}
                                {% if author.institution %}
                                <small class="text-muted">({{ author.institution }})</small>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    
                    <!-- 元数据 -->
                    <div class="metadata mb-3">
                        <p><strong>发表年份：</strong> {{ work.publication_year }}</p>
                        <p><strong>引用次数：</strong> {{ work.cited_by_count or 0 }}</p>
                    </div>
                    
                    <!-- 摘要 -->
                    {% if work.abstract_inverted_index %}
                    <div class="abstract mb-3">
                        <h5>摘要</h5>
                        <p>{{ work.abstract_inverted_index }}</p>
                    </div>
                    {% endif %}
                    
                    <!-- 全文内容 -->
                    {% if work.content %}
                    <div class="content">
                        <h5>全文</h5>
                        <div class="content-text">
                            {{ work.content | safe }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- 侧边栏 -->
        <div class="col-md-4">
            <!-- 引用网络 -->
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">引用网络</h5>
                    <div id="citationNetwork" style="height: 300px;"></div>
                </div>
            </div>
            
            <!-- 相关文档 -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">相关文档</h5>
                    <div id="relatedDocuments">
                        <!-- 相关文档将通过JavaScript动态加载 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加必要的JavaScript -->
<script>
console.log('[用户行为] 开始加载文档详情页');
console.log('[用户行为] 当前URL:', window.location.href);

document.addEventListener('DOMContentLoaded', function() {
    console.log('[用户行为] DOM加载完成');
    
    // 从URL获取session_id
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session_id');
    const docId = {{ work.id }};
    let startTime = Date.now();
    let isRecording = true;  // 标记是否正在记录时间
    
    console.log(`[用户行为] 页面加载:
        - 文档ID: ${docId}
        - 会话ID: ${sessionId || '未提供'}
        - 开始时间: ${new Date(startTime).toLocaleString()}
        - URL: ${window.location.href}
    `);
    
    // 加载引用网络
    function loadCitationNetwork() {
        fetch(`/reader/api/citation-network/${docId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('加载引用网络失败:', data.error);
                    return;
                }
                // 这里添加引用网络可视化的代码
                // 可以使用D3.js或其他可视化库
            })
            .catch(error => console.error('请求失败:', error));
    }
    
    // 记录停留时间
    function recordDwellTime() {
        if (!isRecording) return;  // 如果已经记录过了，就不再记录
        
        if (!sessionId) {
            console.warn('[用户行为] 没有有效的会话ID，无法记录停留时间');
            return;
        }
        
        const endTime = Date.now();
        const dwellTime = Math.floor((endTime - startTime) / 1000);
        
        console.log(`[用户行为] 计算停留时间:
            - 文档ID: ${docId}
            - 会话ID: ${sessionId}
            - 开始时间: ${new Date(startTime).toLocaleString()}
            - 结束时间: ${new Date(endTime).toLocaleString()}
            - 停留时间: ${dwellTime}秒
            - 当前URL: ${window.location.href}
        `);
        
        if (dwellTime <= 0) {
            console.warn('[用户行为] 停留时间过短，不记录');
            return;
        }
        
        // 使用 sendBeacon API 确保在页面关闭时也能发送请求
        const data = new Blob([JSON.stringify({
            session_id: sessionId,
            document_id: docId,
            dwell_time: dwellTime
        })], { type: 'application/json' });
        
        const success = navigator.sendBeacon('/api/record-dwell-time', data);
        
        if (success) {
            console.log(`[用户行为] 成功发送停留时间记录请求: ${dwellTime}秒`);
            isRecording = false;  // 标记已记录
        } else {
            console.error('[用户行为] 发送停留时间记录请求失败');
        }
    }
    
    // 页面加载时初始化
    loadCitationNetwork();
    
    // 页面关闭时记录停留时间
    window.addEventListener('beforeunload', function(e) {
        console.log('[用户行为] 页面即将关闭，记录停留时间');
        recordDwellTime();
    });
    
    // 页面隐藏时记录停留时间
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            console.log('[用户行为] 页面隐藏，记录停留时间');
            recordDwellTime();
        } else {
            console.log('[用户行为] 页面重新可见，重置开始时间');
            startTime = Date.now();
            isRecording = true;  // 重新开始记录
        }
    });
    
    // 定期保存停留时间（每60秒）
    setInterval(function() {
        if (!document.hidden) {
            console.log('[用户行为] 定期保存停留时间');
            recordDwellTime();
            startTime = Date.now();  // 重置开始时间
            isRecording = true;  // 允许继续记录
        }
    }, 60000);
    
    console.log('[用户行为] 事件监听器设置完成');
});
</script>

<!-- 添加样式 -->
<style>
.content-text {
    white-space: pre-wrap;
    line-height: 1.6;
}

.authors li {
    margin-bottom: 0.5rem;
}

.metadata p {
    margin-bottom: 0.5rem;
}

.abstract, .content {
    margin-top: 2rem;
}

#citationNetwork {
    border: 1px solid #ddd;
    border-radius: 4px;
}
</style>
{% endblock %} 