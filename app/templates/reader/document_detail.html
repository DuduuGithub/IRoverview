{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- 文档内容 -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h1 class="card-title">{{ work.title or work.display_name }}</h1>
                    
                    <!-- 作者信息 -->
                    <div class="authors mb-3">
                        <h5>作者</h5>
                        <ul class="list-unstyled">
                            {% for author in authors %}
                            <li>
                                {{ author.name }}
                                {% if author.institution %}
                                <small class="text-muted">({{ author.institution }})</small>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    
                    <!-- 元数据 -->
                    <div class="metadata mb-3">
                        <p><strong>发表年份：</strong> {{ work.publication_year }}</p>
                        <p><strong>引用次数：</strong> {{ work.cited_by_count or 0 }}</p>
                    </div>
                    
                    <!-- 摘要 -->
                    {% if work.abstract_inverted_index %}
                    <div class="abstract mb-3">
                        <h5>摘要</h5>
                        <p>{{ work.abstract_inverted_index }}</p>
                    </div>
                    {% endif %}
                    
                    <!-- 全文内容 -->
                    {% if work.content %}
                    <div class="content">
                        <h5>全文</h5>
                        <div class="content-text">
                            {{ work.content | safe }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- 侧边栏 -->
        <div class="col-md-4">
            <!-- 引用网络 -->
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">引用网络</h5>
                    <div id="citationNetwork" style="height: 300px;"></div>
                </div>
            </div>
            
            <!-- 相关文档 -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">相关文档</h5>
                    <div id="relatedDocuments">
                        <!-- 相关文档将通过JavaScript动态加载 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加必要的JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sessionId = '{{ session_id }}';
    const docId = {{ work.id }};
    let startTime = Date.now();
    
    // 加载引用网络
    function loadCitationNetwork() {
        fetch(`/reader/api/citation-network/${docId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('加载引用网络失败:', data.error);
                    return;
                }
                // 这里添加引用网络可视化的代码
                // 可以使用D3.js或其他可视化库
            })
            .catch(error => console.error('请求失败:', error));
    }
    
    // 记录停留时间
    function recordDwellTime() {
        const dwellTime = Math.floor((Date.now() - startTime) / 1000);
        fetch('/reader/api/record-dwell-time', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionId,
                document_id: docId,
                dwell_time: dwellTime
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('记录停留时间失败:', data.error);
            }
        })
        .catch(error => console.error('请求失败:', error));
    }
    
    // 页面加载时初始化
    loadCitationNetwork();
    
    // 页面关闭时记录停留时间
    window.addEventListener('beforeunload', recordDwellTime);
});
</script>

<!-- 添加样式 -->
<style>
.content-text {
    white-space: pre-wrap;
    line-height: 1.6;
}

.authors li {
    margin-bottom: 0.5rem;
}

.metadata p {
    margin-bottom: 0.5rem;
}

.abstract, .content {
    margin-top: 2rem;
}

#citationNetwork {
    border: 1px solid #ddd;
    border-radius: 4px;
}
</style>
{% endblock %} 