{% extends "base.html" %}

{% block title %}文献检索平台{% endblock %}

{% block styles %}
<style>
    /* 主搜索区域样式 */
    .search-section {
        background-color: #f8f9fa;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        position: relative;
    }

    /* 搜索类型切换 */
    .search-type-tabs {
        margin-bottom: 1rem;
    }

    .search-type-tabs .nav-link {
        color: #495057;
        border: none;
        padding: 0.5rem 1rem;
    }

    .search-type-tabs .nav-link.active {
        color: #0d6efd;
        border-bottom: 2px solid #0d6efd;
        background: none;
    }

    /* 搜索框样式 */
    .search-input-group {
        position: relative;
        margin-bottom: 1rem;
    }

    /* 高级搜索面板 */
    .advanced-search-panel {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-top: 1rem;
    }

    /* 检索式搜索面板 */
    .query-search-panel {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-top: 1rem;
    }

    /* AI助手侧边栏 */
    .ai-assistant-sidebar {
        position: fixed;
        right: 0;
        top: 0;
        width: 300px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        padding: 1rem;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        z-index: 1000;
    }

    .ai-assistant-sidebar.show {
        transform: translateX(0);
    }

    .ai-assistant-toggle {
        position: fixed;
        right: 20px;
        bottom: 20px;
        z-index: 1001;
    }

    /* 搜索结果样式 */
    .search-result-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        cursor: pointer;
        transition: transform 0.2s;
    }

    .search-result-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .result-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }

    .result-metadata {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 1rem;
    }

    .result-summary {
        color: #444;
        line-height: 1.5;
    }

    .pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 2rem;
    }

    .pagination .btn {
        min-width: 2.5rem;
    }

    .highlight {
        background-color: #fff3cd;
        padding: 0 2px;
        border-radius: 2px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- 主搜索区域 -->
        <div class="col-12">
            <div class="search-section">
                <!-- 搜索类型切换 -->
                <ul class="nav nav-tabs search-type-tabs" id="searchTypeTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="basic-tab" data-bs-toggle="tab" href="#basicSearch" role="tab">基本检索</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="advanced-tab" data-bs-toggle="tab" href="#advancedSearch" role="tab">高级检索</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="query-tab" data-bs-toggle="tab" href="#querySearch" role="tab">检索式检索</a>
                    </li>
                </ul>

                <!-- 搜索面板内容 -->
                <div class="tab-content" id="searchTabContent">
                    <!-- 基本检索 -->
                    <div class="tab-pane fade show active" id="basicSearch" role="tabpanel">
                        <div class="search-input-group">
                            <input type="text" class="form-control" id="searchInput" placeholder="请输入关键词...">
                            <button class="btn btn-primary" onclick="performSearch()">搜索</button>
                        </div>
                    </div>

                    <!-- 高级检索 -->
                    <div class="tab-pane fade" id="advancedSearch" role="tabpanel">
                        <div class="advanced-search-panel">
                            <form id="advancedSearchForm">
                                <div class="mb-3">
                                    <label class="form-label">标题</label>
                                    <input type="text" class="form-control" name="title">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">作者</label>
                                    <input type="text" class="form-control" name="author">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">关键词</label>
                                    <input type="text" class="form-control" name="keywords">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">发表时间</label>
                                    <div class="row">
                                        <div class="col">
                                            <input type="date" class="form-control" name="dateFrom">
                                        </div>
                                        <div class="col-auto">至</div>
                                        <div class="col">
                                            <input type="date" class="form-control" name="dateTo">
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">搜索</button>
                            </form>
                        </div>
                    </div>

                    <!-- 检索式检索 -->
                    <div class="tab-pane fade" id="querySearch" role="tabpanel">
                        <div class="query-search-panel">
                            <div class="mb-3">
                                <label class="form-label">检索式</label>
                                <textarea class="form-control" id="queryInput" rows="3" placeholder="请输入检索式..."></textarea>
                            </div>
                            <button class="btn btn-primary" onclick="performQuerySearch()">执行检索</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 搜索结果区域 -->
            <div id="searchResults">
                <!-- 搜索结果将通过JavaScript动态加载 -->
            </div>

            <!-- 分页区域 -->
            <div id="pagination" class="pagination"></div>
        </div>
    </div>
</div>

<!-- AI助手侧边栏 -->
<button class="btn btn-primary rounded-circle ai-assistant-toggle" onclick="toggleAIAssistant()">
    <i class="fas fa-robot"></i>
</button>

<div class="ai-assistant-sidebar" id="aiAssistant">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">AI检索助手</h5>
        <button type="button" class="btn-close" onclick="toggleAIAssistant()"></button>
    </div>
    <div class="mb-3">
        <label class="form-label">描述你的检索需求</label>
        <textarea class="form-control" id="aiInput" rows="4" placeholder="请描述你想检索的内容..."></textarea>
    </div>
    <button class="btn btn-primary w-100" onclick="getAIAssistance()">获取检索建议</button>
    <div id="aiSuggestions" class="mt-3">
        <!-- AI建议将在这里显示 -->
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 切换AI助手侧边栏
    function toggleAIAssistant() {
        const sidebar = document.getElementById('aiAssistant');
        sidebar.classList.toggle('show');
    }

    // 基本检索
    function performSearch(page = 1) {
        const keyword = document.getElementById('searchInput').value;
        
        fetch('/searcher/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                type: 'basic',
                keyword: keyword,
                page: page
            })
        })
        .then(response => response.json())
        .then(data => {
            displayResults(data.documents);
            displayPagination(data.current_page, data.total_pages);
        })
        .catch(error => {
            console.error('搜索出错:', error);
            document.getElementById('searchResults').innerHTML = '<p class="text-danger">搜索出错，请重试</p>';
        });
    }

    function displayResults(documents) {
        const resultsContainer = document.getElementById('searchResults');
        if (!documents || documents.length === 0) {
            resultsContainer.innerHTML = '<p>未找到相关文献</p>';
            return;
        }

        resultsContainer.innerHTML = documents.map(doc => `
            <div class="search-result-card" onclick="window.location.href='/searcher/document/${doc.id}'">
                <h3 class="result-title">${doc.title}</h3>
                <div class="result-metadata">
                    ${doc.author ? `作者: ${doc.author}` : ''}
                    ${doc.publish_date ? ` | 发表时间: ${doc.publish_date}` : ''}
                </div>
                <div class="result-summary">${doc.content || '暂无摘要'}</div>
            </div>
        `).join('');
    }

    function displayPagination(currentPage, totalPages) {
        const paginationContainer = document.getElementById('pagination');
        if (totalPages <= 1) {
            paginationContainer.innerHTML = '';
            return;
        }

        let html = '';
        
        // 上一页按钮
        html += `<button class="btn ${currentPage === 1 ? 'btn-secondary' : 'btn-primary'}" 
                         onclick="performSearch(${currentPage - 1})" 
                         ${currentPage === 1 ? 'disabled' : ''}>上一页</button>`;
        
        // 页码按钮
        for (let i = 1; i <= totalPages; i++) {
            html += `<button class="btn ${i === currentPage ? 'btn-primary' : 'btn-secondary'}" 
                             onclick="performSearch(${i})">${i}</button>`;
        }
        
        // 下一页按钮
        html += `<button class="btn ${currentPage === totalPages ? 'btn-secondary' : 'btn-primary'}" 
                         onclick="performSearch(${currentPage + 1})" 
                         ${currentPage === totalPages ? 'disabled' : ''}>下一页</button>`;
        
        paginationContainer.innerHTML = html;
    }

    // 添加回车键搜索功能
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });

    // 高级检索
    document.getElementById('advancedSearchForm').onsubmit = function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        // 实现高级检索逻辑
    }

    // 检索式检索
    function performQuerySearch() {
        const query = document.getElementById('queryInput').value;
        // 实现检索式检索逻辑
    }

    // 获取AI助手建议
    function getAIAssistance() {
        const userInput = document.getElementById('aiInput').value;
        // 实现AI助手建议逻辑
    }

    // 应用AI建议的检索式
    function applyAISuggestion(suggestion) {
        document.getElementById('queryInput').value = suggestion;
        // 切换到检索式检索标签
        document.getElementById('query-tab').click();
        // 关闭AI助手侧边栏
        toggleAIAssistant();
    }
</script>
{% endblock %}
