{% extends "base.html" %}

{% block title %}{{ document.title }} - 文献详情{% endblock %}

{% block styles %}
<style>
    .document-header {
        background-color: #f8f9fa;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .document-title {
        font-size: 1.8rem;
        color: #2c3e50;
        margin-bottom: 1rem;
    }

    .document-meta {
        color: #666;
        margin-bottom: 1.5rem;
    }

    .meta-item {
        margin-right: 2rem;
        display: inline-block;
    }

    .document-content {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
    }

    .section-title {
        font-size: 1.4rem;
        color: #2c3e50;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #eee;
    }
    
    /* 标签样式 */
    .keywords-container {
        margin-top: 1rem;
    }
    
    .keyword-tag {
        display: inline-block;
        background-color: #e9ecef;
        border-radius: 20px;
        padding: 0.3rem 0.8rem;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: #495057;
        cursor: pointer;
    }
    
    .keyword-tag:hover {
        background-color: #dee2e6;
    }

    /* 引用网络可视化 */
    .citation-network {
        height: 500px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
        position: relative;
    }
    
    .network-loader {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }
    
    /* 相关文献样式 */
    .related-papers {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
        padding: 2rem;
    }
    
    .paper-card {
        padding: 1rem;
        border: 1px solid #eee;
        border-radius: 8px;
        margin-bottom: 1rem;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .paper-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .paper-title {
        font-size: 1.1rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
    }
    
    .paper-meta {
        font-size: 0.9rem;
        color: #666;
    }

    .highlight {
        background-color: #fff3cd;
        padding: 0 2px;
        border-radius: 2px;
    }

    .action-buttons {
        margin-bottom: 2rem;
    }

    .action-buttons .btn {
        margin-right: 1rem;
    }
    
    /* 引用格式样式 */
    .citation-formats {
        font-family: monospace;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 4px;
        margin-bottom: 1rem;
        white-space: pre-wrap;
    }
    
    .format-selector {
        margin-bottom: 1rem;
    }
    
    /* 文章指标 */
    .metrics {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
        padding: 1.5rem;
    }
    
    .metric-item {
        text-align: center;
        padding: 1rem;
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }
    
    .metric-label {
        font-size: 0.9rem;
        color: #666;
    }
    
    /* Tab导航 */
    .nav-tabs {
        border-bottom: 1px solid #dee2e6;
        margin-bottom: 1.5rem;
    }
    
    .nav-tabs .nav-link {
        border: none;
        color: #495057;
        padding: 0.75rem 1rem;
    }
    
    .nav-tabs .nav-link.active {
        color: #2c3e50;
        font-weight: 600;
        border-bottom: 2px solid #2c3e50;
    }
    
    .tab-content {
        padding-top: 1rem;
    }
    
    .back-btn {
        margin-bottom: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- 返回按钮 -->
<div class="back-btn">
    <a href="javascript:history.back()" class="btn btn-outline-primary">
        <i class="fas fa-arrow-left"></i> 返回搜索结果
    </a>
</div>

<div class="document-header">
    <h1 class="document-title">{{ document.title }}</h1>
    <div class="document-meta">
        {% if document.author %}
        <span class="meta-item">
            <i class="fas fa-user"></i> 作者：{{ document.author }}
        </span>
        {% endif %}
        {% if document.publish_date %}
        <span class="meta-item">
            <i class="fas fa-calendar"></i> 发表时间：{{ document.publish_date.strftime('%Y-%m-%d') if document.publish_date else '未知' }}
        </span>
        {% endif %}
        {% if document.journal %}
        <span class="meta-item">
            <i class="fas fa-book"></i> 期刊：{{ document.journal }}
        </span>
        {% endif %}
        {% if document.doi %}
        <span class="meta-item">
            <i class="fas fa-fingerprint"></i> DOI：{{ document.doi }}
        </span>
        {% endif %}
    </div>
    
    <!-- 关键词标签 -->
    {% if document.keywords %}
    <div class="keywords-container">
        {% for keyword in document.keywords.split(',') %}
            <span class="keyword-tag" onclick="searchByKeyword('{{ keyword.strip() }}')">{{ keyword.strip() }}</span>
        {% endfor %}
    </div>
    {% endif %}
    
    <div class="action-buttons">
        <button class="btn btn-primary" onclick="downloadFullText()">
            <i class="fas fa-download"></i> 下载全文
        </button>
        <button class="btn btn-secondary" onclick="showCitationInfo()">
            <i class="fas fa-quote-right"></i> 引用信息
        </button>
        <button class="btn btn-outline-primary" onclick="saveToCollection()">
            <i class="fas fa-bookmark"></i> 收藏
        </button>
    </div>
</div>

<!-- 文章指标 -->
<div class="metrics row">
    <div class="col-md-3 metric-item">
        <div class="metric-value">{{ document.cited_by_count|default(0) }}</div>
        <div class="metric-label">引用次数</div>
    </div>
    <div class="col-md-3 metric-item">
        <div class="metric-value">{{ document.views_count|default(0) }}</div>
        <div class="metric-label">浏览次数</div>
    </div>
    <div class="col-md-3 metric-item">
        <div class="metric-value">{{ document.downloads_count|default(0) }}</div>
        <div class="metric-label">下载次数</div>
    </div>
    <div class="col-md-3 metric-item">
        <div class="metric-value">{{ document.score|default(0) }}</div>
        <div class="metric-label">相关性得分</div>
    </div>
</div>

<!-- Tab导航 -->
<ul class="nav nav-tabs" id="documentTabs" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" id="abstract-tab" data-bs-toggle="tab" href="#abstract" role="tab">摘要</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="citation-tab" data-bs-toggle="tab" href="#citation" role="tab">引用网络</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="related-tab" data-bs-toggle="tab" href="#related" role="tab">相关文献</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="details-tab" data-bs-toggle="tab" href="#details" role="tab">详细信息</a>
    </li>
</ul>

<!-- Tab内容 -->
<div class="tab-content" id="documentTabContent">
    <!-- 摘要 -->
    <div class="tab-pane fade show active" id="abstract" role="tabpanel">
        <div class="document-content">
            <h2 class="section-title">摘要</h2>
            <div class="abstract">
                {{ document.content }}
            </div>
        </div>
    </div>
    
    <!-- 引用网络 -->
    <div class="tab-pane fade" id="citation" role="tabpanel">
        <div class="document-content">
            <h2 class="section-title">引用网络</h2>
            <div id="citationNetwork" class="citation-network">
                <div class="network-loader">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p>正在加载引用网络...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 相关文献 -->
    <div class="tab-pane fade" id="related" role="tabpanel">
        <div class="related-papers">
            <h2 class="section-title">相关文献</h2>
            <div id="relatedPapers">
                <!-- 相关文献将在这里动态生成 -->
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p>正在加载相关文献...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 详细信息 -->
    <div class="tab-pane fade" id="details" role="tabpanel">
        <div class="document-content">
            <h2 class="section-title">详细信息</h2>
            <table class="table table-striped">
                <tbody>
                    <tr>
                        <th>标题</th>
                        <td>{{ document.title }}</td>
                    </tr>
                    <tr>
                        <th>作者</th>
                        <td>{{ document.author }}</td>
                    </tr>
                    <tr>
                        <th>发表时间</th>
                        <td>{{ document.publish_date.strftime('%Y-%m-%d') if document.publish_date else '未知' }}</td>
                    </tr>
                    {% if document.journal %}
                    <tr>
                        <th>期刊</th>
                        <td>{{ document.journal }}</td>
                    </tr>
                    {% endif %}
                    {% if document.volume %}
                    <tr>
                        <th>卷号</th>
                        <td>{{ document.volume }}</td>
                    </tr>
                    {% endif %}
                    {% if document.issue %}
                    <tr>
                        <th>期号</th>
                        <td>{{ document.issue }}</td>
                    </tr>
                    {% endif %}
                    {% if document.pages %}
                    <tr>
                        <th>页码</th>
                        <td>{{ document.pages }}</td>
                    </tr>
                    {% endif %}
                    {% if document.doi %}
                    <tr>
                        <th>DOI</th>
                        <td>{{ document.doi }}</td>
                    </tr>
                    {% endif %}
                    {% if document.publisher %}
                    <tr>
                        <th>出版商</th>
                        <td>{{ document.publisher }}</td>
                    </tr>
                    {% endif %}
                    {% if document.language %}
                    <tr>
                        <th>语言</th>
                        <td>{{ document.language }}</td>
                    </tr>
                    {% endif %}
                    {% if document.keywords %}
                    <tr>
                        <th>关键词</th>
                        <td>{{ document.keywords }}</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 引用信息模态框 -->
<div class="modal" id="citationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">引用信息</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="format-selector">
                    <label for="citationFormat">选择引用格式:</label>
                    <select id="citationFormat" class="form-select" onchange="changeCitationFormat()">
                        <option value="apa">APA</option>
                        <option value="mla">MLA</option>
                        <option value="chicago">Chicago</option>
                        <option value="harvard">Harvard</option>
                        <option value="bibtex">BibTeX</option>
                    </select>
                </div>
                
                <div id="citationText" class="citation-formats">
                    <!-- 引用文本将在这里显示 -->
                </div>
                
                <button class="btn btn-primary" onclick="copyCitation()">
                    <i class="fas fa-copy"></i> 复制引用
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 存储会话信息的隐藏字段 -->
<input type="hidden" id="sessionId" value="{{ session_id }}">
<input type="hidden" id="documentId" value="{{ document.id }}">
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
    let startTime = Date.now();
    let isPageVisible = true;

    // 页面可见性变化处理
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            isPageVisible = false;
            recordDwellTime();
        } else {
            isPageVisible = true;
            startTime = Date.now();
        }
    });

    // 页面卸载前记录停留时间
    window.addEventListener('beforeunload', function() {
        recordDwellTime();
    });

    // 记录停留时间
    function recordDwellTime() {
        const sessionId = document.getElementById('sessionId').value;
        const documentId = document.getElementById('documentId').value;
        
        if (!sessionId || !isPageVisible) return;
        
        const dwellTime = Math.floor((Date.now() - startTime) / 1000); // 转换为秒
        
        fetch('/searcher/api/record-dwell-time', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_id: sessionId,
                document_id: documentId,
                dwell_time: dwellTime
            })
        }).catch(error => console.error('Error recording dwell time:', error));
    }

    // 下载全文功能
    function downloadFullText() {
        const documentId = document.getElementById('documentId').value;
        
        fetch(`/searcher/api/download/${documentId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('下载失败');
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = '{{ document.title }}.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                alert('下载文件失败: ' + error.message);
            });
    }

    // 显示引用信息
    function showCitationInfo() {
        // 初始化引用文本
        changeCitationFormat();
        
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('citationModal'));
        modal.show();
    }
    
    // 改变引用格式
    function changeCitationFormat() {
        const format = document.getElementById('citationFormat').value;
        const citationTextElement = document.getElementById('citationText');
        const documentId = document.getElementById('documentId').value;
        
        fetch(`/searcher/api/citation/${documentId}?format=${format}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    citationTextElement.textContent = `获取引用格式失败: ${data.error}`;
                    return;
                }
                
                citationTextElement.textContent = data.citation;
            })
            .catch(error => {
                citationTextElement.textContent = `获取引用格式失败: ${error.message}`;
            });
    }
    
    // 复制引用文本
    function copyCitation() {
        const citationText = document.getElementById('citationText').textContent;
        
        navigator.clipboard.writeText(citationText)
            .then(() => {
                alert('引用信息已复制到剪贴板');
            })
            .catch(err => {
                alert('复制失败: ' + err);
            });
    }
    
    // 收藏文档
    function saveToCollection() {
        const documentId = document.getElementById('documentId').value;
        
        fetch('/searcher/api/save-to-collection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                document_id: documentId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(`收藏失败: ${data.error}`);
                return;
            }
            
            alert('文档已成功收藏');
        })
        .catch(error => {
            alert(`请求失败: ${error.message}`);
        });
    }

    // 初始化引用网络可视化
    function initCitationNetwork() {
        const documentId = document.getElementById('documentId').value;
        
        fetch(`/searcher/api/citation-network/${documentId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('citationNetwork').innerHTML = 
                        `<div class="alert alert-warning">获取引用网络失败: ${data.error}</div>`;
                    return;
                }
                
                renderCitationNetwork(data);
            })
            .catch(error => {
                document.getElementById('citationNetwork').innerHTML = 
                    `<div class="alert alert-warning">获取引用网络失败: ${error.message}</div>`;
            });
    }
    
    // 渲染引用网络
    function renderCitationNetwork(data) {
        const container = document.getElementById('citationNetwork');
        container.innerHTML = ''; // 清除加载提示
        
        const width = container.clientWidth;
        const height = container.clientHeight;
        
        // 创建SVG容器
        const svg = d3.select(container)
            .append('svg')
            .attr('width', width)
            .attr('height', height);
        
        // 创建模拟力
        const simulation = d3.forceSimulation(data.nodes)
            .force('link', d3.forceLink(data.links).id(d => d.id).distance(100))
            .force('charge', d3.forceManyBody().strength(-300))
            .force('center', d3.forceCenter(width / 2, height / 2));
        
        // 创建连线
        const link = svg.append('g')
            .selectAll('line')
            .data(data.links)
            .enter()
            .append('line')
            .attr('stroke', '#999')
            .attr('stroke-opacity', 0.6)
            .attr('stroke-width', d => Math.sqrt(d.value || 1));
        
        // 创建节点
        const node = svg.append('g')
            .selectAll('circle')
            .data(data.nodes)
            .enter()
            .append('circle')
            .attr('r', d => d.main ? 10 : 5)
            .attr('fill', d => d.main ? '#ff7675' : '#74b9ff')
            .call(drag(simulation));
        
        // 添加节点标签
        const label = svg.append('g')
            .selectAll('text')
            .data(data.nodes)
            .enter()
            .append('text')
            .text(d => d.name)
            .attr('font-size', '10px')
            .attr('dx', 12)
            .attr('dy', 4);
        
        // 更新节点位置
        simulation.on('tick', () => {
            link
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);
            
            node
                .attr('cx', d => d.x)
                .attr('cy', d => d.y);
            
            label
                .attr('x', d => d.x)
                .attr('y', d => d.y);
        });
        
        // 拖拽功能
        function drag(simulation) {
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }
            
            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }
            
            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }
            
            return d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended);
        }
    }
    
    // 加载相关文献
    function loadRelatedPapers() {
        const documentId = document.getElementById('documentId').value;
        
        fetch(`/searcher/api/related-papers/${documentId}`)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('relatedPapers');
                
                if (data.error) {
                    container.innerHTML = `<div class="alert alert-warning">获取相关文献失败: ${data.error}</div>`;
                    return;
                }
                
                if (!data.papers || data.papers.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">未找到相关文献</div>';
                    return;
                }
                
                let html = '';
                
                data.papers.forEach(paper => {
                    html += `
                        <div class="paper-card" onclick="viewDocument(${paper.id})">
                            <h3 class="paper-title">${paper.title}</h3>
                            <div class="paper-meta">
                                ${paper.author ? `<span class="me-2"><i class="fas fa-user"></i> ${paper.author}</span>` : ''}
                                ${paper.publish_date ? `<span class="me-2"><i class="fas fa-calendar"></i> ${paper.publish_date}</span>` : ''}
                                ${paper.similarity !== undefined ? `<span><i class="fas fa-link"></i> 相似度: ${(paper.similarity * 100).toFixed(1)}%</span>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            })
            .catch(error => {
                document.getElementById('relatedPapers').innerHTML = 
                    `<div class="alert alert-warning">获取相关文献失败: ${error.message}</div>`;
            });
    }
    
    // 通过关键词搜索
    function searchByKeyword(keyword) {
        window.location.href = `/searcher/search_page?keyword=${encodeURIComponent(keyword)}`;
    }
    
    // 查看文档详情
    function viewDocument(docId) {
        const sessionId = document.getElementById('sessionId').value;
        window.location.href = `/searcher/document/${docId}?session_id=${sessionId}`;
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 加载引用网络数据
        const citationTab = document.getElementById('citation-tab');
        citationTab.addEventListener('shown.bs.tab', function(event) {
            initCitationNetwork();
        });
        
        // 加载相关文献
        const relatedTab = document.getElementById('related-tab');
        relatedTab.addEventListener('shown.bs.tab', function(event) {
            loadRelatedPapers();
        });
    });
</script>
{% endblock %} 