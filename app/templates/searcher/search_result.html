{% extends "base.html" %}

{% block title %}搜索结果 - 文献检索平台{% endblock %}

{% block styles %}
<style>
    .search-header {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }
    
    .search-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .search-info {
        font-size: 1rem;
        color: #495057;
    }
    
    .search-keyword {
        font-weight: bold;
    }
    
    .sort-options {
        display: flex;
        align-items: center;
    }
    
    .sort-options label {
        margin-right: 10px;
        font-weight: 500;
    }
    
    .search-filters {
        background-color: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .filter-section {
        margin-bottom: 1rem;
    }
    
    .filter-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .filter-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .filter-list li {
        margin-bottom: 0.25rem;
    }
    
    .filter-checkbox {
        margin-right: 0.5rem;
    }
    
    /* 搜索结果样式 */
    .search-results {
        margin-top: 1.5rem;
    }
    
    .search-result-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .search-result-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    .result-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }
    
    .result-metadata {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 1rem;
    }
    
    .result-summary {
        color: #444;
        line-height: 1.5;
    }
    
    .meta-item {
        margin-right: 1rem;
        display: inline-block;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 2rem;
    }
    
    .pagination .btn {
        min-width: 2.5rem;
    }
    
    .highlight {
        background-color: #fff3cd;
        padding: 0 2px;
        border-radius: 2px;
    }
    
    .no-results {
        background-color: white;
        padding: 2rem;
        text-align: center;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .back-to-search {
        margin-top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="search-header">
    <div class="search-summary">
        <div class="search-info">
            {% if keyword %}
                关于 <span class="search-keyword">"{{ keyword }}"</span> 的搜索结果
            {% elif query %}
                布尔检索式 <span class="search-keyword">"{{ query }}"</span> 的搜索结果
            {% else %}
                高级检索结果
            {% endif %}
            
            {% if total > 0 %}
                (共 {{ total }} 项，用时 {{ time_cost }} 秒)
            {% endif %}
        </div>
        
        <div class="sort-options">
            <label for="sortSelect">排序：</label>
            <select id="sortSelect" class="form-select" onchange="changeSorting()">
                <option value="relevance" {% if sort_method == 'relevance' %}selected{% endif %}>相关性</option>
                <option value="tf-idf" {% if sort_method == 'tf-idf' %}selected{% endif %}>TF-IDF</option>
                <option value="date" {% if sort_method == 'date' %}selected{% endif %}>发布日期</option>
                <option value="citation" {% if sort_method == 'citation' %}selected{% endif %}>引用次数</option>
            </select>
        </div>
    </div>
    
    <div class="back-to-search">
        <a href="{{ url_for('searcher.search_page') }}" class="btn btn-outline-primary">
            <i class="fas fa-chevron-left"></i> 返回搜索页
        </a>
    </div>
</div>

<div class="row">
    <!-- 筛选器 -->
    <div class="col-md-3">
        <div class="search-filters">
            <h5>筛选结果</h5>
            
            <!-- 发表年份筛选 -->
            <div class="filter-section">
                <div class="filter-title">发表年份</div>
                <ul class="filter-list" id="yearFilters">
                    {% if years %}
                        {% for year, count in years %}
                            <li>
                                <label>
                                    <input type="checkbox" class="filter-checkbox year-filter" 
                                           value="{{ year }}" onchange="applyFilters()">
                                    {{ year }} ({{ count }})
                                </label>
                            </li>
                        {% endfor %}
                    {% else %}
                        <li>无可用筛选</li>
                    {% endif %}
                </ul>
            </div>
            
            <!-- 作者筛选 -->
            <div class="filter-section">
                <div class="filter-title">作者</div>
                <ul class="filter-list" id="authorFilters">
                    {% if authors %}
                        {% for author, count in authors %}
                            <li>
                                <label>
                                    <input type="checkbox" class="filter-checkbox author-filter" 
                                           value="{{ author }}" onchange="applyFilters()">
                                    {{ author }} ({{ count }})
                                </label>
                            </li>
                        {% endfor %}
                    {% else %}
                        <li>无可用筛选</li>
                    {% endif %}
                </ul>
            </div>
            
            <!-- 机构筛选 -->
            <div class="filter-section">
                <div class="filter-title">机构</div>
                <ul class="filter-list" id="institutionFilters">
                    {% if institutions %}
                        {% for institution, count in institutions %}
                            <li>
                                <label>
                                    <input type="checkbox" class="filter-checkbox institution-filter" 
                                           value="{{ institution }}" onchange="applyFilters()">
                                    {{ institution }} ({{ count }})
                                </label>
                            </li>
                        {% endfor %}
                    {% else %}
                        <li>无可用筛选</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
    
    <!-- 搜索结果 -->
    <div class="col-md-9">
        {% if results %}
            <div class="search-results">
                {% for document in results %}
                <div class="search-result-card" onclick="viewDocument('{{ document.id }}')">
                    <h3 class="result-title">{{ document.title | safe }}</h3>
                    <div class="result-metadata">
                        {% if document.author %}
                        <span class="meta-item">
                            <i class="fas fa-user"></i> {{ document.author | safe }}
                        </span>
                        {% endif %}
                        {% if document.publish_date %}
                        <span class="meta-item">
                            <i class="fas fa-calendar"></i> {{ document.publish_date }}
                        </span>
                        {% endif %}
                        {% if document.cited_by_count is defined %}
                        <span class="meta-item">
                            <i class="fas fa-quote-right"></i> 引用次数: {{ document.cited_by_count }}
                        </span>
                        {% endif %}
                    </div>
                    <p class="result-summary">{{ document.content | safe }}</p>
                </div>
                {% endfor %}
            </div>
            
            <!-- 分页区域 -->
            <div class="pagination">
                {% if current_page > 1 %}
                    <button class="btn btn-outline-primary" onclick="goToPage('{{ current_page - 1 }}')">
                        &laquo;
                    </button>
                {% else %}
                    <button class="btn btn-secondary" disabled>
                        &laquo;
                    </button>
                {% endif %}
                
                {% for i in range(1, total_pages + 1) %}
                    {% if i == current_page %}
                        <button class="btn btn-primary">{{ i }}</button>
                    {% else %}
                        <button class="btn btn-outline-primary" onclick="goToPage('{{ i }}')">{{ i }}</button>
                    {% endif %}
                {% endfor %}
                
                {% if current_page < total_pages %}
                    <button class="btn btn-outline-primary" onclick="goToPage('{{ current_page + 1 }}')">
                        &raquo;
                    </button>
                {% else %}
                    <button class="btn btn-secondary" disabled>
                        &raquo;
                    </button>
                {% endif %}
            </div>
        {% else %}
            <div class="no-results">
                <h3>未找到匹配的结果</h3>
                <p>请尝试修改搜索条件或使用不同的关键词。</p>
                <a href="{{ url_for('searcher.search_page') }}" class="btn btn-primary">返回搜索</a>
            </div>
        {% endif %}
    </div>
</div>

<!-- 存储会话信息的隐藏字段 -->
<input type="hidden" id="sessionId" value="{{ session_id }}">
<input type="hidden" id="currentPage" value="{{ current_page }}">
<input type="hidden" id="searchType" value="{{ search_type }}">
<input type="hidden" id="searchQuery" value="{{ search_params | tojson }}">
{% endblock %}

{% block scripts %}
<script>
    // 查看文档详情
    function viewDocument(docId) {
        const sessionId = document.getElementById('sessionId').value;
        window.location.href = `/searcher/document/${docId}?session_id=${sessionId}`;
    }
    
    // 切换排序方式
    function changeSorting() {
        const sortMethod = document.getElementById('sortSelect').value;
        const searchParams = JSON.parse(document.getElementById('searchQuery').value);
        const searchType = document.getElementById('searchType').value;
        const sessionId = document.getElementById('sessionId').value;
        
        // 更新排序方法
        searchParams.sort_method = sortMethod;
        
        let endpoint = '';
        switch (searchType) {
            case 'basic':
                endpoint = '/searcher/search';
                break;
            case 'advanced':
                endpoint = '/searcher/advanced_search';
                break;
            case 'boolean':
                endpoint = '/searcher/boolean_search';
                break;
            default:
                endpoint = '/searcher/search';
        }
        
        // 显示加载中提示
        document.querySelector('.search-results').innerHTML = '<div class="d-flex justify-content-center mt-5"><div class="spinner-border" role="status"><span class="visually-hidden">加载中...</span></div></div><p class="text-center mt-3">正在排序结果，请稍候...</p>';
        
        // 发送排序请求
        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(searchParams)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(`排序失败: ${data.error}`);
                return;
            }
            
            // 重新加载页面
            window.location.href = `/searcher/search_results?session_id=${data.session_id}`;
        })
        .catch(error => {
            alert(`请求失败: ${error.message}`);
        });
    }
    
    // 应用筛选器
    function applyFilters() {
        const yearFilters = Array.from(document.querySelectorAll('.year-filter:checked')).map(cb => cb.value);
        const authorFilters = Array.from(document.querySelectorAll('.author-filter:checked')).map(cb => cb.value);
        const institutionFilters = Array.from(document.querySelectorAll('.institution-filter:checked')).map(cb => cb.value);
        
        const searchParams = JSON.parse(document.getElementById('searchQuery').value);
        const searchType = document.getElementById('searchType').value;
        const sessionId = document.getElementById('sessionId').value;
        
        // 更新筛选条件
        searchParams.filters = {
            years: yearFilters,
            authors: authorFilters,
            institutions: institutionFilters
        };
        
        let endpoint = '';
        switch (searchType) {
            case 'basic':
                endpoint = '/searcher/search';
                break;
            case 'advanced':
                endpoint = '/searcher/advanced_search';
                break;
            case 'boolean':
                endpoint = '/searcher/boolean_search';
                break;
            default:
                endpoint = '/searcher/search';
        }
        
        // 显示加载中提示
        document.querySelector('.search-results').innerHTML = '<div class="d-flex justify-content-center mt-5"><div class="spinner-border" role="status"><span class="visually-hidden">加载中...</span></div></div><p class="text-center mt-3">正在筛选结果，请稍候...</p>';
        
        // 发送筛选请求
        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(searchParams)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(`筛选失败: ${data.error}`);
                return;
            }
            
            // 重新加载页面
            window.location.href = `/searcher/search_results?session_id=${data.session_id}`;
        })
        .catch(error => {
            alert(`请求失败: ${error.message}`);
        });
    }
    
    // 跳转到指定页码
    function goToPage(page) {
        const searchParams = JSON.parse(document.getElementById('searchQuery').value);
        const searchType = document.getElementById('searchType').value;
        
        // 更新页码
        searchParams.page = page;
        
        let endpoint = '';
        switch (searchType) {
            case 'basic':
                endpoint = '/searcher/search';
                break;
            case 'advanced':
                endpoint = '/searcher/advanced_search';
                break;
            case 'boolean':
                endpoint = '/searcher/boolean_search';
                break;
            default:
                endpoint = '/searcher/search';
        }
        
        // 显示加载中提示
        document.querySelector('.search-results').innerHTML = '<div class="d-flex justify-content-center mt-5"><div class="spinner-border" role="status"><span class="visually-hidden">加载中...</span></div></div><p class="text-center mt-3">正在加载页面，请稍候...</p>';
        
        // 发送分页请求
        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(searchParams)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(`分页失败: ${data.error}`);
                return;
            }
            
            // 重新加载页面
            window.location.href = `/searcher/search_results?session_id=${data.session_id}`;
        })
        .catch(error => {
            alert(`请求失败: ${error.message}`);
        });
    }
</script>
{% endblock %}
